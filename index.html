<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Skener za Spar Cijene</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; background-color: #f0f0f0; }
        #reader { width: 100%; max-width: 400px; border: 1px solid black; margin-bottom: 20px;}
        #rezultat { width: 100%; max-width: 600px; background-color: white; padding: 15px; border: 1px solid #ccc; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        button { padding: 10px 20px; font-size: 1em; margin-bottom: 10px; }
        .cijena-label { font-weight: bold; color: #007bff; }
        .price-history-item { border-bottom: 1px dotted #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .price-history-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <h1>Test Skener - Cijene za Spar</h1>
    <p>Skenirajte barkod proizvoda. Aplikacija će pokušati dohvatiti sve dostupne cijene za taj proizvod u Sparu.</p>

    <div id="reader"></div>
    <button id="startStopButton">Pokreni Skener</button>
    
    <h2>Rezultati za Spar:</h2>
    <div id="rezultat">Čekam skeniranje...</div>

    <script>
        const API_BASE_URL = "https://api.cijene.dev";
        const API_KEY = "mee5xooThuithei4ees4bae3emos3ook"; // Tvoj API ključ
        const TARGET_CHAIN_CODE = "spar";

        const readerDiv = document.getElementById('reader');
        const startStopButton = document.getElementById('startStopButton');
        const rezultatDiv = document.getElementById('rezultat');
        let html5QrCode = null;
        let isScannerRunning = false;

        function onScanSuccess(decodedText, decodedResult) {
            rezultatDiv.innerHTML = `Skeniran EAN: <strong>${decodedText}</strong><br>Dohvaćam podatke za Spar...`;
            stopScanner(); // Zaustavi skener nakon uspješnog skeniranja
            dohvatiCijeneZaSpar(decodedText);
        }

        function onScanFailure(error) {
            // Može se ignorirati
        }

              async function dohvatiCijeneZaSpar(ean) {
            try {
                const response = await fetch(`${API_BASE_URL}/v1/products/${ean}/?chains=${TARGET_CHAIN_CODE}`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });

                if (!response.ok) {
                    let errorMsg = `Greška ${response.status}: ${response.statusText}`;
                    if (response.status === 404) {
                        errorMsg = `Proizvod s EAN ${ean} nije pronađen u Sparu.`;
                    } else {
                        try { const errData = await response.json(); errorMsg += ` - ${errData.detail || JSON.stringify(errData)}`; } catch (e) {}
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                
                if (data.chains && data.chains.length > 0) {
                    const sparData = data.chains[0];
                    let htmlRezultat = `<h3>Podaci za proizvod: ${sparData.name || data.name || 'N/A'} (EAN: ${ean}) u Sparu</h3>`;
                    
                    // Provjera prije .toFixed()
                    htmlRezultat += `<p><span class="cijena-label">Minimalna cijena (min_price):</span> ${sparData.min_price !== null && sparData.min_price !== undefined ? parseFloat(sparData.min_price).toFixed(2) + ' EUR' : 'N/A'}</p>`;
                    htmlRezultat += `<p><span class="cijena-label">Maksimalna cijena (max_price):</span> ${sparData.max_price !== null && sparData.max_price !== undefined ? parseFloat(sparData.max_price).toFixed(2) + ' EUR' : 'N/A'}</p>`;
                    htmlRezultat += `<p><span class="cijena-label">Prosječna cijena (avg_price):</span> ${sparData.avg_price !== null && sparData.avg_price !== undefined ? parseFloat(sparData.avg_price).toFixed(2) + ' EUR' : 'N/A'}</p>`;
                    
                    htmlRezultat += `<p><span class="cijena-label">Količina pakiranja:</span> ${sparData.quantity || 'N/A'} ${sparData.unit || ''}</p>`;
                    htmlRezultat += `<p><span class="cijena-label">Kategorija:</span> ${sparData.category || data.category || 'N/A'}</p>`;
                    htmlRezultat += `<p><span class="cijena-label">Brand:</span> ${sparData.brand || data.brand || 'N/A'}</p>`;

                    if (sparData.price_history && sparData.price_history.length > 0) {
                        htmlRezultat += `<h4>Povijest cijena (price_history):</h4>`;
                        sparData.price_history.forEach(entry => {
                            // Provjera i za cijene u povijesti
                            htmlRezultat += `<div class="price-history-item">Datum: ${entry.date}, Cijena: ${entry.price !== null && entry.price !== undefined ? parseFloat(entry.price).toFixed(2) + ' EUR' : 'N/A'}</div>`;
                        });
                    } else {
                        htmlRezultat += `<p>Nema dostupne povijesti cijena.</p>`;
                    }
                    htmlRezultat += `<hr><h4>Sirovi podaci za Spar (chain[0]):</h4><pre>${JSON.stringify(sparData, null, 2)}</pre>`;
                    htmlRezultat += `<hr><h4>Sirovi globalni podaci o proizvodu:</h4><pre>${JSON.stringify({ean: data.ean, name: data.name, category: data.category, brand: data.brand}, null, 2)}</pre>`;

                    rezultatDiv.innerHTML = htmlRezultat;
                } else {
                    rezultatDiv.textContent = `Proizvod s EAN ${ean} nema podataka za Spar. Provjerite je li chain_code "spar" točan.`;
                }

            } catch (error) {
                console.error("Greška pri dohvaćanju cijena:", error);
                rezultatDiv.textContent = `Greška: ${error.message}`;
            }
        }

        function startScanner() {
            if (isScannerRunning || !html5QrCode) return;
            rezultatDiv.textContent = "Pokretanje kamere...";
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 100 } },
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScannerRunning = true;
                startStopButton.textContent = "Zaustavi Skener";
                rezultatDiv.textContent = "Kamera aktivna. Skenirajte barkod.";
            }).catch(err => {
                rezultatDiv.textContent = "Greška pri pokretanju kamere: " + err;
                isScannerRunning = false;
            });
        }

        async function stopScanner() {
            if (!isScannerRunning || !html5QrCode) return;
            try {
                await html5QrCode.stop();
                isScannerRunning = false;
                startStopButton.textContent = "Pokreni Skener";
                // rezultatDiv.textContent = "Skener zaustavljen."; // Ne želimo prebrisati rezultat
                readerDiv.innerHTML = ""; // Očisti video prikaz
            } catch (err) {
                console.error("Greška pri zaustavljanju skenera:", err);
                rezultatDiv.textContent = "Greška pri zaustavljanju skenera.";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            html5QrCode = new Html5Qrcode("reader");
            startStopButton.addEventListener('click', () => {
                if (isScannerRunning) {
                    stopScanner();
                } else {
                    startScanner();
                }
            });
        });
    </script>
</body>
</html>
