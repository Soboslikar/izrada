<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osnovni EAN Skener</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 20px; 
            background-color: #f9f9f9;
        }
        #reader {
            width: 100%;
            max-width: 450px; /* Malo uže za 1D barkodove */
            height: 200px;    /* Pravokutniji oblik, bolje za EAN */
            border: 2px solid #ccc;
            background-color: #e0e0e0;
            margin-bottom: 20px;
            overflow: hidden; /* Da video ne curi */
        }
        /* Osigurava da video popuni reader div */
        #reader video, 
        #reader > div > video { /* Ponekad biblioteka doda još jedan div */
            width: 100% !important;
            height: 100% !important;
            object-fit: cover; 
        }
        button {
            padding: 12px 25px;
            font-size: 1em;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            min-width: 180px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #scanResult {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 280px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            word-break: break-all; /* Za duge kodove */
        }
        .messages {
            text-align: center;
            margin-bottom: 10px;
            min-height: 1.2em; /* Da ne skače layout */
        }
        .status { color: #007bff; }
        .error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Osnovni EAN Skener</h1>
    
    <div id="reader"></div>
    
    <div class="messages">
        <p id="statusText" class="status">Kliknite "Pokreni Skener"</p>
        <p id="errorText" class="error"></p>
    </div>
    
    <button id="startStopButton">Pokreni Skener</button>
    
    <div id="scanResultContainer">
        <div id="scanResult">Skenirani kod: Još nema</div>
    </div>

    <script>
        const readerDiv = document.getElementById('reader');
        const startStopButton = document.getElementById('startStopButton');
        const scanResultDiv = document.getElementById('scanResult');
        const statusTextElem = document.getElementById('statusText');
        const errorTextElem = document.getElementById('errorText');

        let html5QrCode = null; // Instanca skenera
        let isScannerRunning = false;

        function clearMessages() {
            statusTextElem.textContent = '';
            errorTextElem.textContent = '';
        }

        // Poziva se pri uspješnom skeniranju
        function onScanSuccess(decodedText, decodedResult) {
            clearMessages();
            console.log(`Skeniran kod: ${decodedText}`, decodedResult);
            scanResultDiv.textContent = `Skenirani kod: ${decodedText}`;

            if (decodedResult.result && decodedResult.result.format && decodedResult.result.format.formatName === "EAN_13") {
                statusTextElem.textContent = "✔️ EAN-13 kod pronađen!";
            } else if (decodedResult.result && decodedResult.result.format) {
                statusTextElem.textContent = `✔️ Format: ${decodedResult.result.format.formatName}`;
            } else {
                statusTextElem.textContent = "✔️ Kod pronađen!";
            }

            // Možeš odkomentirati da zaustaviš skener nakon prvog uspješnog skena
            // stopScanner(); 
        }

        // Poziva se ako skeniranje ne uspije (npr. kamera ne može dekodirati)
        function onScanFailure(error) {
            // Ovo se poziva često, pa nećemo stalno ispisivati grešku korisniku
            // console.warn(`Greška skeniranja: ${error}`);
        }

        // Funkcija za pokretanje skenera
        async function startScanner() {
            if (isScannerRunning) return;

            clearMessages();
            statusTextElem.textContent = "Inicijalizacija skenera...";
            readerDiv.innerHTML = ""; // Očisti prethodni sadržaj ako postoji

            // Stvori novu instancu Html5Qrcode
            // Parametar "reader" je ID div elementa gdje će se prikazati video stream
            html5QrCode = new Html5Qrcode("reader");

            // Konfiguracija skenera
            const config = {
                fps: 10, // Preporučeno za mobilne uređaje
                qrbox: (viewfinderWidth, viewfinderHeight) => {
                    // Ciljamo pravokutnik koji je širi nego viši, za EAN barkodove
                    let widthPercentage = 0.85; // 85% širine viewfindera
                    let heightToWidthRatio = 0.4; // Visina je 40% širine qrboxa

                    let qrboxWidth = Math.floor(viewfinderWidth * widthPercentage);
                    let qrboxHeight = Math.floor(qrboxWidth * heightToWidthRatio);

                    // Minimalne dimenzije
                    qrboxWidth = Math.max(250, qrboxWidth);
                    qrboxHeight = Math.max(100, qrboxHeight);
                    
                    // Osiguraj da ne prelazi dimenzije
                    qrboxWidth = Math.min(viewfinderWidth - 40, qrboxWidth);
                    qrboxHeight = Math.min(viewfinderHeight - 40, qrboxHeight);
                    
                    console.log(`Viewfinder: ${viewfinderWidth}x${viewfinderHeight}, QRBox: ${qrboxWidth}x${qrboxHeight}`);
                    return { width: qrboxWidth, height: qrboxHeight };
                },
                rememberLastUsedCamera: true, // Pokušaj koristiti zadnju kameru
                // aspectRatio: 16/9, // Može pomoći za neke kamere
            };

            try {
                statusTextElem.textContent = "Pokretanje kamere...";
                // Pokreni skeniranje. Preferiraj stražnju kameru ("environment")
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                isScannerRunning = true;
                startStopButton.textContent = "Zaustavi Skener";
                scanResultDiv.textContent = "Skenirani kod: Čekam...";
                statusTextElem.textContent = "Kamera aktivna. Skenirajte barkod.";
            } catch (err) {
                console.error("Greška pri pokretanju kamere: ", err);
                isScannerRunning = false;
                startStopButton.textContent = "Pokreni Skener";
                statusTextElem.textContent = "Greška pri pokretanju kamere.";
                errorTextElem.textContent = `Problem: ${err.name || err.message || err}`;
                if (html5QrCode && html5QrCode.clear) { // Očisti ako je instanca stvorena
                  html5QrCode.clear().catch(clearErr => console.error("Greška pri čišćenju skenera:", clearErr));
                }
                html5QrCode = null; // Resetiraj instancu za novi pokušaj
            }
        }

        // Funkcija za zaustavljanje skenera
        async function stopScanner() {
            if (!isScannerRunning || !html5QrCode) return;

            clearMessages();
            statusTextElem.textContent = "Zaustavljanje skenera...";

            try {
                await html5QrCode.stop();
                console.log("Skener zaustavljen.");
                isScannerRunning = false;
                startStopButton.textContent = "Pokreni Skener";
                statusTextElem.textContent = "Skener zaustavljen. Kliknite 'Pokreni Skener'.";
                readerDiv.innerHTML = ""; // Ukloni video element
            } catch (err) {
                console.error("Greška pri zaustavljanju skenera: ", err);
                statusTextElem.textContent = "Greška pri zaustavljanju skenera.";
                errorTextElem.textContent = `Problem: ${err.name || err.message || err}`;
                // Iako je došlo do greške, smatramo da skener više nije aktivan
                isScannerRunning = false; 
                startStopButton.textContent = "Pokreni Skener";
            }
        }

        // Event listener za gumb
        startStopButton.addEventListener('click', () => {
            if (isScannerRunning) {
                stopScanner();
            } else {
                startScanner();
            }
        });

        // Inicijalizacija kad je DOM spreman
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Aplikacija spremna. Čeka se klik na gumb.");
        });
    </script>
</body>
</html>
