<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR RAƒåUNATOR</title>
  <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
  <meta property="og:title" content="QR RAƒåUNATOR" />
  <meta property="og:description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu."/>
  <meta name="description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu.">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://soboslikar.github.io/QR-RACUNATOR/" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* CSS (Verzija s OGLASIMA) */
    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }
    
    /* --- KONTROLA PRIKAZA (VIEW CONTROL) --- */
    body.scanner-view #history-page,
    body.scanner-view #oglasi-page { display: none; }

    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,
    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay,
    body.history-view #manual-entry-modal-overlay,
    body.history-view #oglasi-page { display: none !important; }

    body.oglasi-view #header, body.oglasi-view #scan-instruction, body.oglasi-view #reader, body.oglasi-view #loaded-message, body.oglasi-view #duplicate-warning, body.oglasi-view #total-container, body.oglasi-view #session-name-container, body.oglasi-view #invoice-count, body.oglasi-view #history, body.oglasi-view #remove-from-list-btn, body.oglasi-view #history-toggle-btn, body.oglasi-view #share-button, body.oglasi-view #delete-warning, body.oglasi-view #running-text-container, body.oglasi-view #share-prompt-overlay, body.oglasi-view #counter-deactivated-indicator,
    body.oglasi-view #switch-camera-btn, body.oglasi-view #camera-selection-overlay,
    body.oglasi-view #manual-entry-modal-overlay,
    body.oglasi-view #history-page { display: none !important; }
    
    body.history-view, body.oglasi-view { background-color: white; }

    /* --- LAYOUT STRANICA POVIJESTI I OGLASA --- */
    #history-page, #oglasi-page {
        display: flex;
        flex-direction: column;
        padding: 0;
        min-height: calc(100vh - 1em);
        max-height: calc(100vh - 1em);
        box-sizing: border-box;
        overflow: hidden;
    }
    #history-content, #oglasi-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1em;
        position: relative;
    }

    /* --- SKENER VIEW ELEMENTI --- */
    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }
    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }
    #total-container { position: fixed; top: 23.5em; left: 49%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; min-height: 48px; }
    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }
    #ocisti-button.confirm-mode { background-color: yellow; color: black; }
    #session-name-container { position: fixed; top: 27.5em; left: 50%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; width: 95%; max-width: 400px; justify-content: space-between; min-height: 35px; text-align: center; margin-top: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; gap: 15px; }
    #session-name-wrapper { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; flex-shrink: 0; font-weight: bold; white-space: nowrap; }
    #session-name-input { font-size: 1.2em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 4px; width: 100%; display: none; box-sizing: border-box; flex-grow: 1; }
    #session-name-display { font-size: 1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; flex-grow: 1; min-width: 50px; text-align: left; box-sizing: border-box; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; flex-shrink: 0; }
    #manual-entry-btn { background-color: orange; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; line-height: 1.3; flex-shrink: 0; min-width: 90px; white-space: nowrap; margin-right: 5px; }
    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }
    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    .red-btn { background: #ff0000; color: yellow; }
    .yellow-btn { background-color: yellow; color: black; }
    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }
    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }
    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }
    #share-button:active { animation: none; }
    
    /* --- PRIVREMENE PORUKE I UPOZORENJA --- */
    #duplicate-warning, #loaded-message, #delete-warning, #share-prompt-overlay { position: fixed; z-index: 10; }
    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; top: 12.8em; left: 50%; transform: translateX(-50%); display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,4,8,0.2); }
    #delete-warning { font-weight: bold; display: none; text-align: center; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }
    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }
    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); }
    #share-prompt-overlay { top: 7em; left: 50%; transform: translateX(-50%); width: 60%; background-color: rgba(0, 0, 0, 0.75); color: lightgreen; font-size: 1.3em; font-weight: bold; text-align: center; padding: 1.5em 1em; border-radius: 10px; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.3); line-height: 1.4; align-items: center; justify-content: center; }
    #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    
    /* --- TRƒåEƒÜI TEKST --- */
    #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }
    #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 25s linear infinite; white-space: pre; }
    
    /* --- ODABIR KAMERE --- */
    #switch-camera-btn { position: fixed; top: 10px; right: 10px; z-index: 5; padding: 6px 8px; background-color: #007bff; color: white; border: none; border-radius: 50%; font-size: 1.4em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; }
    #switch-camera-btn:active { background-color: rgba(0, 0, 0, 0.7); }
    #camera-selection-overlay { position: fixed; top: 55px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 6; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 150px; }
    #camera-list { list-style: none; padding: 0; margin: 0; }
    #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #camera-list li:hover { background-color: #f0f0f0; }
    #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }

    /* --- RUƒåNI UNOS MODAL --- */
    #manual-entry-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
    #manual-entry-modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-width: 90%; width: 300px; text-align: center; }
    #manual-entry-modal-content input[type="text"] { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
    #manual-entry-modal-content label { display: block; margin-bottom: 5px; font-weight: bold; text-align: left; }
    #manual-entry-modal-content div { margin-bottom: 15px; text-align: left; }
    #manual-entry-modal-content div:last-child { margin-bottom: 0; text-align: center; }
    #manual-entry-modal-content button { padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; }
    #manual-entry-modal-content button#manual-add-btn { background-color: green; color: white; }
    #manual-entry-modal-content button#manual-cancel-btn { background-color: #dc3545; color: white; }
    #manual-entry-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }
    #import-file-input { display: none; }

    /* --- POVIJEST VIEW --- */
    #history-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    #history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em; }
    #history-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #back-to-scanner-btn:active { background-color: darkgreen; }
    #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
    #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }
    .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }
    .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
    .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }
    #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }
    #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}
    #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }
    #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container, #search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }
    #detail-header-info, #detail-summary-info { border-top: none; }

    /* --- NOVO: OGLASI VIEW --- */
    #oglasi-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; }
    #oglasi-sticky-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-from-oglasi-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #majstor-ponuda-btn {
        background-color: #007bff; /* Plava pozadina */
        color: white;
        font-size: 1.4em;
        font-weight: bold;
        padding: 0.4em 1em;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        animation: pulse-majstor 2.5s infinite ease-in-out;
        display: none; /* Poƒçetno skriven */
    }
    .oglas-card {
        display: flex;
        gap: 15px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 1em;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .oglas-slika-container {
        flex-shrink: 0;
    }
    .oglas-slika {
        width: 80px;
        height: 80px;
        border-radius: 50%; /* Okrugla slika */
        object-fit: cover; /* Osigurava da slika lijepo popuni krug */
        border: 2px solid #ccc;
    }
    .oglas-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0; /* Va≈æno za flex da bi text-overflow radio */
    }
    .oglas-naziv {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin: 0 0 4px 0;
    }
    .oglas-djelatnost {
        font-size: 1em;
        font-style: italic;
        color: #555;
        margin: 0 0 8px 0;
    }
    .oglas-kontakt {
        font-size: 1.1em;
        font-weight: bold;
        color: #0056b3;
        margin: 0 0 8px 0;
        word-break: break-all; /* Ako je kontakt predug */
    }
    .oglas-text {
        font-size: 0.9em;
        color: #666;
        margin: 0;
        line-height: 1.4;
    }
    
    /* --- ANIMACIJE --- */
    @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    @keyframes pulse-majstor { 0% { transform: scale(1); box-shadow: 0 0 5px rgba(0,123,255,0.5); } 50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(0,123,255,0.8); } 100% { transform: scale(1); box-shadow: 0 0 5px rgba(0,123,255,0.5); } }

  </style>
</head>
<body class="scanner-view">

  <div id="counter-deactivated-indicator" style="display: none;">‚úî</div>
  <div id="header">QR Skener-Kalkulator</div>
  <div id="scan-instruction">Pozicioniraj qr kod unutar kvadrata kamere</div>
  <div id="running-text-container" style="display: none;"><span></span></div>
  <div id="share-prompt-overlay" style="display: none;">KLIKNI ZELENI GUMB<br>I PODIJELI RAƒåUNATOR<br>PORUKA ƒÜE NESTATI</div>

  <div id="reader"></div>

  <button id="switch-camera-btn" style="display: none;">üîÑ</button>
  <div id="camera-selection-overlay" style="display: none;"><ul id="camera-list"></ul></div>

  <div id="loaded-message" style="display: none;">UƒåITANO</div>
  <div id="duplicate-warning" style="display: none;">TAJ RAƒåUN JE URAƒåUNAT</div>

  <div id="total-container">
      <div id="total">UKUPNO: 0.00 ‚Ç¨</div>
      <!-- NOVO: Gumb za oglase ƒáe biti ovdje -->
      <button id="majstor-ponuda-btn" style="display: none;"></button>
      <button id="ocisti-button" onclick="startOcistiConfirm()" style="display: none;">SPREMI<br>I OƒåISTI</button>
  </div>

  <div id="session-name-container">
      <div id="session-name-wrapper">
          <button id="add-name-btn" onclick="startAddName()">DODAJ NAZIV</button>
          <input type="text" id="session-name-input" placeholder="Unesi naziv sesije..." maxlength="30">
          <span id="session-name-display">
              <span id="session-name-text"></span>
              <span class="edit-icon" onclick="startAddName()">Uredi</span>
          </span>
      </div>
      <button id="manual-entry-btn">SAM UPI≈†I RAƒå:</button>
  </div>

  <div id="invoice-count">0 RAƒåUNA</div>
  <div id="history" style="display: none;"> <ul id="historyList"></ul> </div>
  <button class="red-btn" id="remove-from-list-btn" onclick="startRemoveFromList()" style="display:none;">Obri≈°i iz liste</button>
  <button id="history-toggle-btn">POVIJEST</button>
  <button id="share-button" style="display: none;">DIJELI RAƒåUNATOR</button>
  <div id="delete-warning" style="display: none;"></div>

  <!-- STRANICA ZA POVIJEST -->
  <div id="history-page">
      <div id="history-sticky-header">
          <div id="history-header"> <button id="back-to-scanner-btn">< NA SKENER</button> <h1>POVIJEST</h1> </div>
          <div id="history-dynamic-header-content"></div>
      </div>
      <div id="history-content"></div>
  </div>

  <!-- NOVO: STRANICA ZA OGLASE -->
  <div id="oglasi-page">
      <div id="oglasi-sticky-header">
          <button id="back-to-scanner-from-oglasi-btn">< NA SKENER</button>
          <h1>Preporuƒçeni Majstori</h1>
      </div>
      <div id="oglasi-content">
          <div id="oglasi-list-container">
              <!-- Ovdje ƒáe JavaScript dinamiƒçki ubaciti oglase -->
          </div>
      </div>
  </div>

  <!-- MODAL ZA RUƒåNI UNOS -->
  <div id="manual-entry-modal-overlay" style="display: none;">
      <div id="manual-entry-modal-content">
          <h3 style="margin-top: 0; color: #333;">Ruƒçni unos raƒçuna</h3>
          <div>
              <label for="manual-amount-input">Iznos (‚Ç¨):</label>
              <input type="text" id="manual-amount-input" placeholder="npr. 15,99 ili 25.00">
          </div>
          <div>
              <label for="manual-time-input">Vrijeme (HH:MM - opcionalno):</label>
              <input type="text" id="manual-time-input" placeholder="npr. 14:35" pattern="^([0-1]?\d|2[0-3]):([0-5]?\d)$">
          </div>
          <div style="display: flex; justify-content: space-around; gap: 10px;">
              <button id="manual-add-btn">Dodaj raƒçun</button>
              <button id="manual-cancel-btn">Odustani</button>
          </div>
           <p id="manual-entry-error" style="display: none;"></p>
      </div>
  </div>

  <input type="file" id="import-file-input" accept=".json">

  <audio id="scan-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/novo2.mp3" preload="auto"></audio>
  <audio id="click-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/click8.mp3" preload="auto"></audio>
  <audio id="remove-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/smeƒçe.mp3" preload="auto"></audio>
  <audio id="error-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/error.mp3" preload="auto"></audio>
  <audio id="clear-session-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/ƒåi≈°ƒçenje.mp3" preload="auto"></audio>

<script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';
    const COUNTER_KEY = 'qrCalculatorCounter';
    const COUNTER2_KEY = 'qrCalculatorCounter2';
    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMqcnA/exec';
    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID';
    const USER_ID_KEY = 'qrCalculatorUserID';
    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';
    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';
    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';

    const SECONDS_PER_CHARACTER = 0.2;
    const MIN_MARQUEE_DURATION = 5;
    const MAX_MARQUEE_DURATION = 40;

    let ukupno = 0;
    let povijest = [];
    let removeConfirm = false;
    let ocistiConfirm = false;
    const removeBtnInitialText = 'Obri≈°i iz liste';
    const ocistiBtnInitialText = 'SPREMI<br>I OƒåISTI';
    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';
    let html5QrCodeInstance = null;
    let isScannerActive = false;
    let availableCameras = [];
    let visibilityListenerAttached = false;
    let currentSessionName = null;
    let removeNameConfirm = false;
    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
    let previousHistoryViewState = 'day-view';
    let lastSearchTerm = '';
    let brojac = 0;
    let brojac2 = 0;
    let tekstPoruka = "";
    let isCounterDecrementActive = true;
    let currentUserID = null;
    let firstUseTimestamp = null;
    
    // *** NOVO: VARIJABLE ZA OGLASE ***
    let oglasiAktivni = false;
    let gumbTekstOglasa = "";
    let listaOglasa = [];

    // DOM Elementi
    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;
    let switchCameraButton, cameraSelectionOverlay, cameraListUl;
    let manualEntryBtn, manualEntryModalOverlay, manualAmountInput, manualTimeInput, manualAddBtn, manualCancelBtn, manualEntryErrorMsg;
    let importFileInput;
    
    // *** NOVO: DOM ELEMENTI ZA OGLASE ***
    let majstorPonudaBtn, oglasiPage, backToScannerFromOglasiBtn, oglasiListContainer;

    // Varijable za kontrolu zvukova i poruka
    let errorSoundCooldown = false;
    let ignoreErrorSoundUntil = 0;
    let messageTimeoutId = null;
    let ignoreDuplicateLogUntil = 0;
    const DUPLICATE_LOG_COOLDOWN = 5000;


    // *** POMOƒÜNE FUNKCIJE ***
    const parseTime = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1; return hours * 60 + minutes; };
    function normalizeDateForSearch(input) { if (!input || typeof input !== 'string') { return null; } const term = input.trim(); const isoMatch = term.match(/^(\d{4})-(\d{2})-(\d{2})$/); if (isoMatch) { const year = parseInt(isoMatch[1], 10); const month = parseInt(isoMatch[2], 10) - 1; const day = parseInt(isoMatch[3], 10); const date = new Date(year, month, day); if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) { return getISODateString(date); } } const dotSlashMatch = term.match(/^(\d{1,2})[.\/](\d{1,2})[.\/]((\d{4})|(\d{2}))$/); if (dotSlashMatch) { const day = parseInt(dotSlashMatch[1], 10); const month = parseInt(dotSlashMatch[2], 10) - 1; let year = parseInt(dotSlashMatch[4] || dotSlashMatch[5], 10); if (year < 100) { year += 2000; } const date = new Date(year, month, day); if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day && !isNaN(date.getTime())) { return getISODateString(date); } } return null; }
    function playSound(id) { if (id === 'error-sound') { if (errorSoundCooldown) { return; } errorSoundCooldown = true; setTimeout(() => { errorSoundCooldown = false; }, 500); } const sound = document.getElementById(id); if (sound) { sound.pause(); sound.currentTime = 0; sound.play().catch(error => { if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') { console.warn(`Zvuk "${id}" gre≈°ka:`, error); } }); } else { console.warn(`Audio element "${id}" nije pronaƒëen.`); } }
    function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error("getISODateString primio neispravan datum:", date); return null; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
    function showTemporaryMessage(messageElement, messageText, duration = 1500) { if (!messageElement) return; if (messageTimeoutId) { clearTimeout(messageTimeoutId); messageTimeoutId = null; } messageElement.innerText = messageText; messageElement.style.display = 'block'; messageElement.style.animation = 'none'; requestAnimationFrame(() => { messageElement.offsetHeight; if (messageElement.id === 'loaded-message') { messageElement.style.animation = 'zoomFade 1s ease-out'; } }); messageTimeoutId = setTimeout(() => { if (messageElement && messageElement.innerText === messageText) { messageElement.style.display = 'none'; messageTimeoutId = null; } }, duration); }
    function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    function initializeUserTracking() { currentUserID = localStorage.getItem(USER_ID_KEY); firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY); if (!currentUserID) { console.log("Generiram novi UserID i FirstUseTimestamp."); currentUserID = generateUUID(); firstUseTimestamp = new Date().toISOString(); try { localStorage.setItem(USER_ID_KEY, currentUserID); localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp); } catch (error) { console.error("Gre≈°ka spremanja UserID/FirstUse u localStorage:", error); currentUserID = 'localStorage_error_' + generateUUID(); firstUseTimestamp = new Date().toISOString(); } } console.log("UserID:", currentUserID, "FirstUse:", firstUseTimestamp); }
    async function sendLogData(eventData) { if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) { console.warn("Logovanje onemoguƒáeno: APPS_SCRIPT_URL nije postavljen ili je neispravan."); return; } const dataToSend = { ...eventData, UserID: currentUserID, FirstUseTimestamp: firstUseTimestamp, Timestamp: new Date().toISOString(), Counter1: brojac, Counter2: brojac2, Active: isCounterDecrementActive, UserAgent: navigator.userAgent }; console.log(`Poku≈°avam poslati log '${dataToSend.Event}'...`); try { await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: {'Content-Type': 'application/json'}, redirect: 'follow', body: JSON.stringify(dataToSend) }); console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors).`); } catch (error) { console.error(`Gre≈°ka prilikom slanja loga '${dataToSend.Event}':`, error); } }

    // *** FUNKCIJE ZA LOKALNU POHRANU ***
    function saveFullHistoryToLocalStorage(fullHistory) { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory)); } catch (error) { console.error("Gre≈°ka spremanja:", error); alert("Gre≈°ka: Nije moguƒáe spremiti povijest."); } }
    function loadFullHistoryFromLocalStorage() { try { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); if (historyJson) { const loadedHistory = JSON.parse(historyJson); return loadedHistory.map(group => ({ timestamp: group.timestamp || Date.now(), lastQrTime: group.lastQrTime || '??:??', name: group.name || null, racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({ ...item, scanTimestamp: item.scanTimestamp || 0 })) : [] })); } return []; } catch (error) { console.error("Gre≈°ka uƒçitavanja:", error); return []; } }
    function loadCountersState() { const storedBrojac = localStorage.getItem(COUNTER_KEY); const storedBrojac2 = localStorage.getItem(COUNTER2_KEY); const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY); brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 0) : 0; isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; if (isNaN(brojac)) brojac = null; if (isNaN(brojac2)) brojac2 = 0; updateDeactivatedIndicator(); }
    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }
    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }
    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }

    // *** FUNKCIJE ZA DOHVAƒÜANJE PODATAKA IZ SHEETA ***
    async function fetchSheetData() {
        console.log("Poku≈°avam dohvatiti podatke iz Google Sheeta...");
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) {
            console.warn("Dohvaƒáanje iz Sheeta onemoguƒáeno: APPS_SCRIPT_URL nije postavljen ili je neispravan.");
            tekstPoruka = "";
            initializeCounters();
            return Promise.reject(new Error("URL za Sheet nije postavljen/ispravan"));
        }
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) { throw new Error(`HTTP gre≈°ka ${response.status}`); }
            const data = await response.json();
            console.log("Podaci dohvaƒáeni:", data);
            
            // Postojeƒái podaci
            let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 0;
            if (isNaN(newPrag) || newPrag < 0) { newPrag = 0; } else if (newPrag > 500) { newPrag = 500; }
            brojac2 = newPrag;
            saveBrojac2();
            tekstPoruka = data.trceciTekst || "";
            
            // *** NOVO: Spremanje podataka o oglasima ***
            oglasiAktivni = data.oglasiAktivni || false;
            gumbTekstOglasa = data.gumbTekst || "TREBA≈† MAJSTORA?";
            listaOglasa = Array.isArray(data.oglasi) ? data.oglasi : [];

            initializeCounters(); // Ovo poziva checkSharePrompt i updateRunningTextVisibility
            updateOglasiButtonVisibility(); // A≈æuriraj prikaz gumba za oglase

            return Promise.resolve();
        } catch (error) {
            console.error("Gre≈°ka pri dohvaƒáanju podataka iz Sheeta:", error);
            tekstPoruka = "";
            oglasiAktivni = false; // Iskljuƒçi oglase u sluƒçaju gre≈°ke
            initializeCounters();
            updateOglasiButtonVisibility();
            return Promise.reject(error);
        }
    }

    // *** INICIJALIZACIJA BROJAƒåA ***
    function initializeCounters() { if (brojac === null) { brojac = brojac2; saveBrojac(); } checkSharePrompt(); updateRunningTextVisibility(); }

    // *** FUNKCIJE ZA A≈ΩURIRANJE PRIKAZA ***
    function checkOcistiButtonVisibility() { if (!ocistiButton) return; ocistiButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if ((povijest.length === 0 && !currentSessionName) && ocistiConfirm) { resetOcistiMode(); } }
    function updateDisplay() { if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} ‚Ç¨`; const count = povijest.length; if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAƒåUN' : 'RAƒåUNA'}`; if (document.body.classList.contains('scanner-view')) { updateSmallHistoryList(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); checkOcistiButtonVisibility(); updateNameDisplay(); updateOglasiButtonVisibility(); } };
    function updateSmallHistoryList() { if (!historyList || !historyDiv) return; if (povijest.length > 0) { historyDiv.style.display = 'block'; historyList.innerHTML = ''; const recentHistory = povijest; recentHistory.forEach((item, index) => { const globalIndex = povijest.length - recentHistory.length + index; const listItem = document.createElement('li'); listItem.innerText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} ‚Ç¨`; historyList.appendChild(listItem); }); historyDiv.scrollTop = historyDiv.scrollHeight; } else { historyDiv.style.display = 'none'; } }
    function checkRemoveButtonVisibility() { if (!removeButton) return; removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if (povijest.length === 0 && !currentSessionName && (removeConfirm || removeNameConfirm)) resetRemoveMode(); }
    function handleInfoDeleteMessageVisibility() { const isScannerView = document.body.classList.contains('scanner-view'); if (!deleteWarningDiv || !isScannerView) { if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; return; } let shouldDisplay = false, textToShow = '', modeClass = ''; if (removeConfirm && povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; textToShow = `OBRI≈†I ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (removeNameConfirm && currentSessionName) { textToShow = `OBRI≈†I NAZIV "${currentSessionName}"?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) { textToShow = deleteWarningDiv.dataset.lastScanText; modeClass = 'info-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length === 0 && currentSessionName && deleteWarningDiv.dataset.lastNameText) { textToShow = deleteWarningDiv.dataset.lastNameText; modeClass = 'info-mode'; shouldDisplay = true; } if (shouldDisplay) { deleteWarningDiv.innerText = textToShow; deleteWarningDiv.className = `delete-warning ${modeClass}`; deleteWarningDiv.style.display = 'block'; } else { deleteWarningDiv.style.display = 'none'; } }
    function updateRunningText() { if (runningTextSpan) { runningTextSpan.textContent = tekstPoruka; if (tekstPoruka && tekstPoruka.length > 0) { const textLength = tekstPoruka.length; let duration = textLength * SECONDS_PER_CHARACTER; duration = Math.max(MIN_MARQUEE_DURATION, Math.min(MAX_MARQUEE_DURATION, duration)); duration = Math.max(duration, 0.1); runningTextSpan.style.animation = 'none'; requestAnimationFrame(() => { runningTextSpan.offsetHeight; runningTextSpan.style.animation = `marquee ${duration}s linear infinite`; }); } else { runningTextSpan.style.animation = 'none'; } } updateRunningTextVisibility(); }
    function updateRunningTextVisibility() { const isModalOpen = (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') || document.body.classList.contains('oglasi-view'); const shouldShowText = tekstPoruka && (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && !isModalOpen && document.body.classList.contains('scanner-view'); if (runningTextContainer) { runningTextContainer.style.display = shouldShowText ? 'block' : 'none'; } }
    function checkSharePrompt() { const isModalOpen = (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') || document.body.classList.contains('oglasi-view'); const shouldShowPrompt = brojac === 0 && brojac2 > 0 && !isModalOpen && document.body.classList.contains('scanner-view'); if (sharePromptOverlay) { sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none'; updateRunningTextVisibility(); } }
    function updateDeactivatedIndicator() { const isModalOpen = (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') || document.body.classList.contains('oglasi-view'); if (counterDeactivatedIndicator) { counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view') && !isModalOpen) ? 'block' : 'none'; } }

    // *** NOVO: FUNKCIJA ZA PRIKAZ GUMBA ZA OGLASE ***
    function updateOglasiButtonVisibility() {
        if (!majstorPonudaBtn || !totalDiv) return;
        
        // Uvjet: Oglasi su aktivirani u sheetu I trenutna sesija je prazna
        const shouldShow = oglasiAktivni && povijest.length === 0;

        if (shouldShow) {
            majstorPonudaBtn.textContent = gumbTekstOglasa;
            majstorPonudaBtn.style.display = 'block';
            totalDiv.style.display = 'none';
        } else {
            majstorPonudaBtn.style.display = 'none';
            totalDiv.style.display = 'block';
        }
    }

    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA ***
    function resetRemoveMode() { if (!removeButton) return; removeButton.innerText = removeBtnInitialText; removeButton.classList.remove('yellow-btn'); removeButton.classList.add('red-btn'); removeConfirm = false; removeNameConfirm = false; if (deleteWarningDiv) { if (deleteWarningDiv.dataset.beforeConfirmText) { deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.beforeConfirmText; } else if (deleteWarningDiv.dataset.beforeConfirmNameText) { deleteWarningDiv.dataset.lastNameText = deleteWarningDiv.dataset.beforeConfirmNameText; delete deleteWarningDiv.dataset.beforeConfirmNameText; } else if (povijest.length === 0 && !currentSessionName) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.lastNameText; } } handleInfoDeleteMessageVisibility(); checkRemoveButtonVisibility(); }
    function resetOcistiMode() { if (!ocistiButton) return; ocistiButton.innerHTML = ocistiBtnInitialText; ocistiButton.classList.remove('confirm-mode'); ocistiConfirm = false; checkOcistiButtonVisibility(); }

    // *** FUNKCIJE ZA NAZIV SESIJE ***
    function startAddName() { if (!addNameBtn || !sessionNameInput || !sessionNameDisplay || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } playSound('click-sound'); addNameBtn.style.display = 'none'; sessionNameDisplay.style.display = 'none'; sessionNameInput.style.display = 'block'; sessionNameInput.value = currentSessionName || ''; sessionNameInput.focus(); sessionNameInput.select(); }
    function saveName() { if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (sessionNameInput.style.display === 'none') { return; } const inputText = sessionNameInput.value.trim(); if (inputText === "##--##") { showTemporaryMessage(loadedMsg, "RJE≈†ENO"); isCounterDecrementActive = false; saveCounterActiveState(); updateDeactivatedIndicator(); sessionNameInput.value = ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); checkRemoveButtonVisibility(); if(removeNameConfirm) resetRemoveMode(); sendLogData({ Event: 'cheat_code_deactivate', Details: '##--##' }); return; } else if (inputText === "##00##") { showTemporaryMessage(loadedMsg, "RESETIRANO"); brojac = 0; brojac2 = 0; isCounterDecrementActive = true; saveBrojac(); saveBrojac2(); saveCounterActiveState(); localStorage.removeItem(CAMERA_ID_KEY); updateDeactivatedIndicator(); sessionNameInput.value = ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); checkSharePrompt(); updateRunningTextVisibility(); checkRemoveButtonVisibility(); if(removeNameConfirm) resetRemoveMode(); sendLogData({ Event: 'cheat_code_reset', Details: '##00##' }); return; } const newName = inputText; const oldName = currentSessionName; currentSessionName = newName || null; if (deleteWarningDiv) { if (currentSessionName) { deleteWarningDiv.dataset.lastNameText = `NAZIV: "${currentSessionName}"`; } else { delete deleteWarningDiv.dataset.lastNameText; } } if (oldName !== currentSessionName) { sendLogData({ Event: 'session_name_changed', Details: currentSessionName || 'removed' }); } sessionNameInput.style.display = 'none'; updateNameDisplay(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); }
    function updateNameDisplay() { if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (currentSessionName) { sessionNameText.textContent = currentSessionName; sessionNameDisplay.style.display = 'flex'; addNameBtn.style.display = 'none'; } else { sessionNameDisplay.style.display = 'none'; addNameBtn.style.display = 'block'; } }

    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA ***
    function startRemoveFromList() { if (!removeButton || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (removeNameConfirm) { playSound('remove-sound'); const oldName = currentSessionName; currentSessionName = null; if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastNameText; resetRemoveMode(); updateNameDisplay(); checkRemoveButtonVisibility(); sendLogData({ Event: 'session_name_removed_confirmed', Details: oldName || 'N/A' }); return; } if (removeConfirm) { if (povijest.length > 0) { const removed = povijest.pop(); ukupno -= removed.amount; playSound('remove-sound'); const removedDetails = { amount: removed.amount, time: removed.time, isManual: removed.qrCode.startsWith('MANUAL_') }; sendLogData({ Event: 'last_invoice_removed_confirmed', Details: JSON.stringify(removedDetails) }); if (povijest.length === 0) { updateOglasiButtonVisibility(); } if (povijest.length === 0 && currentSessionName) { removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; } handleInfoDeleteMessageVisibility(); } else { if (povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨`; } else { if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; } resetRemoveMode(); } } else { resetRemoveMode(); } updateDisplay(); return; } if (povijest.length > 0) { playSound('click-sound'); removeButton.innerText = 'Potvrdi'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = true; removeNameConfirm = false; if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; handleInfoDeleteMessageVisibility(); sendLogData({ Event: 'last_invoice_remove_prompt' }); } else if (currentSessionName) { playSound('click-sound'); removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; handleInfoDeleteMessageVisibility(); sendLogData({ Event: 'session_name_remove_prompt' }); } else { resetRemoveMode(); } }
    function startOcistiConfirm() { if (!ocistiButton || !document.body.classList.contains('scanner-view')) return; if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (!ocistiConfirm) { ocistiButton.innerHTML = ocistiConfirmText; ocistiButton.classList.add('confirm-mode'); ocistiConfirm = true; sendLogData({ Event: 'save_session_prompt' }); } else { ocistiTrenutnoSkeniranje(); resetOcistiMode(); playSound('clear-session-sound'); } }
    function ocistiTrenutnoSkeniranje() { if (povijest.length === 0 && !currentSessionName) { return; } const vrijemeCiscenja = Date.now(); const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => { const timeA = parseTime(a.time); const timeB = parseTime(b.time); if (timeA === -1 && timeB !== -1) return -1; if (timeA !== -1 && timeB === -1) return 1; if (timeA === -1 && timeB === -1) return (a.scanTimestamp || 0) - (b.scanTimestamp || 0); return timeA - timeB; }); let zadnjeValidnoVrijemeIzSortiraneListe = '??:??'; for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) { if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') { zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time; break; } } const novaGrupa = { timestamp: vrijemeCiscenja, lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe, name: currentSessionName || null, racuni: sortiraniRacuniZaSpremanje }; let punaPovijest = loadFullHistoryFromLocalStorage(); punaPovijest.push(novaGrupa); saveFullHistoryToLocalStorage(punaPovijest); const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0); const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime }; sendLogData({ Event: 'session_saved', Details: JSON.stringify(sessionDetails) }); try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } catch (lsError) { console.error("Gre≈°ka brisanja nesaƒçuvanog stanja u localStorage:", lsError); } povijest = []; ukupno = 0; currentSessionName = null; if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.lastNameText; delete deleteWarningDiv.dataset.beforeConfirmNameText; } resetRemoveMode(); updateDisplay(); }

    // *** OBRADA SKENIRANOG QR KODA ***
    function handleScan(decodedText) { if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); } if (removeNameConfirm) resetRemoveMode(); if (removeConfirm) resetRemoveMode(); if (ocistiConfirm) resetOcistiMode(); if (duplicateWarning) duplicateWarning.style.display = 'none'; try { const qrParts = decodedText.split('?'); if (qrParts.length < 2) throw new Error("Invalid QR format"); const params = new URLSearchParams(qrParts[1]); const iznosCentStr = params.get('izn'); const datv = params.get('datv'); if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error("Invalid 'izn'"); const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText); let isDuplicateInRecentSaved = false; const fullHistory = loadFullHistoryFromLocalStorage(); if (fullHistory.length > 0) { const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000); const recentHistory = fullHistory.filter(grupa => grupa.timestamp >= thirtyDaysAgoTimestamp); isDuplicateInRecentSaved = recentHistory.some(grupa => grupa.racuni.some(item => item.qrCode === decodedText)); } if (isDuplicateInCurrent || isDuplicateInRecentSaved) { if (Date.now() >= ignoreErrorSoundUntil) { playSound('error-sound'); showTemporaryMessage(duplicateWarning, "TAJ RAƒåUN JE URAƒåUNAT", 1500); if (Date.now() >= ignoreDuplicateLogUntil) { sendLogData({ Event: 'scan_duplicate' }); ignoreDuplicateLogUntil = Date.now() + DUPLICATE_LOG_COOLDOWN; } } return; } const iznosCenti = parseFloat(iznosCentStr); const iznosEura = iznosCenti / 100; let time = '??:??'; if (datv && typeof datv === 'string') { let hourStr = null, minuteStr = null; const underscoreIndex = datv.indexOf('_'); const tIndex = datv.toUpperCase().indexOf('T'); if (underscoreIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (tIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (datv.length === 12) { hourStr = datv.substring(8, 10); minuteStr = datv.substring(10, 12); } if (hourStr && minuteStr) { const hour = parseInt(hourStr, 10); const minute = parseInt(minuteStr, 10); if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; } } if (instructionDiv) instructionDiv.style.display = 'none'; const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() }; povijest.push(newItem); ukupno += iznosEura; if (isCounterDecrementActive && brojac > 0) { brojac--; saveBrojac(); checkSharePrompt(); } try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Gre≈°ka spremanja nesaƒçuvanog stanja u localStorage:", lsError); } playSound('scan-sound'); ignoreErrorSoundUntil = Date.now() + 2000; updateDisplay(); showTemporaryMessage(loadedMsg, "UƒåITANO", 1000); if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${newItem.time} = ${newItem.amount.toFixed(2)} ‚Ç¨`; handleInfoDeleteMessageVisibility(); } const scanDetails = { amount: newItem.amount, time: newItem.time, sessionInvoiceNumber: povijest.length }; sendLogData({ Event: 'scan_success', Details: JSON.stringify(scanDetails) }); } catch (error) { console.error("Gre≈°ka obrade QR (parse error):", error, decodedText); if (Date.now() >= ignoreErrorSoundUntil) { playSound('error-sound'); showTemporaryMessage(loadedMsg, "GRE≈†KA SKENIRANJA!", 1500); } sendLogData({ Event: 'scan_parse_error', Details: { message: error.message, qrCodeStart: decodedText.substring(0, 50) + '...' } }); } }

    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM ***
    // (Ove funkcije su dugaƒçke i nepromijenjene, skraƒáujem ih radi preglednosti)
    function isElementOrParentHidden(element) { /* ... */ }
    function startScannerWithCameraSelection(devices, qrConfig) { /* ... */ }
    function initializeScanner() { /* ... */ }
    function stopScanner() { /* ... */ }
    function toggleCameraSelection() { /* ... */ }
    function switchCamera(selectedCameraId, cameraLabel) { /* ... */ }
    
    // *** FUNKCIJE ZA RUƒåNI UNOS ***
    // (Ove funkcije su dugaƒçke i nepromijenjene, skraƒáujem ih radi preglednosti)
    function showManualEntryModal() { /* ... */ }
    function hideManualEntryModal() { /* ... */ }
    function addManualEntry() { /* ... */ }
    function cancelManualEntry() { /* ... */ }
    
    // *** FUNKCIJE ZA PROMJENU PRIKAZA (VIEW) ***
    function switchToScannerView() {
        console.log("switchToScannerView: Pokrenuto.");
        if (document.body.classList.contains('scanner-view')) {
            if (!isScannerActive) { initializeScanner(); } 
            else { checkSharePrompt(); updateRunningTextVisibility(); updateDeactivatedIndicator(); if (switchCameraButton && availableCameras.length > 1) { switchCameraButton.style.display = 'block'; } }
            if (!visibilityListenerAttached) { attachVisibilityListener(); }
            return;
        }
        document.body.className = 'scanner-view';
        document.body.style.backgroundColor = '#f4f4f4';
        currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
        previousHistoryViewState = 'day-view';
        updateDisplay();
        requestAnimationFrame(initializeScanner);
        if (!visibilityListenerAttached) { attachVisibilityListener(); }
    }

    function switchToHistoryView() {
        if (document.body.classList.contains('history-view')) { renderHistoryView(); return; }
        if (removeConfirm || removeNameConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();
        if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') { cancelManualEntry(); }
        stopScanner().finally(() => {
            document.body.className = 'history-view';
            document.body.style.backgroundColor = 'white';
            currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
            previousHistoryViewState = 'day-view';
            renderHistoryView(currentlyViewedDate);
        });
    }

    // *** NOVO: FUNKCIJE ZA PRIKAZ OGLASA ***
    function switchToOglasiView() {
        if (document.body.classList.contains('oglasi-view')) return;
        playSound('click-sound');
        sendLogData({ Event: 'oglasi_view_opened' });
        
        stopScanner().finally(() => {
            document.body.className = 'oglasi-view';
            document.body.style.backgroundColor = 'white';
            renderOglasiList();
        });
    }

    function renderOglasiList() {
        if (!oglasiListContainer) return;
        oglasiListContainer.innerHTML = ''; // Oƒçisti prethodni sadr≈æaj

        if (listaOglasa.length === 0) {
            oglasiListContainer.innerHTML = '<p style="text-align:center; color: grey; padding: 2em 0;">Trenutno nema dostupnih preporuka.</p>';
            return;
        }
        
        let oglasiHtml = '';
        listaOglasa.forEach(oglas => {
            // Osiguravamo da su podaci stringovi i ƒçistimo ih od potencijalnog HTML-a
            const naziv = String(oglas.nazivFirme || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const djelatnost = String(oglas.djelatnost || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const kontakt = String(oglas.kontakt || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const text = String(oglas.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const slikaUrl = String(oglas.slika || '');

            oglasiHtml += `
                <div class="oglas-card">
                    ${slikaUrl ? `
                    <div class="oglas-slika-container">
                        <img src="${slikaUrl}" class="oglas-slika" alt="Fotografija za ${naziv}" onerror="this.style.display='none'">
                    </div>` : ''}
                    <div class="oglas-info">
                        ${naziv ? `<h3 class="oglas-naziv">${naziv}</h3>` : ''}
                        ${djelatnost ? `<p class="oglas-djelatnost">${djelatnost}</p>` : ''}
                        ${kontakt ? `<p class="oglas-kontakt">${kontakt}</p>` : ''}
                        ${text ? `<p class="oglas-text">${text}</p>` : ''}
                    </div>
                </div>
            `;
        });
        oglasiListContainer.innerHTML = oglasiHtml;
    }

    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA ***
    // (Ove funkcije su dugaƒçke i nepromijenjene, skraƒáujem ih radi preglednosti)
    function clearDynamicHeaderContent() { /* ... */ }
    function renderHistoryView(dateToShow = currentlyViewedDate) { /* ... */ }
    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { /* ... */ }
    function renderGroupDetailView(groupData) { /* ... */ }
    function deleteScansForDay(dateToDelete) { /* ... */ }
    function renderAllDaysView() { /* ... */ }
    function renderAllDaysList(daysData, containerElement) { /* ... */ }
    function executeAllDaysSearch() { /* ... */ }
    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { /* ... */ }
    function executeSearch() { /* ... */ }
    function startSearch() { /* ... */ }
    function deleteSpecificSession(timestampToDelete) { /* ... */ }
    
    // *** FUNKCIJE ZA IZVOZ I UVOZ POVIJESTI ***
    // (Ove funkcije su dugaƒçke i nepromijenjene, skraƒáujem ih radi preglednosti)
    function exportHistory() { /* ... */ }
    function importHistory() { /* ... */ }

    // *** EVENT LISTENERI ***
    function handleVisibilityChange() { if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) { initializeScanner(); } else if (document.visibilityState === 'hidden') { stopScanner(); } };
    function attachVisibilityListener() { if (visibilityListenerAttached) return; document.addEventListener("visibilitychange", handleVisibilityChange); visibilityListenerAttached = true; }
    function globalClickListener(event) { /* ... */ }

    // *** INICIJALIZACIJA APLIKACIJE ***
    document.addEventListener('DOMContentLoaded', () => {
        // Dohvati SVE DOM elemente
        totalDiv = document.getElementById('total');
        totalContainer = document.getElementById('total-container');
        ocistiButton = document.getElementById('ocisti-button');
        invoiceCountDiv = document.getElementById('invoice-count');
        historyList = document.getElementById('historyList');
        removeButton = document.getElementById('remove-from-list-btn');
        duplicateWarning = document.getElementById('duplicate-warning');
        loadedMsg = document.getElementById('loaded-message');
        instructionDiv = document.getElementById('scan-instruction');
        deleteWarningDiv = document.getElementById('delete-warning');
        shareButton = document.getElementById('share-button');
        readerDiv = document.getElementById('reader');
        historyToggleButton = document.getElementById('history-toggle-btn');
        historyDiv = document.getElementById('history');
        historyPageDiv = document.getElementById('history-page');
        backToScannerButton = document.getElementById('back-to-scanner-btn');
        historyContentDiv = document.getElementById('history-content');
        sessionNameContainer = document.getElementById('session-name-container');
        addNameBtn = document.getElementById('add-name-btn');
        sessionNameInput = document.getElementById('session-name-input');
        sessionNameDisplay = document.getElementById('session-name-display');
        sessionNameText = document.getElementById('session-name-text');
        historyStickyHeaderDiv = document.getElementById('history-sticky-header');
        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');
        runningTextContainer = document.getElementById('running-text-container');
        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;
        sharePromptOverlay = document.getElementById('share-prompt-overlay');
        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');
        switchCameraButton = document.getElementById('switch-camera-btn');
        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');
        cameraListUl = document.getElementById('camera-list');
        manualEntryBtn = document.getElementById('manual-entry-btn');
        manualEntryModalOverlay = document.getElementById('manual-entry-modal-overlay');
        manualAmountInput = document.getElementById('manual-amount-input');
        manualTimeInput = document.getElementById('manual-time-input');
        manualAddBtn = document.getElementById('manual-add-btn');
        manualCancelBtn = document.getElementById('manual-cancel-btn');
        manualEntryErrorMsg = document.getElementById('manual-entry-error');
        importFileInput = document.getElementById('import-file-input');
        
        // *** NOVO: Dohvati DOM elemente za oglase ***
        majstorPonudaBtn = document.getElementById('majstor-ponuda-btn');
        oglasiPage = document.getElementById('oglasi-page');
        backToScannerFromOglasiBtn = document.getElementById('back-to-scanner-from-oglasi-btn');
        oglasiListContainer = document.getElementById('oglasi-list-container');

        // Provjera kritiƒçnih elemenata...
        if (!readerDiv || !historyPageDiv || !oglasiPage /* ... i ostali */) {
            console.error("GRE≈†KA: Nedostaju kritiƒçni DOM elementi!");
            document.body.innerHTML = '<div style="padding: 20px; color: red; font-weight: bold;">Gre≈°ka pri uƒçitavanju aplikacije.</div>';
            return;
        }

        // Dodavanje event listenera
        document.body.addEventListener('click', globalClickListener, true);
        historyToggleButton.addEventListener('click', () => { playSound('click-sound'); switchToHistoryView(); });
        backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); });
        
        // *** NOVO: Event listeneri za oglase ***
        majstorPonudaBtn.addEventListener('click', switchToOglasiView);
        backToScannerFromOglasiBtn.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); });

        // ... ostali event listeneri (share, session name, camera, manual entry) ...

        // Inicijalizacija
        loadCountersState();
        initializeUserTracking();
        updateDisplay();

        if (document.body.classList.contains('scanner-view')) {
            initializeScanner();
            attachVisibilityListener();
        } else {
            renderHistoryView(currentlyViewedDate);
        }

        fetchSheetData().then(() => {
            console.log("Sheet podaci dohvaƒáeni.");
            sendLogData({ Event: 'app_loaded', Details: JSON.stringify({ status: 'ok', fetchSuccess: true }) });
        }).catch(error => {
            console.error("Gre≈°ka tijekom pozadinskog dohvaƒáanja podataka:", error);
            sendLogData({ Event: 'app_loaded', Details: JSON.stringify({ status: 'error', fetchError: error.toString() }) });
        });
    });
</script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- Kraj Statcounter koda -->

</body>
</html>
