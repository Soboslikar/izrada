<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DU캕AN SKENER</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centriraj main horizontalno */
            min-height: 100vh;
            background-color: #f4f4f4;
            box-sizing: border-box;
        }
        header {
            background-color: #333;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%; /* Header zauzima punu 코irinu */
            box-sizing: border-box;
            flex-shrink: 0;
        }
        footer {
            background-color: #333;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%; /* Footer zauzima punu 코irinu */
            text-transform: uppercase;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        footer p { margin: 0.3em 0; font-size: 0.85em; color: #ccc; }
        footer p:first-child { margin-top: 0; }
        footer p:last-child { margin-bottom: 0; }

        main {
            /* Vra캖amo stilove za 'main' kakvi su bili u tvojoj originalnoj verziji */
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 10px;
            margin-bottom: 10px;
            width: 95%;
            max-width: 600px;
            display: flex; /* Osigurava da sekcije unutar mogu koristiti flex svojstva */
            flex-direction: column; /* Sekcije se sla쬿 vertikalno */
            flex-grow: 1; /* Da main poku코a zauzeti raspolo쬴vi prostor ako je sadr쬬j manji */
        }
        main > section {
             width: 100%;
             box-sizing: border-box;
             /* Sekcije nemaju svoju pozadinu/sjene, to radi main */
        }
        main > section.hidden { display: none !important; }


        /* Specifi캜no za ekran pretrage da se pona코a druga캜ije od ostalih sekcija */
        /* Ako ekran pretrage treba biti full-width unutar main okvira, bez margina od main-a */
        #ekran-pretraga-nazivom {
            display: flex;
            flex-direction: column;
            height: 100%; /* Zauzima punu visinu main elementa ako je main flex kontejner */
            /* Ako 쬰limo da #ekran-pretraga-nazivom nema padding koji main > section ima */
            padding: 0; /* Override paddinga od main > section */
            background-color: transparent; /* Da se vidi pozadina main-a, a njegovi dijelovi imaju svoju */
            box-shadow: none; /* Ukloni duplu sjenu */
            border-radius: 0; /* Ukloni dupli radius */
            margin:0; /* Da se rastegne do rubova main-a */
        }


        h1, h2, h3 { color: #333; text-transform: uppercase; }

        button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 10px;
            font-size: 1em;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-sizing: border-box;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            text-transform: uppercase;
        }
        button:active { transform: scale(0.98); }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed !important; color: #666 !important; }

        .btn-zeleni { background-color: #28a745 !important; color: white; font-weight: bold; }
        .btn-zeleni:hover:not(:disabled) { background-color: #218838 !important; }
        .btn-zut { background-color: #ffc107 !important; color: #212529 !important; font-weight: bold; }
        .btn-zut:hover:not(:disabled) { background-color: #e0a800 !important; }
        #btn-nastavi-zadnja-trgovina { background-color: #1e7e34; }
        #btn-nastavi-zadnja-trgovina:hover:not(:disabled) { background-color: #155d27; }
        .btn-sivi { background-color: #6c757d !important; color: white !important; }
        .btn-sivi:hover:not(:disabled) { background-color: #5a6268 !important; }
        .button-group { display: flex; gap: 10px; } .button-group button { width: 100%; }
        .small-action-button { padding: 8px 12px; font-size: 0.9em; width: auto; margin-bottom: 0; }
        select { width:100%; padding:10px; margin-bottom:10px; font-size: 16px; box-sizing: border-box; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; font-size:16px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* === EKRAN SKENIRANJA STILOVI - VRA캕ENO NA NE-FULLSCREEN === */
        #ekran-skeniranja {
            /* Nema vi코e specifi캜nih fullscreen stilova, pona코a se kao ostale sekcije */
            position: relative; /* Za marquee */
        }

        #marquee-container-skener {
            position: absolute;
            top: 0; /* Na vrh #ekran-skeniranja */
            left: 0;
            width: 100%;
            z-index: 25;
            background-color: rgba(0,0,0,0.7);
            padding: 6px 0;
            box-sizing: border-box;
        }
        #marquee-container-skener .marquee-text { font-size: 1.1em; color: #ffc107; }


        #reader-container {
            position: relative; /* Kontekst za viewfinder i switch button */
            width: 100%;
            max-width: 500px; /* Ograni캜i 코irinu readera unutar sekcije */
            height: 30vh; /* Vra캖ena originalna visina */
            min-height: 250px;
            background-color: #000;
            margin-bottom: 5px;
            overflow: hidden;
            margin-left: auto; /* Centriraj reader ako je sekcija 코ira */
            margin-right: auto;
            /* margin-top: 35px; Ako marquee ide iznad, ina캜e ga reader preklapa */
        }
        #reader { width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; }
        #reader video, #reader > div > video, #reader > div:first-child > video { width: 100% !important; height: 100% !important; object-fit: cover !important; border:none !important; }
        #reader > div:first-child { width: 100% !important; height: 100% !important; border:none !important; }

        #viewfinder-overlay {
            display: none; /* <<< IZMJENA OVDJE: Sakriven na코 custom viewfinder */
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            max-width: 260px;
            padding-top: 50%;
            max-height: 200px;
            transform: translate(-50%, -50%);
            border: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
            background-image: linear-gradient(to right, white 2px, transparent 2px), linear-gradient(to bottom, white 2px, transparent 2px), linear-gradient(to left, white 2px, transparent 2px), linear-gradient(to bottom, white 2px, transparent 2px), linear-gradient(to right, white 2px, transparent 2px), linear-gradient(to top, white 2px, transparent 2px), linear-gradient(to left, white 2px, transparent 2px), linear-gradient(to top, white 2px, transparent 2px);
            background-repeat: no-repeat;
            background-size: 25px 25px;
            background-position: top left, top left, top right, top right, bottom left, bottom left, bottom right, bottom right;
            border-radius: 8px;
            z-index: 10;
            pointer-events: none;
        }
        #switch-camera-btn { position: absolute; top: 10px; right: 10px; z-index: 30; padding: 8px 10px; background-color: rgba(0,0,0,0.4); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; font-size: 1.5em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; width: auto; margin-bottom: 0; }
        #camera-selection-overlay { position: absolute; top: 50px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 31; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 180px; width: auto; }
        #camera-list { list-style: none; padding: 0; margin: 0; } #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; color: #333; text-transform: none; } #camera-list li:hover { background-color: #f0f0f0; } #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }

        .messages-skener { text-align: center; margin-top: 0; /* Vra캖eno s tvoje originalne verzije */ margin-bottom: 5px; min-height: 1.2em; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; }
        .messages-skener .status { color: #333; margin:0; padding: 2px 0; font-weight: bold; }
        .messages-skener .error { color: #dc3545; font-weight: bold; margin:0; padding: 2px 0; }

        #sadrzaj-ispod-skenera {
            padding: 5px 10px; /* Vra캖eno s tvoje originalne verzije */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Nema pozadine, naslje캠uje od #ekran-skeniranja (koji je dio main-a) */
        }
        /* Ostatak CSS-a ostaje isti */

        #info-skeniranog-proizvoda-container { border: 1px solid #ccc; padding: 12px; margin-bottom: 8px; background-color: #fff; width: 100%; max-width: 500px; color: #333; font-size: 1.1em; }
        #info-skeniranog-proizvoda-container p, #info-skeniranog-proizvoda-container label { color: #333; }
        #info-skeniranog-proizvoda-container p:first-of-type { margin-top: 0; }
        input[type="number"]#skenirana-kolicina { background-color: #f1f1f1; color: #333; border: 1px solid #ccc; width: 55px !important; padding: 8px !important; font-size:1em; margin:0 5px 0 0 !important; }
        .kolicina-ukupno-red-flex { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 10px; padding: 5px 0; }
        .kolicina-ukupno-red-flex > div { display: flex; align-items: center; }
        .kolicina-ukupno-red-flex label { margin-right: 5px; text-transform: uppercase; }
        #lista-summary-container { padding: 8px; margin-bottom: 8px; background-color: #333; width: 100%; max-width: 500px; color: #f0f0f0; border: 1px solid #333; }
        #lista-summary-tekst { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; text-align: center; text-transform: uppercase; }

        .sticky-header { padding: 10px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; position: sticky; top: 0; z-index: 100; width: 100%; box-sizing: border-box; flex-shrink: 0; }
        .header-gornji-red { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header-gornji-red button { width: auto; margin: 0; padding: 6px 10px; font-size: 0.9em; }
        .header-donji-red { text-align: center; font-weight: bold; font-size: 1.2em; color: #333; text-transform: uppercase; }
        .scrollable-content { flex-grow: 1; overflow-y: auto; padding: 10px; width:100%; box-sizing:border-box; background-color: white; }
        #ekran-pretraga-nazivom .sticky-header .header-gornji-red { margin-bottom: 10px; align-items: center; }
        #ekran-pretraga-nazivom .sticky-header .header-gornji-red h2 { margin:0; flex-grow:1; text-align:center; font-size: 1.1em; }
        #input-pretraga-naziv { width: 100%; padding: 10px; font-size: 1em; margin-top: 0; margin-bottom: 8px; box-sizing: border-box; }
        .sticky-header-subtext { font-size: 0.8em; color: #555; text-align: center; width: 100%; padding-top: 0; margin: 0 0 5px 0; text-transform: uppercase; }
        #filteri-container { padding: 8px 0 5px 0; border-top: 1px solid #e0e0e0; margin-top: 5px; background-color: #f8f9fa; display: none; }
        .filter-grupa { margin-bottom: 8px; padding: 0 10px; }
        .filter-grupa:last-child { margin-bottom: 0; }
        .filter-label { font-size: 0.8em; font-weight: bold; color: #333; margin-bottom: 4px; display: block; text-transform: uppercase; }
        .filter-opcije-wrapper { display: flex; flex-wrap: wrap; gap: 6px; }
        button.filter-opcija { padding: 5px 10px; font-size: 0.85em; margin-bottom: 0; width: auto; background-color: #e9ecef; color: #212529; border: 1px solid #ced4da; text-transform: none; font-weight: normal; }
        button.filter-opcija.aktivan { background-color: #007bff !important; color: white !important; border-color: #0056b3 !important; font-weight: bold; }
        button.filter-opcija:hover:not(:disabled):not(.aktivan) { background-color: #dee2e6; }
        .stavka-liste, .povijest-stavka, .usporedba-stavka, .pronadji-rezultati-stavka, .pretraga-nazivom-stavka { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; margin-bottom: 5px; color: #333; }
        .stavka-liste:last-child, .povijest-stavka:last-child, .usporedba-stavka:last-child, .pronadji-rezultati-stavka:last-child, .pretraga-nazivom-stavka:last-child { border-bottom: none; margin-bottom: 0;}
        .stavka-liste-info, .povijest-stavka-info, .usporedba-stavka-info, .pronadji-rezultati-stavka-info, .pretraga-nazivom-stavka-info { flex-grow: 1; margin-right: 5px; overflow: hidden; }
        .stavka-naziv, .pretraga-nazivom-naziv-proizvoda { font-weight: bold; font-size: 1em; margin-bottom: 3px; word-break: break-word; text-transform: uppercase; }
        .stavka-detalji, .pretraga-nazivom-detalji { font-size: 0.85em; color: #6c757d; margin-bottom: 3px; word-break: break-word; text-transform: uppercase; }
        .stavka-ukupno, .povijest-iznos, .usporedba-cijena, .pronadji-rezultati-cijena, .pretraga-nazivom-cijena { font-size: 0.9em; font-weight: bold; white-space: nowrap; margin-left:10px; text-align: right; flex-shrink:0; }
        .pretraga-nazivom-ducan { font-weight: bold; font-size: 0.9em; color: #007bff; margin-bottom: 2px; text-transform: uppercase;}
        .cijena-jeftinije { color: #28a745 !important; } .cijena-skuplje { color: #dc3545 !important; } .cijena-najjeftinije { color: #28a745 !important; font-weight: bold; }
        .usporedba-dimmed { color: #888 !important; } .usporedba-default { color: #333 !important; } .usporedba-bold { font-weight: bold !important; }
        #usporedba-kosarice-original { font-size: 1.1em !important; font-weight: bold; color: #333 !important; text-align: center; text-transform: uppercase; }
        #usporedba-kosarice-container .stavka-naziv { font-size: 1.1em; text-transform: uppercase; } #usporedba-kosarice-container .usporedba-cijena { font-size: 1.1em; }
        .btn-brisi-stavku { background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1em; line-height: 28px; padding: 0; cursor: pointer; margin-left: 10px; flex-shrink: 0; }
        .btn-brisi-stavku:hover:not(:disabled) { background-color: #c82333; }
        .povijest-stavka { cursor: pointer; } .povijest-stavka:hover { background-color: #f8f9fa; }
        #scan-feedback-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.95); border-radius: 10px; padding: 20px 40px; text-align: center; font-size: 1.8em; font-weight: bold; z-index: 30; opacity: 0; scale: 0.7; pointer-events: none; transition: opacity 0.3s ease-out, scale 0.3s ease-out; text-transform: uppercase; }
        #scan-feedback-overlay.show { opacity: 1; scale: 1; }
        #scan-feedback-overlay.success { color: #28a745; border: 3px solid #28a745; }
        #scan-feedback-overlay.error { color: #dc3545; border: 3px solid #dc3545; }
        .marquee-container { width: 100%; overflow: hidden; background-color: #000; padding: 8px 0; box-sizing: border-box;}
        .marquee-text { color: #ffc107; font-size: 1.35em; font-weight: bold; white-space: nowrap; display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .gumb-za-dijeljenje { background-color: #1e7e34 !important; color: white !important; font-weight: bold !important; }
        .gumb-za-dijeljenje:hover:not(:disabled) { background-color: #155d27 !important; }
        .animacija-pulsiranje-horizontalno { animation: pulseHorizontalShrinkReturn 2.0s infinite ease-in-out; }
        @keyframes pulseHorizontalShrinkReturn { 0%   { transform: scaleX(1); } 45%  { transform: scaleX(0.75); } 55%  { transform: scaleX(0.75); } 100% { transform: scaleX(1); } }
        #ekran-skeniranja #btn-pokreni-zaustavi-skener,
        #ekran-skeniranja #btn-nazad-sa-skeniranja,
        #ekran-skeniranja #btn-pokazi-pretragu-nazivom { padding: 10px 15px; }
        #ekran-skeniranja #btn-nazad-sa-skeniranja,
        #ekran-skeniranja #btn-pokazi-pretragu-nazivom { font-size: 0.9em; }
        #ekran-skeniranja #btn-pokreni-zaustavi-skener { font-size: 1.1em; font-weight: bold; }
        #sadrzaj-ispod-skenera .button-group button,
        #sadrzaj-ispod-skenera #lista-summary-container button { padding: 8px 12px; font-size: 0.9em; }
        #sadrzaj-ispod-skenera .button-group { margin-top: 6px; }
        @keyframes animacijaTekstBojaZuto { 0%, 100% { color: white; } 50% { color: #FFC107; } }
        .animacija-tekst-zuto { animation: animacijaTekstBojaZuto 1.5s infinite; }
    </style>
</head>
<body>
    <header><h1>DU캕AN SKENER</h1></header>
    <div id="marquee-container" class="marquee-container hidden"><span id="marquee-text" class="marquee-text">U캜itavanje novosti...</span></div>
    <main id="app-container">
        <section id="pocetni-ekran">
            <h2>DOBRODOLI!</h2>
            <button id="btn-izaberi-trgovinu">IZABERI TRGOVINU</button>
            <button id="btn-nastavi-zadnja-trgovina" class="hidden">NASTAVI S [NAZIV ZADNJE TRGOVINE]</button>
            <button id="btn-pronadji-proizvod" class="btn-zut">PRONA캟I PROIZVOD</button>
            <button id="btn-povijest-kupovine" class="btn-sivi">POVIJEST KUPOVINE</button>
            <button id="btn-posalji-prijedlog-pocetna" class="btn-sivi" style="margin-top: 20px; background-color: #5bc0de !important;" disabled>
                POㅁLJI PRIJEDLOG (USKORO)
            </button>
            <button id="btn-podijeli-aplikaciju-pocetna" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 15px;">PODIJELI DU캕AN SKENER</button>
        </section>

        <section id="ekran-odabir-trgovine" class="hidden">
            <h2>ODABERI TRGOVINU:</h2>
            <select id="select-trgovina"><option value="">U캛ITAVANJE...</option></select>
            <button id="btn-potvrdi-trgovinu" disabled>POTVRDI ODABIR</button>
            <button id="btn-nazad-na-pocetnu-sa-odabira">NAZAD</button>
        </section>

        <section id="glavni-ekran-akcija" class="hidden">
            <h2 id="info-odabrana-trgovina">TRGOVINA: [NAZIV TRGOVINE]</h2>
            <button id="btn-skeniraj-proizvod" class="btn-zeleni">SKENIRAJ PROIZVOD</button>
            <button id="btn-promijeni-trgovinu">PROMIJENI TRGOVINU</button>
            <button id="btn-povijest-sa-akcija" class="btn-sivi">POVIJEST KUPOVINE</button>
            <button id="btn-akcije-na-pocetnu" class="btn-sivi">NA PO캛ETAK</button>
        </section>

        <section id="ekran-skeniranja" class="hidden">
            <div id="marquee-container-skener" class="marquee-container hidden"><span id="marquee-text-skener" class="marquee-text">U캜itavanje novosti...</span></div>
            <div id="reader-container">
                <div id="reader"></div><div id="viewfinder-overlay"></div><div id="scan-feedback-overlay"></div>
                <button id="switch-camera-btn">游댃</button>
                <div id="camera-selection-overlay"><ul id="camera-list"></ul></div>
            </div>
            <div class="messages-skener"><p id="statusTextSkener" class="status"></p><p id="errorTextSkener" class="error"></p></div>
            <button id="btn-pokreni-zaustavi-skener" class="btn-zeleni hidden">PONOVO POKRENI SKENER</button>
            <button id="btn-pokazi-pretragu-nazivom" class="btn-sivi hidden" style="margin-top: 5px;">UPII NAZIV ZA PRETRAGU</button>
            <div id="sadrzaj-ispod-skenera" class="hidden">
                <div id="info-skeniranog-proizvoda-container" class="hidden">
                    <p><strong>NAZIV:</strong> <span id="skeniran-naziv"></span></p>
                    <p><strong>CIJENA/KOM:</strong> <span id="skenirana-cijena"></span> EUR</p>
                    <p><strong>CIJENA PO JM:</strong> <span id="skenirana-cijena-po-jedinici"></span></p>
                    <div class="kolicina-ukupno-red-flex">
                        <div>
                            <label for="skenirana-kolicina">KOLI캛INA:</label>
                            <input type="number" id="skenirana-kolicina" value="1" min="1">
                        </div>
                        <div id="skeniran-item-ukupno">UKUPNO: 0.00 EUR</div>
                    </div>
                    <div class="button-group" style="margin-top:8px;">
                        <button id="btn-usporedi-cijene" class="btn-zut">USPOREDI</button>
                        <button id="btn-dodaj-skenirano-na-listu" class="btn-zeleni">DODAJ NA LISTU</button>
                    </div>
                </div>
                <div id="lista-summary-container" class="hidden"><div id="lista-summary-tekst">UKUPNO: <span id="ukupno-cijena-skeniranje-sum">0.00</span> EUR</div><button id="btn-pogledaj-listu">POGLEDAJ LISTU</button></div>
                <button id="btn-nazad-sa-skeniranja" style="margin-top: 4px; margin-bottom: 3px;">ZAVRI I SPREMI</button>
                <button id="btn-podijeli-aplikaciju-skener" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 3px; margin-bottom: 8px;">PODIJELI DU캕AN SKENER</button>
            </div>
        </section>

        <section id="ekran-pretraga-nazivom" class="hidden">
            <div class="sticky-header">
                <div class="header-gornji-red">
                    <button id="btn-pretraga-nazivom-nazad" class="small-action-button">NAZAD</button>
                    <h2 style="margin:0; flex-grow:1; text-align:center;">PRETRAGA NAZIVOM</h2>
                    <span style="width: auto; min-width: 100px; visibility: hidden;">Placeholder</span>
                </div>
                <input type="text" id="input-pretraga-naziv" placeholder="UPII POJAM ZA PRETRAGU (MIN. 3 ZNAKA)">
                <div id="filteri-container">
                </div>
                <p class="sticky-header-subtext">PODACI O CIJENAMA PREUZETI IZ CIJENE.API</p>
            </div>
            <div class="scrollable-content" id="rezultati-pretrage-nazivom-container">
            </div>
        </section>

        <section id="ekran-liste-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-lista-na-skener" class="small-action-button">NA SKENER</button><button id="btn-lista-na-pocetak" class="small-action-button">ZAVRI I SPREMI</button></div><div class="header-donji-red">UKUPNO: <span id="ukupno-cijena-lista-prikaz">0.00</span> EUR</div></div>
            <div class="scrollable-content" id="lista-kupovine-stavke-container"><p id="prazna-lista-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">LISTA JE PRAZNA.</p></div>
        </section>

        <section id="ekran-povijest-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-povijest-na-pocetak" class="small-action-button">NA PO캛ETAK</button><h2 style="margin:0; flex-grow:1; text-align:center;">POVIJEST KUPOVINE</h2><span></span></div></div>
            <div class="scrollable-content" id="povijest-kupovine-container"><p id="prazna-povijest-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">NEMA SPREMLJENIH KUPOVINA.</p></div>
            <div style="padding: 0 10px 10px 10px;"><button id="btn-ocisti-povijest" style="background-color:#dc3545;" class="hidden">O캛ISTI POVIJEST</button></div>
        </section>

        <section id="ekran-specifikacija-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-specifikacija-na-povijest" class="small-action-button">NAZAD NA POVIJEST</button><h2 style="margin:0; flex-grow:1; text-align:center;" id="specifikacija-naslov">KUPOVINA</h2><span></span></div><div class="header-donji-red" id="specifikacija-ukupno">UKUPNO: 0.00 EUR</div></div>
            <div class="scrollable-content" id="specifikacija-stavke-container"></div>
            <div style="padding: 0 10px 10px 10px;"><button id="btn-usporedi-kosaricu" class="btn-zut">USPOREDI CIJELU KOㅁRICU</button></div>
        </section>

        <section id="ekran-usporedbe-cijena" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-usporedba-na-skener" class="small-action-button">NAZAD NA SKENER</button><h2 style="margin:0; flex-grow:1; text-align:center;" id="usporedba-artikl-naziv">USPOREDBA</h2><span></span></div><div style="text-align:center; font-size:0.9em; color:#6c757d;" id="usporedba-artikl-cijena-trenutna"></div></div>
            <div class="scrollable-content" id="usporedba-cijena-container"><p id="usporedba-nema-podataka-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">NEMA PODATAKA ZA USPOREDBU.</p></div>
        </section>

        <section id="ekran-pronadji-proizvod-rezultati" class="hidden">
            <div class="sticky-header">
                <div class="header-gornji-red">
                    <button id="btn-pronadji-rezultati-na-pocetnu" class="small-action-button">NA PO캛ETAK</button>
                    <h2 style="margin:0; flex-grow:1; text-align:center;" id="pronadji-rezultati-artikl-naziv">PRETRAGA PROIZVODA</h2>
                    <button id="btn-pronadji-rezultati-na-skener" class="small-action-button">NOVI SKEN</button>
                </div>
            </div>
            <div class="scrollable-content" id="pronadji-rezultati-lista-container">
                <p id="pronadji-rezultati-nema-podataka-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">SKENIRAJTE PROIZVOD ZA PRIKAZ CIJENA.</p>
            </div>
        </section>

        <section id="ekran-usporedba-kosarice" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-usporedba-kosarice-nazad" class="small-action-button">NAZAD NA KUPOVINU</button><h2 style="margin:0; flex-grow:1; text-align:center;">USPOREDBA KOㅁRICE</h2><span></span></div><div id="usporedba-kosarice-original"></div></div>
            <div class="scrollable-content" id="usporedba-kosarice-container"></div>
        </section>
    </main>
     <footer>
        <p>PODACI O CIJENAMA PREUZETI IZ CIJENE.API</p>
        <p>춸 2025 DU캕AN SKENER</p>
        <p>IZRADILI: DARKO BANOVI캕 I GOOGLE AI</p>
    </footer>
    <script type="text/javascript">var sc_project=13142545; var sc_invisible=1; var sc_security="cd38ae59";</script>
    <script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async></script>
    <noscript><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/13142545/0/cd38ae59/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></noscript>
    <audio id="zvuk-klik" src="click8.mp3" preload="auto"></audio>
    <audio id="zvuk-ima" src="ima.mp3" preload="auto"></audio>
    <audio id="zvuk-nema" src="nema.mp3" preload="auto"></audio>
    <script>
        // --- KONSTANTE ---
        const API_BASE_URL="https://api.cijene.dev",API_KEY="mee5xooThuithei4ees4bae3emos3ook",MAX_POVIJEST_KUPVINA=20,GOOGLE_APPS_SCRIPT_URL="YOUR_APPS_SCRIPT_URL_HERE",LS_PREFIX="ds_",LS_KEYS={ZADNJA_TRGOVINA_KOD:`${LS_PREFIX}zadnjaTrgovinaKod`,ZADNJA_TRGOVINA_NAZIV:`${LS_PREFIX}zadnjaTrgovinaNaziv`,POVIJEST_KUPOVINA:`${LS_PREFIX}povijestKupovina`,KORISNICKI_ID:`${LS_PREFIX}korisnickiID`,CAMERA_ID:`${LS_PREFIX}selectedCameraID`};
        const MIN_SEARCH_QUERY_LENGTH = 3;
        const DEBOUNCE_DELAY = 400;

        // --- DOM ELEMENTI ---
        const pocetniEkran=document.getElementById("pocetni-ekran"),ekranOdabirTrgovine=document.getElementById("ekran-odabir-trgovine"),glavniEkranAkcija=document.getElementById("glavni-ekran-akcija"),ekranSkeniranja=document.getElementById("ekran-skeniranja"),ekranListeKupovine=document.getElementById("ekran-liste-kupovine"),ekranPovijestKupovine=document.getElementById("ekran-povijest-kupovine"),ekranSpecifikacijaKupovine=document.getElementById("ekran-specifikacija-kupovine"),ekranUsporedbeCijena=document.getElementById("ekran-usporedbe-cijena"),ekranUsporedbaKosarice=document.getElementById("ekran-usporedba-kosarice"),
        ekranPronadjiProizvodRezultati = document.getElementById("ekran-pronadji-proizvod-rezultati"),
        ekranPretragaNazivom = document.getElementById("ekran-pretraga-nazivom"),
        btnIzaberiTrgovinu=document.getElementById("btn-izaberi-trgovinu"),btnNastaviZadnjaTrgovina=document.getElementById("btn-nastavi-zadnja-trgovina"),
        btnPronadjiProizvod = document.getElementById("btn-pronadji-proizvod"),
        btnPovijestKupovine=document.getElementById("btn-povijest-kupovine"),selectTrgovina=document.getElementById("select-trgovina"),btnPotvrdiTrgovinu=document.getElementById("btn-potvrdi-trgovinu"),btnNazadNaPocetnuSaOdabira=document.getElementById("btn-nazad-na-pocetnu-sa-odabira"),infoOdabranaTrgovina=document.getElementById("info-odabrana-trgovina"),
        btnSkenirajProizvod=document.getElementById("btn-skeniraj-proizvod"),btnPromijeniTrgovinu=document.getElementById("btn-promijeni-trgovinu"),btnPovijestSaAkcija=document.getElementById("btn-povijest-sa-akcija"),
        btnAkcijeNaPocetnu = document.getElementById("btn-akcije-na-pocetnu"),
        btnPokaziPretraguNazivom = document.getElementById("btn-pokazi-pretragu-nazivom"),
        btnNazadSaSkeniranja=document.getElementById("btn-nazad-sa-skeniranja"),infoSkeniranogProizvodaContainer=document.getElementById("info-skeniranog-proizvoda-container"),skeniranNazivEl=document.getElementById("skeniran-naziv"),skeniranaCijenaEl=document.getElementById("skenirana-cijena"),skeniranaCijenaPoJediniciEl=document.getElementById("skenirana-cijena-po-jedinici"),skeniranaKolicinaInput=document.getElementById("skenirana-kolicina"),skeniranItemUkupnoEl=document.getElementById("skeniran-item-ukupno"),btnDodajSkeniranoNaListu=document.getElementById("btn-dodaj-skenirano-na-listu"),btnUsporediCijene=document.getElementById("btn-usporedi-cijene"),
        btnPosaljiPrijedlogPocetna = document.getElementById("btn-posalji-prijedlog-pocetna"),
        btnPodijeliAplikacijuPocetna=document.getElementById("btn-podijeli-aplikaciju-pocetna"),
        btnPodijeliAplikacijuSkener = document.getElementById("btn-podijeli-aplikaciju-skener"),
        marqueeContainer=document.getElementById("marquee-container"),marqueeText=document.getElementById("marquee-text"),marqueeContainerSkener=document.getElementById("marquee-container-skener"),marqueeTextSkener=document.getElementById("marquee-text-skener"),shareOverlayMessageEl=document.getElementById("share-overlay-message"),readerDiv=document.getElementById("reader"),switchCameraButton=document.getElementById("switch-camera-btn"),cameraSelectionOverlay=document.getElementById("camera-selection-overlay"),cameraListUl=document.getElementById("camera-list"),scanFeedbackOverlay=document.getElementById("scan-feedback-overlay"),statusTextSkenerElem=document.getElementById("statusTextSkener"),errorTextSkenerElem=document.getElementById("errorTextSkener"),btnPokreniZaustaviSkener=document.getElementById("btn-pokreni-zaustavi-skener"),listaSummaryContainer=document.getElementById("lista-summary-container"),ukupnoCijenaSkeniranjeSumEl=document.getElementById("ukupno-cijena-skeniranje-sum"),btnPogledajListu=document.getElementById("btn-pogledaj-listu"),btnListaNaSkener=document.getElementById("btn-lista-na-skener"),btnListaNaPocetak=document.getElementById("btn-lista-na-pocetak"),ukupnoCijenaListaPrikazEl=document.getElementById("ukupno-cijena-lista-prikaz"),listaKupovineStavkeContainer=document.getElementById("lista-kupovine-stavke-container"),praznaListaPorukaEl=document.getElementById("prazna-lista-poruka"),btnPovijestNaPocetak=document.getElementById("btn-povijest-na-pocetak"),povijestKupovineContainer=document.getElementById("povijest-kupovine-container"),praznaPovijestPorukaEl=document.getElementById("prazna-povijest-poruka"),btnOcistiPovijest=document.getElementById("btn-ocisti-povijest"),btnSpecifikacijaNaPovijest=document.getElementById("btn-specifikacija-na-povijest"),specifikacijaNaslovEl=document.getElementById("specifikacija-naslov"),specifikacijaUkupnoEl=document.getElementById("specifikacija-ukupno"),specifikacijaStavkeContainer=document.getElementById("specifikacija-stavke-container"),btnUsporediKosaricu=document.getElementById("btn-usporedi-kosaricu"),btnUsporedbaNaSkener=document.getElementById("btn-usporedba-na-skener"),usporedbaArtiklNazivEl=document.getElementById("usporedba-artikl-naziv"),usporedbaArtiklCijenaTrenutnaEl=document.getElementById("usporedba-artikl-cijena-trenutna"),usporedbaCijenaContainer=document.getElementById("usporedba-cijena-container"),usporedbaNemaPodatakaPorukaEl=document.getElementById("usporedba-nema-podataka-poruka"),
        btnPronadjiRezultatiNaPocetnu = document.getElementById("btn-pronadji-rezultati-na-pocetnu"),
        btnPronadjiRezultatiNaSkener = document.getElementById("btn-pronadji-rezultati-na-skener"),
        pronadjiRezultatiArtiklNazivEl = document.getElementById("pronadji-rezultati-artikl-naziv"),
        pronadjiRezultatiListaContainer = document.getElementById("pronadji-rezultati-lista-container"),
        pronadjiRezultatiNemaPodatakaPorukaEl = document.getElementById("pronadji-rezultati-nema-podataka-poruka"),
        btnPretragaNazivomNazad = document.getElementById("btn-pretraga-nazivom-nazad"),
        inputPretragaNaziv = document.getElementById("input-pretraga-naziv"),
        filteriContainer = document.getElementById("filteri-container"),
        rezultatiPretrageNazivomContainer = document.getElementById("rezultati-pretrage-nazivom-container"),
        btnUsporedbaKosariceNazad=document.getElementById("btn-usporedba-kosarice-nazad"),usporedbaKosariceOriginalEl=document.getElementById("usporedba-kosarice-original"),usporedbaKosariceContainer=document.getElementById("usporedba-kosarice-container"),audioElements={klik:document.getElementById("zvuk-klik"),ima:document.getElementById("zvuk-ima"),nema:document.getElementById("zvuk-nema")};

        // --- GLOBALNE VARIJABLE ---
        let trenutnoOdabranaTrgovina=null,zadnjeOdabranaTrgovinaKod=localStorage.getItem(LS_KEYS.ZADNJA_TRGOVINA_KOD),zadnjeOdabranaTrgovinaNaziv=localStorage.getItem(LS_KEYS.ZADNJA_TRGOVINA_NAZIV),html5QrCode=null,isScannerRunning=!1,availableCameras=[],trenutnaListaKupovine=[],zadnjiSkeniraniProizvodInfo=null,povijestKupovina=JSON.parse(localStorage.getItem(LS_KEYS.POVIJEST_KUPOVINA))||[],korisnickiID=localStorage.getItem(LS_KEYS.KORISNICKI_ID),trenutnoPrikazanaKupovinaId=null,
        pronadjiProizvodMode = false,
        debounceTimeout = null,
        originalniRezultatiPretrageNazivom = [],
        aktivniFilteriPretrageNazivom = {};

        function pustiZvuk(e){const t=audioElements[e];t&&(t.currentTime=0,t.play().catch(e=>console.error("Gre코ka pri reprodukciji zvuka:",e)))}
        function generirajUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}

        function prikaziEkran(e){
            const sveSekcije=[pocetniEkran,ekranOdabirTrgovine,glavniEkranAkcija,ekranSkeniranja,ekranListeKupovine,ekranPovijestKupovine,ekranSpecifikacijaKupovine,ekranUsporedbeCijena,ekranUsporedbaKosarice, ekranPronadjiProizvodRezultati, ekranPretragaNazivom ];
            sveSekcije.forEach(el=>{if(el) el.classList.toggle("hidden",el.id!==e)});

            // Ukloni fullscreen klasu s bodyja ako nije ekran skeniranja
            if (e !== "ekran-skeniranja") {
                document.body.classList.remove("fullscreen");
                 if (document.querySelector('header')) document.querySelector('header').style.display = 'block';
                 if (document.querySelector('footer')) document.querySelector('footer').style.display = 'block';
                 if (marqueeContainerSkener) marqueeContainerSkener.classList.add("hidden"); // Sakrij marquee skenera
            } else { // Ako JEST ekran skeniranja
                document.body.classList.add("fullscreen");
                if (document.querySelector('header')) document.querySelector('header').style.display = 'none';
                if (document.querySelector('footer')) document.querySelector('footer').style.display = 'none';
                 if (marqueeContainerSkener) { // Poka쬴 marquee za skener
                    if (!marqueeTextSkener.textContent || marqueeTextSkener.textContent === "U캜itavanje novosti...") {
                        dohvatiMarqueeText();
                    }
                    marqueeContainerSkener.classList.remove("hidden");
                }
            }

            if (marqueeContainer && e === "pocetni-ekran") { // Poka쬴 glavni marquee samo na po캜etnom
                marqueeContainer.classList.remove("hidden");
                dohvatiMarqueeText();
            } else if (marqueeContainer) {
                marqueeContainer.classList.add("hidden");
            }


            if (btnSkenirajProizvod.classList.contains('animacija-tekst-zuto') && e !== 'glavni-ekran-akcija') {
                btnSkenirajProizvod.classList.remove('animacija-tekst-zuto');
            }
            if (e !== 'ekran-skeniranja') {
                btnPokreniZaustaviSkener.classList.remove('animacija-tekst-zuto');
                btnPokreniZaustaviSkener.classList.add('hidden');
            }

            // Logika specifi캜na za ekrane
            if ("pocetni-ekran"===e) {
                // pronadjiProizvodMode = false; // Resetiraj ako je potrebno
            } else if ("glavni-ekran-akcija" === e) {
                btnSkenirajProizvod.classList.add('animacija-tekst-zuto');
            } else if ("ekran-skeniranja"===e) {
                btnPokreniZaustaviSkener.classList.add('hidden');
                btnPokreniZaustaviSkener.classList.remove('animacija-tekst-zuto');
                infoSkeniranogProizvodaContainer.classList.add("hidden");
                btnNazadSaSkeniranja.textContent = pronadjiProizvodMode ? "NATRAG NA OPCIJE" : "ZAVRI I SPREMI";
                btnPokaziPretraguNazivom.classList.toggle("hidden", !pronadjiProizvodMode);
                document.getElementById('sadrzaj-ispod-skenera').classList.toggle('hidden', pronadjiProizvodMode);

                if (pronadjiProizvodMode) {
                    if(statusTextSkenerElem) statusTextSkenerElem.textContent = "PRONA캟I PROIZVOD: SKENIRAJTE BARKOD";
                    if(listaSummaryContainer) listaSummaryContainer.classList.add("hidden");
                } else {
                    if(statusTextSkenerElem) statusTextSkenerElem.textContent = trenutnoOdabranaTrgovina ? `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENIRAJTE BARKOD` : "ODABERITE TRGOVINU.";
                    if(listaSummaryContainer) listaSummaryContainer.classList.toggle("hidden", trenutnaListaKupovine.length === 0);
                    azurirajPrikazSumarneListe();
                }
                 if(errorTextSkenerElem) errorTextSkenerElem.textContent = "";
                initializeAndStartScanner();
            } else if (e === "ekran-pretraga-nazivom") {
                // Ovdje je va쬹o da se sakriju header i footer ako NISU dio fullscreen moda
                // To je ve캖 pokriveno gore, ali za svaki slu캜aj ako #ekran-pretraga-nazivom treba posebnu logiku
                // (trenutno je full-width unutar main-a)
                if (document.querySelector('header')) document.querySelector('header').style.display = 'none';
                if (document.querySelector('footer')) document.querySelector('footer').style.display = 'none';
                if (marqueeContainer) marqueeContainer.classList.add("hidden");

                if (inputPretragaNaziv.value.length < MIN_SEARCH_QUERY_LENGTH && originalniRezultatiPretrageNazivom.length === 0) {
                     rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UPIITE POJAM ZA PRETRAGU (MIN. ${MIN_SEARCH_QUERY_LENGTH} ZNAKA).</p>`;
                }
                if (isScannerRunning) stopSkener(true);
            } else if (isScannerRunning && !["ekran-skeniranja"].includes(e)) { // Ako napu코tamo skener, a nije pretraga nazivom
                 stopSkener(true);
            }

            if ("ekran-liste-kupovine"===e) {
                renderirajListuKupovine();
            } else if ("ekran-povijest-kupovine"===e) {
                renderirajPovijestKupovine();
            }
        }


        function mapirajKodLancaUNaziv(e){if(!e)return"Nepoznato";const t={konzum:"Konzum",lidl:"Lidl",spar:"Spar",plodine:"Plodine",kaufland:"Kaufland",tommy:"Tommy",studenac:"Studenac",eurospin:"Eurospin",dm:"dm",ktc:"KTC",metro:"Metro",trgocentar:"Trgocentar",zabac:"콯abac",vrutak:"Vrutak",ribola:"Ribola",ntl:"NTL"};return t[e.toLowerCase()]||e.charAt(0).toUpperCase()+e.slice(1)}

        async function dohvatiITipkajTrgovine(){selectTrgovina.innerHTML='<option value="">U캛ITAVANJE...</option>',selectTrgovina.disabled=!0,btnPotvrdiTrgovinu.disabled=!0;try{const e=await fetch(`${API_BASE_URL}/v1/chains/`,{headers:{Authorization:`Bearer ${API_KEY}`}});if(!e.ok)throw new Error(`API gre코ka ${e.status}`);const t=await e.json();t.chains&&t.chains.length>0?(selectTrgovina.innerHTML='<option value="">-- IZABERI --</option>',t.chains.sort((e,t)=>mapirajKodLancaUNaziv(e).localeCompare(mapirajKodLancaUNaziv(t))).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=mapirajKodLancaUNaziv(e),selectTrgovina.appendChild(t)}),selectTrgovina.disabled=!1):selectTrgovina.innerHTML='<option value="">NEMA TRGOVINA.</option>'}catch(e){selectTrgovina.innerHTML='<option value="">GREKA.</option>',console.error(`U캛ITAVANJE TRGOVINA: ${e.message}`)}}

        function izracunajCijenuPoJM(cijena, kolicinaOriginal, jedinicaOriginal) {
            const cijenaFloat = parseFloat(cijena);
            let kolicina = parseFloat(String(kolicinaOriginal || "").replace(',', '.'));
            let jedinica = String(jedinicaOriginal || "").toLowerCase().trim().replace(/\.$/, '');

            if (isNaN(cijenaFloat) || isNaN(kolicina) || kolicina <= 0) return "N/A";

            const jediniceKomada = ['kom', 'komad', 'ko', '', 'rola', 'pak', 'tableta', 'kapsula', 'tbl', 'cap'];
            if (jediniceKomada.includes(jedinica)) {
                if (kolicina === 1 && (jedinica === "" || jedinica === "kom" || jedinica === "ko" || !jedinicaOriginal )) {
                     return `${cijenaFloat.toFixed(2)} EUR/KOM`;
                }
                if (kolicina > 0) return `${(cijenaFloat / kolicina).toFixed(2)} EUR/KOM`;
            }

            let cijenaPoOsnovnojJedinici = 0;
            let osnovnaJedinicaPrikaz = "";

            if (["g", "gr", "gram", "grama"].includes(jedinica)) {
                cijenaPoOsnovnojJedinici = (cijenaFloat / kolicina) * 1000; osnovnaJedinicaPrikaz = "KG";
            } else if (["kg", "kilogram", "kila", "k"].includes(jedinica)) {
                cijenaPoOsnovnojJedinici = cijenaFloat / kolicina; osnovnaJedinicaPrikaz = "KG";
            } else if (["ml", "mililitar"].includes(jedinica)) {
                cijenaPoOsnovnojJedinici = (cijenaFloat / kolicina) * 1000; osnovnaJedinicaPrikaz = "L";
            } else if (["l", "lit", "litra"].includes(jedinica)) {
                cijenaPoOsnovnojJedinici = cijenaFloat / kolicina; osnovnaJedinicaPrikaz = "L";
            } else {
                return `N/A (${jedinicaOriginal || 'nedostaje JM'})`;
            }

            if (isNaN(cijenaPoOsnovnojJedinici) || !isFinite(cijenaPoOsnovnojJedinici)) return "N/A (izra캜un)";
            return `${cijenaPoOsnovnojJedinici.toFixed(2)} EUR/${osnovnaJedinicaPrikaz}`;
        }


        function prikaziScanFeedback(e,t){pustiZvuk(e),scanFeedbackOverlay.textContent=t,scanFeedbackOverlay.className="show","ima"===e||"TRA콯IM..."===t ?scanFeedbackOverlay.classList.add("success"):scanFeedbackOverlay.classList.add("error"),setTimeout(()=>{scanFeedbackOverlay.classList.remove("show")},1500)}

        async function dohvatiPodatkeSkeniranogProizvoda(e,t,a=!1){
            if(!a && !pronadjiProizvodMode) {
                zadnjiSkeniraniProizvodInfo=null;
                clearSkenerMessages();
            }
            try{
                const n=a?`${API_BASE_URL}/v1/products/${e}/`:`${API_BASE_URL}/v1/products/${e}/?chains=${t}`,i=await fetch(n,{headers:{Authorization:`Bearer ${API_KEY}`}});
                if(!i.ok){
                    let errText=`GREKA (${i.status})`;404===i.status&&(errText="PROIZVOD NIJE PRONA캟EN.");
                    try{const detailJson=await i.json();errText+=`: ${detailJson.detail||""}`}catch(parseErr){}
                    throw new Error(errText);
                }
                const o=await i.json();
                if(a)return o;

                if(o.chains&&o.chains.length>0){
                    const productChainData=o.chains[0], cijena =parseFloat(productChainData.price || productChainData.min_price || productChainData.avg_price || productChainData.max_price);
                    if(isNaN(cijena)||cijena<=0)throw new Error("PROIZVOD PRONA캟EN, ALI CIJENA NIJE DOSTUPNA.");
                    prikaziScanFeedback("ima","U캛ITANO");
                    infoSkeniranogProizvodaContainer.classList.remove("hidden");
                    skeniranaKolicinaInput.value=1;
                    const nazivProizvoda=(productChainData.name||o.name||"Nepoznat naziv").toUpperCase();
                    skeniranNazivEl.textContent=nazivProizvoda;
                    skeniranaCijenaEl.textContent=cijena.toFixed(2);
                    skeniranaCijenaPoJediniciEl.textContent=izracunajCijenuPoJM(cijena,productChainData.quantity,productChainData.unit);
                    zadnjiSkeniraniProizvodInfo={ean:e,naziv:nazivProizvoda,cijenaKomad:cijena};
                    azurirajUkupnoZaSkeniranuStavku();
                    btnDodajSkeniranoNaListu.disabled=!1;
                    btnUsporediCijene.disabled=!1;
                } else {
                     throw new Error(`PROIZVOD NEMA PODATAKA ZA ${mapirajKodLancaUNaziv(t).toUpperCase()}`);
                }
            } catch(err) {
                if (!a && !pronadjiProizvodMode) {
                    prikaziScanFeedback("nema","NEPOZNATO");
                    infoSkeniranogProizvodaContainer.classList.add("hidden");
                    if (errorTextSkenerElem) errorTextSkenerElem.textContent=err.message.substring(0,100);
                }
                console.error("Dohva캖anje proizvoda gre코ka:",err);
                if (a) throw err;
                return null;
            }
        }

        function azurirajUkupnoZaSkeniranuStavku(){
            if(!zadnjiSkeniraniProizvodInfo) {
                if (skeniranItemUkupnoEl) skeniranItemUkupnoEl.textContent = "UKUPNO: 0.00 EUR";
                return;
            }
            const e=parseInt(skeniranaKolicinaInput.value)||0;
            if (skeniranItemUkupnoEl) skeniranItemUkupnoEl.textContent=`UKUPNO: ${(zadnjiSkeniraniProizvodInfo.cijenaKomad*e).toFixed(2)} EUR`;
        }

        function azurirajGumbNastavi(){
            if (zadnjeOdabranaTrgovinaKod) {
                btnNastaviZadnjaTrgovina.textContent = `NASTAVI S ${mapirajKodLancaUNaziv(zadnjeOdabranaTrgovinaNaziv)}`.toUpperCase();
                btnNastaviZadnjaTrgovina.classList.remove("hidden");
            } else {
                btnNastaviZadnjaTrgovina.classList.add("hidden");
            }
        }

        function postaviOdabranuTrgovinu(e,t){
            const a=trenutnoOdabranaTrgovina?trenutnoOdabranaTrgovina.code:null;
            trenutnoOdabranaTrgovina={code:e,name:t};
            localStorage.setItem(LS_KEYS.ZADNJA_TRGOVINA_KOD,e);
            localStorage.setItem(LS_KEYS.ZADNJA_TRGOVINA_NAZIV,t);
            zadnjeOdabranaTrgovinaKod=e;
            zadnjeOdabranaTrgovinaNaziv=t;
            azurirajGumbNastavi();
            const n=mapirajKodLancaUNaziv(t);
            infoOdabranaTrgovina.textContent=`TRGOVINA: ${n.toUpperCase()}`;

            if (statusTextSkenerElem && ekranSkeniranja && !ekranSkeniranja.classList.contains("hidden") && !pronadjiProizvodMode) {
                 statusTextSkenerElem.textContent = `${n.toUpperCase()} SKENIRAJTE BARKOD`;
            }
            if(a!==e && a!==null && !pronadjiProizvodMode){
                trenutnaListaKupovine=[];
                zadnjiSkeniraniProizvodInfo=null;
                infoSkeniranogProizvodaContainer.classList.add("hidden");
                azurirajPrikazSumarneListe();
            }
        }

        function clearSkenerMessages(){
            if (statusTextSkenerElem) {
                if (pronadjiProizvodMode) {
                    statusTextSkenerElem.textContent = "PRONA캟I PROIZVOD: SKENIRAJTE BARKOD";
                } else if (trenutnoOdabranaTrgovina && (isScannerRunning || (!isScannerRunning && !btnPokreniZaustaviSkener.classList.contains('hidden'))) ) {
                    statusTextSkenerElem.textContent = `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENIRAJTE BARKOD`;
                } else if (trenutnoOdabranaTrgovina && ekranSkeniranja && !ekranSkeniranja.classList.contains("hidden")) {
                    statusTextSkenerElem.textContent = `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENIRAJTE BARKOD`;
                }
            }
            if(errorTextSkenerElem) errorTextSkenerElem.textContent = "";
        }


        async function onScanSuccess(decodedText, decodedResult){
            await stopSkener();

            if (pronadjiProizvodMode) {
                prikaziScanFeedback("ima", "TRA콯IM...");
                try {
                    const productData = await dohvatiPodatkeSkeniranogProizvoda(decodedText, null, true);
                    if (productData && (productData.name || (productData.chains && productData.chains.length > 0))) {
                       prikaziRezultatePretrageProizvoda(productData);
                    } else {
                       prikaziScanFeedback("nema", "NEMA PODATAKA");
                       if (errorTextSkenerElem) errorTextSkenerElem.textContent = "PROIZVOD NIJE PRONA캟EN ILI NEMA CIJENA.";
                       if (statusTextSkenerElem) statusTextSkenerElem.textContent = "PRONA캟I PROIZVOD: POKUㅁJTE PONOVO SKENIRATI.";
                       btnPokreniZaustaviSkener.classList.remove('hidden');
                       btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                    }
                } catch (error) {
                    prikaziScanFeedback("nema", "GREKA");
                    if (errorTextSkenerElem) errorTextSkenerElem.textContent = `GREKA: ${error.message}`;
                    if (statusTextSkenerElem) statusTextSkenerElem.textContent = "PRONA캟I PROIZVOD: GREKA, POKUㅁJTE PONOVO SKENIRATI.";
                    btnPokreniZaustaviSkener.classList.remove('hidden');
                    btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                }
            } else {
                if (trenutnoOdabranaTrgovina?.code) {
                    dohvatiPodatkeSkeniranogProizvoda(decodedText,trenutnoOdabranaTrgovina.code, false);
                } else {
                    alert("NIJE ODABRANA TRGOVINA!");
                    prikaziEkran("ekran-odabir-trgovine");
                    dohvatiITipkajTrgovine();
                }
            }
        }
        function onScanFailure(e){}

        async function initializeAndStartScanner(requestedCameraId = null) {
            if (isScannerRunning && html5QrCode?.getState() === 2) return;
            if (isScannerRunning) await stopSkener(true);

            if (statusTextSkenerElem) statusTextSkenerElem.textContent = "INICIJALIZACIJA...";
            if (errorTextSkenerElem) errorTextSkenerElem.textContent = "";
            readerDiv.innerHTML = "";
            switchCameraButton.style.display = "none";
            cameraSelectionOverlay.style.display = "none";
            if (!pronadjiProizvodMode) infoSkeniranogProizvodaContainer.classList.add("hidden");

            btnPokreniZaustaviSkener.classList.add('hidden');
            btnPokreniZaustaviSkener.classList.remove('animacija-tekst-zuto');

            if (!html5QrCode) html5QrCode = new Html5Qrcode(readerDiv.id);
            const qrConfig = { fps: 10, qrbox: (w, h) => ({ width: Math.max(200, Math.min(w*0.75, h*0.75, 300)), height: Math.max(200, Math.min(w*0.75, h*0.75, 300)) })};

            try {
                if (availableCameras.length === 0 && Html5Qrcode.getCameras) {
                    if (statusTextSkenerElem) statusTextSkenerElem.textContent = "DOHVA캕AM KAMERE...";
                    availableCameras = await Html5Qrcode.getCameras() || [];
                    if (availableCameras.length === 0) throw new Error("NEMA DOSTUPNIH KAMERA.");
                }

                let cameraIdToUse = requestedCameraId || localStorage.getItem(LS_KEYS.CAMERA_ID);
                if (!cameraIdToUse || !availableCameras.some(cam => cam.id === cameraIdToUse)) {
                    const rearCamera = availableCameras.find(cam => cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("zadnja"));
                    cameraIdToUse = rearCamera ? rearCamera.id : availableCameras[0]?.id;
                }
                if (!cameraIdToUse) throw new Error("KAMERA NIJE ODABRANA ILI DOSTUPNA.");

                if (statusTextSkenerElem) statusTextSkenerElem.textContent = "POKRETANJE KAMERE...";
                await html5QrCode.start(cameraIdToUse, qrConfig, onScanSuccess, onScanFailure);
                isScannerRunning = true;
                localStorage.setItem(LS_KEYS.CAMERA_ID, cameraIdToUse);
                clearSkenerMessages();
                if (availableCameras.length > 1) switchCameraButton.style.display = "block";
            } catch (err) {
                isScannerRunning = false;
                btnPokreniZaustaviSkener.textContent = "PONOVO POKRENI SKENER";
                btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                btnPokreniZaustaviSkener.classList.remove('hidden');
                if (errorTextSkenerElem) errorTextSkenerElem.textContent = `GREKA KAMERE: ${err.name || err.message}`;
                if (String(err).includes("NotAllowedError") && errorTextSkenerElem) errorTextSkenerElem.textContent += " PROVJERITE DOZVOLE.";
                if (html5QrCode && html5QrCode.getState() === 2) {
                    try { await html5QrCode.stop(); } catch (stopErr) { console.error("Gre코ka zaustavljanja kamere:", stopErr); }
                }
                 if (statusTextSkenerElem) {
                    if (pronadjiProizvodMode) statusTextSkenerElem.textContent = "PRONA캟I PROIZVOD: GREKA KAMERE.";
                    else if (trenutnoOdabranaTrgovina) statusTextSkenerElem.textContent = `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} - GREKA KAMERE`;
                    else statusTextSkenerElem.textContent = "GREKA PRI POKRETANJU KAMERE.";
                }
            }
        }

        async function stopSkener(napustanjeEkrana = false) {
            if (!isScannerRunning || !html5QrCode) {
                isScannerRunning = false;
                if (!napustanjeEkrana && ekranSkeniranja && !ekranSkeniranja.classList.contains('hidden')) {
                    btnPokreniZaustaviSkener.textContent = "PONOVO POKRENI SKENER";
                    btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                    btnPokreniZaustaviSkener.classList.remove('hidden');
                } else {
                    btnPokreniZaustaviSkener.classList.add('hidden');
                }
                return;
            }
            try {
                if (html5QrCode.getState() === 2) await html5QrCode.stop();
            } catch (e) { console.error("Gre코ka zaustavljanja skenera:", e);
            } finally {
                isScannerRunning = false;
                if (!napustanjeEkrana && ekranSkeniranja && !ekranSkeniranja.classList.contains('hidden')) {
                    btnPokreniZaustaviSkener.textContent = "PONOVO POKRENI SKENER";
                    btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                    btnPokreniZaustaviSkener.classList.remove('hidden');
                    if (statusTextSkenerElem) {
                         if (pronadjiProizvodMode) statusTextSkenerElem.textContent = "SKENER ZAUSTAVLJEN. POKUㅁJTE PONOVO ILI UPIITE NAZIV.";
                        else if (trenutnoOdabranaTrgovina) statusTextSkenerElem.textContent = `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENER ZAUSTAVLJEN.`;
                        else statusTextSkenerElem.textContent = "SKENER ZAUSTAVLJEN.";
                    }
                } else {
                     btnPokreniZaustaviSkener.classList.add('hidden');
                }
                if (switchCameraButton) switchCameraButton.style.display = "none";
                if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = "none";
            }
        }

        function toggleCameraSelection(){if("block"===cameraSelectionOverlay.style.display)return void(cameraSelectionOverlay.style.display="none");if(availableCameras.length<=1)return;cameraListUl.innerHTML="";const e=localStorage.getItem(LS_KEYS.CAMERA_ID);availableCameras.forEach(t=>{const a=document.createElement("li");a.textContent=t.label||`KAMERA ${t.id.substring(0,8)}...`,a.dataset.cameraId=t.id,t.id===e&&a.classList.add("selected-camera"),a.addEventListener("click",async()=>{pustiZvuk("klik"); cameraSelectionOverlay.style.display="none"; if(t.id===e&&isScannerRunning) return; await stopSkener(true); initializeAndStartScanner(t.id);}),cameraListUl.appendChild(a)}),cameraSelectionOverlay.style.display="block"}

        function dodajProizvodNaListu(){
            if(!zadnjiSkeniraniProizvodInfo)return;
            const e=parseInt(skeniranaKolicinaInput.value);
            if(isNaN(e)||e<=0)return void alert("UNESITE ISPRAVNU KOLI캛INU.");
            const t=trenutnaListaKupovine.find(e=>e.ean===zadnjiSkeniraniProizvodInfo.ean);
            t?t.kolicina+=e:trenutnaListaKupovine.push({...zadnjiSkeniraniProizvodInfo,kolicina:e});
            infoSkeniranogProizvodaContainer.classList.add("hidden");
            zadnjiSkeniraniProizvodInfo=null;
            if(errorTextSkenerElem) errorTextSkenerElem.textContent = "";
            if (statusTextSkenerElem) statusTextSkenerElem.textContent="DODAN NA LISTU!";
            setTimeout(()=>{ if (statusTextSkenerElem && statusTextSkenerElem.textContent==="DODAN NA LISTU!") clearSkenerMessages(); },1500);
            azurirajPrikazSumarneListe();
        }

        function obrisiStavkuSaListe(e){trenutnaListaKupovine=trenutnaListaKupovine.filter(t=>t.ean!==e),renderirajListuKupovine(),azurirajPrikazSumarneListe()}
        function izracunajUkupnuCijenuListe(){return trenutnaListaKupovine.reduce((e,t)=>e+t.cijenaKomad*t.kolicina,0)}
        function azurirajPrikazSumarneListe(){
            if (pronadjiProizvodMode) {
                if (listaSummaryContainer) listaSummaryContainer.classList.add("hidden");
                return;
            }
            const e=izracunajUkupnuCijenuListe();
            if (ukupnoCijenaSkeniranjeSumEl) ukupnoCijenaSkeniranjeSumEl.textContent=e.toFixed(2);
            if (listaSummaryContainer) listaSummaryContainer.classList.toggle("hidden",0===trenutnaListaKupovine.length);
        }
        function renderirajListuKupovine(){ukupnoCijenaListaPrikazEl.textContent=izracunajUkupnuCijenuListe().toFixed(2),listaKupovineStavkeContainer.innerHTML="",praznaListaPorukaEl.classList.toggle("hidden",trenutnaListaKupovine.length>0),trenutnaListaKupovine.forEach(e=>{const t=document.createElement("div");t.className="stavka-liste",t.innerHTML=`<div class="stavka-liste-info"><div class="stavka-naziv">${e.naziv.toUpperCase()}</div><div class="stavka-detalji">${e.kolicina} X ${e.cijenaKomad.toFixed(2)} EUR</div></div><div class="stavka-ukupno">${(e.cijenaKomad*e.kolicina).toFixed(2)} EUR</div><button class="btn-brisi-stavku" data-ean="${e.ean}">X</button>`,listaKupovineStavkeContainer.appendChild(t)})}
        function spremiTrenutnuKupovinu(){if(0===trenutnaListaKupovine.length||!trenutnoOdabranaTrgovina)return;const e={id:generirajUUID(),datum:(new Date).toISOString(),trgovinaKod:trenutnoOdabranaTrgovina.code,trgovinaNaziv:mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name),stavke:JSON.parse(JSON.stringify(trenutnaListaKupovine)),ukupanIznos:izracunajUkupnuCijenuListe()};povijestKupovina.unshift(e),povijestKupovina.length>MAX_POVIJEST_KUPVINA&&povijestKupovina.pop(),localStorage.setItem(LS_KEYS.POVIJEST_KUPOVINA,JSON.stringify(povijestKupovina))}
        function renderirajPovijestKupovine(){povijestKupovineContainer.innerHTML="";const e=povijestKupovina.length>0;praznaPovijestPorukaEl.classList.toggle("hidden",e),btnOcistiPovijest.classList.toggle("hidden",!e),povijestKupovina.forEach(e=>{const t=document.createElement("div");t.className="povijest-stavka",t.dataset.kupovinaId=e.id;const a=new Date(e.datum).toLocaleString("hr-HR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});t.innerHTML=`<div class="povijest-stavka-info"><div class="stavka-naziv">${a} - ${e.trgovinaNaziv.toUpperCase()}</div></div><div class="povijest-iznos">${e.ukupanIznos.toFixed(2)} EUR</div>`,povijestKupovineContainer.appendChild(t)})}
        function prikaziSpecifikacijuKupovine(e){const t=povijestKupovina.find(t=>t.id===e);if(!t)return;trenutnoPrikazanaKupovinaId=e;const a=new Date(t.datum).toLocaleString("hr-HR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});specifikacijaNaslovEl.textContent=`KUPOVINA (${a})`,specifikacijaUkupnoEl.textContent=`UKUPNO: ${t.ukupanIznos.toFixed(2)} EUR`,specifikacijaStavkeContainer.innerHTML="",t.stavke.forEach(e=>{const t=document.createElement("div");t.className="stavka-liste",t.innerHTML=`<div class="stavka-liste-info"><div class="stavka-naziv">${e.naziv.toUpperCase()}</div><div class="stavka-detalji">${e.kolicina} X ${e.cijenaKomad.toFixed(2)} EUR</div></div><div class="stavka-ukupno">${(e.cijenaKomad*e.kolicina).toFixed(2)} EUR</div>`,specifikacijaStavkeContainer.appendChild(t)}),prikaziEkran("ekran-specifikacija-kupovine")}
        async function prikaziUsporedbuCijena(){
            if(!zadnjiSkeniraniProizvodInfo||!trenutnoOdabranaTrgovina)return;
            prikaziEkran("ekran-usporedbe-cijena");
            usporedbaArtiklNazivEl.textContent=zadnjiSkeniraniProizvodInfo.naziv.toUpperCase();
            const e=zadnjiSkeniraniProizvodInfo.cijenaKomad;
            usporedbaArtiklCijenaTrenutnaEl.textContent=`CIJENA U ${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()}: ${e.toFixed(2)} EUR`;
            usporedbaCijenaContainer.innerHTML='<p style="text-align:center; color:#6c757d;">U캛ITAVAM...</p>';
            usporedbaNemaPodatakaPorukaEl.classList.add("hidden");
            try{
                const t=await dohvatiPodatkeSkeniranogProizvoda(zadnjiSkeniraniProizvodInfo.ean,null,!0);
                if(!t?.chains?.length)throw new Error("NEMA PODATAKA U DRUGIM TRGOVINAMA.");
                const a=t.chains.filter(chain =>
                    chain.chain !== trenutnoOdabranaTrgovina.code &&
                    (parseFloat(chain.price || chain.min_price) > 0)
                ).sort((chainA,chainB)=>(parseFloat(chainA.price||chainA.min_price))-(parseFloat(chainB.price||chainB.min_price)));

                if(0===a.length)throw new Error("NEMA PODATAKA U DRUGIM TRGOVINAMA.");
                usporedbaCijenaContainer.innerHTML="";
                a.forEach(chainData=>{
                    const cijenaUsporedba=parseFloat(chainData.price||chainData.min_price);
                    let klasaCijene="";
                    cijenaUsporedba<e?klasaCijene="cijena-jeftinije":cijenaUsporedba>e&&(klasaCijene="cijena-skuplje");
                    const itemDiv=document.createElement("div");
                    itemDiv.className="usporedba-stavka";
                    itemDiv.innerHTML=`<div class="usporedba-stavka-info"><div class="stavka-naziv">${mapirajKodLancaUNaziv(chainData.chain).toUpperCase()}</div></div><div class="usporedba-cijena ${klasaCijene}">${cijenaUsporedba.toFixed(2)} EUR</div>`;
                    usporedbaCijenaContainer.appendChild(itemDiv);
                });
            }catch(err){
                usporedbaCijenaContainer.innerHTML="";
                usporedbaNemaPodatakaPorukaEl.textContent=err.message.toUpperCase();
                usporedbaNemaPodatakaPorukaEl.classList.remove("hidden");
            }
        }

        function prikaziRezultatePretrageProizvoda(productData) {
            pronadjiProizvodMode = false;
            prikaziEkran("ekran-pronadji-proizvod-rezultati");
            pronadjiRezultatiArtiklNazivEl.textContent = (productData.name || "Nepoznat Proizvod").toUpperCase();
            pronadjiRezultatiListaContainer.innerHTML = '';
            pronadjiRezultatiNemaPodatakaPorukaEl.classList.add("hidden");

            if (!productData.chains || productData.chains.length === 0) {
                pronadjiRezultatiNemaPodatakaPorukaEl.textContent = "NEMA DOSTUPNIH PODATAKA O CIJENAMA ZA OVAJ PROIZVOD.";
                pronadjiRezultatiNemaPodatakaPorukaEl.classList.remove("hidden");
                return;
            }

            const trgovineSCijenom = productData.chains
                .map(chain => ({ ...chain, cijena: parseFloat(chain.price || chain.min_price || chain.avg_price) || 0 }))
                .filter(chain => chain.cijena > 0)
                .sort((a, b) => a.cijena - b.cijena);

            if (trgovineSCijenom.length === 0) {
                pronadjiRezultatiNemaPodatakaPorukaEl.textContent = "NEMA DOSTUPNIH CIJENA U TRGOVINAMA ZA OVAJ PROIZVOD.";
                pronadjiRezultatiNemaPodatakaPorukaEl.classList.remove("hidden");
                return;
            }

            trgovineSCijenom.forEach((chainData, index) => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "pronadji-rezultati-stavka";
                let cijenaKlasa = index === 0 ? "cijena-najjeftinije" : "";
                itemDiv.innerHTML = `
                    <div class="pronadji-rezultati-stavka-info">
                        <div class="stavka-naziv">${mapirajKodLancaUNaziv(chainData.chain).toUpperCase()}</div>
                        ${chainData.quantity && chainData.unit ? `<div class="stavka-detalji">PAKIRANJE: ${chainData.quantity} ${chainData.unit}</div>` : ''}
                        <div class="stavka-detalji">${izracunajCijenuPoJM(chainData.cijena, chainData.quantity, chainData.unit)}</div>
                    </div>
                    <div class="pronadji-rezultati-cijena ${cijenaKlasa}">${chainData.cijena.toFixed(2)} EUR</div>`;
                pronadjiRezultatiListaContainer.appendChild(itemDiv);
            });
        }

        function normalizirajPakiranje(kolicinaInput, jedinicaInput) {
            let kolicina = parseFloat(String(kolicinaInput || "0").replace(',', '.'));
            let jedinica = String(jedinicaInput || "").toLowerCase().trim().replace(/\.$/, '');

            let kljucZaFilter = null;
            let prikazZaFilterGumb = null;
            let sortVrijednost = Infinity;
            let tipJedinice = 'neispravno';

            if (isNaN(kolicina) || kolicina < 0) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };

            const jediniceMaseKg = ['kg', 'kilogram', 'kila', 'k'];
            const jediniceMaseG = ['g', 'gr', 'gram', 'grama'];
            const jediniceVolumenaL = ['l', 'lit', 'litra'];
            const jediniceVolumenaMl = ['ml', 'mililitar'];
            const jediniceKomada = ['kom', 'komad', 'ko', '', 'rola', 'pak', 'tableta', 'kapsula', 'tbl', 'cap'];

            if (kolicina === 0 && !jediniceKomada.includes(jedinica) && jedinica !=='') return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };


            if (jediniceMaseKg.includes(jedinica)) {
                const grami = Math.round(kolicina * 1000);
                if (grami <= 0 && kolicina > 0) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
                kljucZaFilter = `${grami}g`;
                prikazZaFilterGumb = (kolicina >= 1 && kolicina % 1 === 0) ? `${Math.round(kolicina)} kg` : (kolicina < 1 && grami > 0 ? `${grami} g` : `${kolicina.toLocaleString(undefined, {minimumFractionDigits: (kolicina % 1 === 0 ? 0 : 1), maximumFractionDigits: 3})} kg`);
                if (grami === 0 && kolicina === 0) prikazZaFilterGumb = `0 kg`; // npr. za unos 0 kg
                sortVrijednost = grami; tipJedinice = 'masa';
            } else if (jediniceMaseG.includes(jedinica)) {
                const grami = Math.round(kolicina);
                if (grami <= 0 && kolicina > 0) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
                kljucZaFilter = `${grami}g`;
                prikazZaFilterGumb = grami < 1000 ? `${grami} g` : `${(grami/1000).toLocaleString(undefined, {minimumFractionDigits: ( (grami/1000) % 1 === 0 ? 0 : 1), maximumFractionDigits: 3})} kg`;
                if (grami === 0 && kolicina === 0) prikazZaFilterGumb = `0 g`;
                sortVrijednost = grami; tipJedinice = 'masa';
            } else if (jediniceVolumenaL.includes(jedinica)) {
                const ml = Math.round(kolicina * 1000);
                if (ml <= 0 && kolicina > 0) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
                kljucZaFilter = `${ml}ml`;
                prikazZaFilterGumb = (kolicina >= 1 && kolicina % 1 === 0) ? `${Math.round(kolicina)} L` : (kolicina < 1 && ml > 0 ? `${ml} ml` : `${kolicina.toLocaleString(undefined, {minimumFractionDigits: (kolicina % 1 === 0 ? 0 : 1), maximumFractionDigits: 3})} L`);
                if (ml === 0 && kolicina === 0) prikazZaFilterGumb = `0 L`;
                sortVrijednost = ml; tipJedinice = 'volumen';
            } else if (jediniceVolumenaMl.includes(jedinica)) {
                const ml = Math.round(kolicina);
                 if (ml <= 0 && kolicina > 0) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
                kljucZaFilter = `${ml}ml`;
                prikazZaFilterGumb = ml < 1000 ? `${ml} ml` : `${(ml/1000).toLocaleString(undefined, {minimumFractionDigits: ( (ml/1000) % 1 === 0 ? 0 : 1), maximumFractionDigits: 3})} L`;
                if (ml === 0 && kolicina === 0) prikazZaFilterGumb = `0 ml`;
                sortVrijednost = ml; tipJedinice = 'volumen';
            } else if (jediniceKomada.includes(jedinica)) {
                const kom = Math.round(kolicina);
                if (kom <= 0 && kolicina !==0 ) return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
                // Za "0 kom" ne캖emo kreirati filter opciju ako je eksplicitno 0 kom
                if (kom === 0) return { kljucZaFilter: null, prikazZaFilterGumb: null, sortVrijednost: Infinity, tipJedinice: 'neispravno' };

                let specificnaJedinicaKomada = 'kom';
                prikazZaFilterGumb = `${kom} kom`;
                if (['rola', 'pak', 'tableta', 'tbl', 'kapsula', 'cap'].includes(jedinica)) {
                    specificnaJedinicaKomada = (jedinica === 'tbl') ? 'tableta' : (jedinica === 'cap') ? 'kapsula' : jedinica;
                    prikazZaFilterGumb = `${kom} ${specificnaJedinicaKomada}`;
                    if (specificnaJedinicaKomada === 'tableta') prikazZaFilterGumb = `${kom} tab.`;
                    else if (specificnaJedinicaKomada === 'kapsula') prikazZaFilterGumb = `${kom} kap.`;
                } else if (jedinica === '') specificnaJedinicaKomada = 'kom';

                kljucZaFilter = `${kom}${specificnaJedinicaKomada}`;
                sortVrijednost = kom; tipJedinice = 'komad';
            } else {
                 if (kolicina > 0 && jedinica !== '') {
                    kljucZaFilter = `${kolicina}${jedinica}`;
                    prikazZaFilterGumb = `${kolicina.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2})} ${jedinica}`;
                    sortVrijednost = kolicina; tipJedinice = 'ostalo';
                } else {
                    return { kljucZaFilter: null, prikazZaFilterGumb: null, sortVrijednost: Infinity, tipJedinice: 'neispravno' };
                }
            }

            if (kljucZaFilter === null) return { kljucZaFilter: null, prikazZaFilterGumb: null, sortVrijednost: Infinity, tipJedinice: 'neispravno' };

            const MAX_MASA_G = 100000, MAX_VOLUMEN_ML = 100000, MAX_KOMADA = 2000;
             if ( (tipJedinice === 'masa' && sortVrijednost > MAX_MASA_G) ||
                 (tipJedinice === 'volumen' && sortVrijednost > MAX_VOLUMEN_ML) ||
                 (tipJedinice === 'komad' && sortVrijednost > MAX_KOMADA) ||
                 (sortVrijednost < 0.001 && tipJedinice !== 'neispravno' && !(kolicina === 0 && (jediniceMaseG.includes(jedinica) || jediniceVolumenaMl.includes(jedinica) || jediniceMaseKg.includes(jedinica) || jediniceVolumenaL.includes(jedinica)) ))
                ) { // Izbjegavaj ekstremno male vrijednosti osim ako su stvarno 0 za masu/volumen
                 return { kljucZaFilter: null, prikazZaFilterGumb: null, sortVrijednost: Infinity, tipJedinice: 'neispravno' };
            }
            return { kljucZaFilter, prikazZaFilterGumb, sortVrijednost, tipJedinice };
        }


        function izvuciOpcijeFiltera(proizvodi, aktivniFilteri = {}) {
            const opcijeMap = { pakiranjeKljuc: new Map(), brand: new Map() };

            // Filtriraj proizvode na temelju SVIH aktivnih filtera da dobije코 trenutno relevantne proizvode
            const relevantniProizvodi = originalniRezultatiPretrageNazivom.filter(p => {
                for (const aktivniTip in aktivniFilteri) {
                    if (p[aktivniTip] !== aktivniFilteri[aktivniTip]) return false;
                }
                return true;
            });

            // Generiraj opcije za PAKIRANJE iz relevantnih proizvoda
            // (ali ako je pakiranje ve캖 aktivni filter, prika쬴 sve opcije pakiranja iz proizvoda koji odgovaraju ostalim aktivnim filterima)
            let proizvodiZaPakFilter = originalniRezultatiPretrageNazivom;
            if (aktivniFilteri.brand) {
                proizvodiZaPakFilter = proizvodiZaPakFilter.filter(p => p.brand === aktivniFilteri.brand);
            }
            proizvodiZaPakFilter.forEach(stavka => {
                if (stavka.pakiranjeKljuc && stavka.pakiranjePrikaz && !opcijeMap.pakiranjeKljuc.has(stavka.pakiranjeKljuc)) {
                    opcijeMap.pakiranjeKljuc.set(stavka.pakiranjeKljuc, {
                        kljuc: stavka.pakiranjeKljuc, prikaz: stavka.pakiranjePrikaz,
                        sort: stavka.pakiranjeSortVrijednost, tip: stavka.pakiranjeTipJedinice
                    });
                }
            });

            // Generiraj opcije za BRAND iz relevantnih proizvoda
            // (ali ako je brand ve캖 aktivni filter, prika쬴 sve opcije branda iz proizvoda koji odgovaraju ostalim aktivnim filterima)
            let proizvodiZaBrandFilter = originalniRezultatiPretrageNazivom;
            if (aktivniFilteri.pakiranjeKljuc) {
                proizvodiZaBrandFilter = proizvodiZaBrandFilter.filter(p => p.pakiranjeKljuc === aktivniFilteri.pakiranjeKljuc);
            }
             proizvodiZaBrandFilter.forEach(stavka => {
                if (stavka.brand && !opcijeMap.brand.has(stavka.brand)) {
                    opcijeMap.brand.set(stavka.brand, { kljuc: stavka.brand, prikaz: stavka.brand, sort: stavka.brand });
                }
            });


            const formatirajOpcije = (map, sortFn) => {
                return Array.from(map.values())
                        .filter(val => val.kljuc != null && val.prikaz != null && val.tip !== 'neispravno')
                        .sort(sortFn);
            };

            return {
                pakiranje: formatirajOpcije(opcijeMap.pakiranjeKljuc, (a, b) => {
                    const tipOrder = { 'masa': 1, 'volumen': 2, 'komad': 3, 'ostalo': 4 };
                    if ((tipOrder[a.tip] || 5) !== (tipOrder[b.tip] || 5) ) {
                        return (tipOrder[a.tip] || 5) - (tipOrder[b.tip] || 5);
                    }
                    return a.sort - b.sort;
                }),
                brand: formatirajOpcije(opcijeMap.brand, (a,b) => String(a.prikaz).localeCompare(String(b.prikaz)))
            };
        }


        function prikaziFiltere(opcije) {
            filteriContainer.innerHTML = '';
            let imaLiFiltera = false;

            const createFilterGroup = (tipAtributaStavke, labela, vrijednostiObjekata) => {
                if (!vrijednostiObjekata || vrijednostiObjekata.length === 0) return;
                const validneVrijednosti = vrijednostiObjekata.filter(v => v.kljuc != null && v.prikaz != null);
                if (validneVrijednosti.length === 0) return;

                imaLiFiltera = true;
                const grupaDiv = document.createElement('div');
                grupaDiv.className = 'filter-grupa';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'filter-label';
                labelSpan.textContent = labela + ':';
                grupaDiv.appendChild(labelSpan);
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'filter-opcije-wrapper';

                validneVrijednosti.forEach(valObj => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-opcija';
                    btn.textContent = valObj.prikaz;
                    btn.dataset.filterType = tipAtributaStavke;
                    btn.dataset.filterValue = valObj.kljuc;
                    if (aktivniFilteriPretrageNazivom[tipAtributaStavke] === valObj.kljuc) {
                        btn.classList.add('aktivan');
                    }
                    wrapperDiv.appendChild(btn);
                });
                grupaDiv.appendChild(wrapperDiv);
                filteriContainer.appendChild(grupaDiv);
            };

            if (opcije.pakiranje) createFilterGroup('pakiranjeKljuc', 'Pakiranje', opcije.pakiranje);
            if (opcije.brand) createFilterGroup('brand', 'Brand', opcije.brand);

            filteriContainer.style.display = imaLiFiltera ? 'block' : 'none';
        }


        function primijeniFiltereNaRezultate() {
            if (originalniRezultatiPretrageNazivom.length === 0 && inputPretragaNaziv.value.length < MIN_SEARCH_QUERY_LENGTH) {
                 rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UPIITE POJAM ZA PRETRAGU (MIN. ${MIN_SEARCH_QUERY_LENGTH} ZNAKA).</p>`;
                 prikaziFiltere(izvuciOpcijeFiltera([], aktivniFilteriPretrageNazivom));
                return;
            }
             if (originalniRezultatiPretrageNazivom.length === 0) {
                iscrtajRezultatePretrageNazivom([]);
                prikaziFiltere(izvuciOpcijeFiltera([], aktivniFilteriPretrageNazivom));
                return;
            }

            let filtriraniRezultati = originalniRezultatiPretrageNazivom.filter(stavka => {
                for (const tipFiltera in aktivniFilteriPretrageNazivom) {
                    const aktivnaVrijednostFiltera = aktivniFilteriPretrageNazivom[tipFiltera];
                    if (aktivnaVrijednostFiltera) {
                        if (stavka[tipFiltera] !== aktivnaVrijednostFiltera) return false;
                    }
                }
                return true;
            });
            iscrtajRezultatePretrageNazivom(filtriraniRezultati);

            const noveOpcijeZaGumbe = izvuciOpcijeFiltera(originalniRezultatiPretrageNazivom, aktivniFilteriPretrageNazivom);
            prikaziFiltere(noveOpcijeZaGumbe);
        }


        function iscrtajRezultatePretrageNazivom(proizvodiZaPrikaz) {
            rezultatiPretrageNazivomContainer.innerHTML = '';
             if (inputPretragaNaziv.value.length < MIN_SEARCH_QUERY_LENGTH && !proizvodiZaPrikaz.length) {
                rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UPIITE POJAM ZA PRETRAGU (MIN. ${MIN_SEARCH_QUERY_LENGTH} ZNAKA).</p>`;
                return;
            }
            if (proizvodiZaPrikaz.length === 0) {
                if (inputPretragaNaziv.value.length >= MIN_SEARCH_QUERY_LENGTH) {
                    rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">NEMA REZULTATA ZA ODABRANE FILTERE.</p>`;
                } else {
                     rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UPIITE POJAM ZA PRETRAGU (MIN. ${MIN_SEARCH_QUERY_LENGTH} ZNAKA).</p>`;
                }
                return;
            }

            proizvodiZaPrikaz.forEach(stavka => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "pretraga-nazivom-stavka";
                itemDiv.innerHTML = `
                    <div class="pretraga-nazivom-stavka-info">
                        <div class="pretraga-nazivom-ducan">${stavka.nazivLanca}</div>
                        <div class="pretraga-nazivom-naziv-proizvoda">${stavka.nazivProizvoda}</div>
                        <div class="pretraga-nazivom-detalji">${stavka.pakiranjeDetalji}</div>
                        <div class="pretraga-nazivom-detalji">${stavka.cijenaPoJM}</div>
                    </div>
                    <div class="pretraga-nazivom-cijena">${stavka.cijena.toFixed(2)} EUR</div>
                `;
                rezultatiPretrageNazivomContainer.appendChild(itemDiv);
            });
        }


        async function izvrsiPretraguPoNazivu(query) {
            aktivniFilteriPretrageNazivom = {};

            if (query.length < MIN_SEARCH_QUERY_LENGTH) {
                filteriContainer.innerHTML = '';
                filteriContainer.style.display = 'none';
                originalniRezultatiPretrageNazivom = [];
                rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UNESITE BAREM ${MIN_SEARCH_QUERY_LENGTH} ZNAKA ZA PRETRAGU.</p>`;
                return;
            }

            rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">TRA콯IM PROIZVODE...</p>`;
            filteriContainer.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/v1/products/?q=${encodeURIComponent(query)}&limit=250`, {
                    headers: { Authorization: `Bearer ${API_KEY}` }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({detail: `API GREKA ${response.status}`}));
                    throw new Error(errorData.detail || `API GREKA ${response.status}`);
                }
                const data = await response.json();
                originalniRezultatiPretrageNazivom = [];

                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        if (product.chains && product.chains.length > 0) {
                            product.chains.forEach(chain => {
                                const cijena = parseFloat(chain.price || chain.min_price || chain.avg_price);
                                const kolicina = product.quantity || chain.quantity;
                                const jedinica = product.unit || chain.unit;
                                const normPak = normalizirajPakiranje(kolicina, jedinica);

                                if (cijena > 0 && normPak.kljucZaFilter !== null) {
                                    originalniRezultatiPretrageNazivom.push({
                                        idProizvoda: product.ean + '-' + chain.chain, ean: product.ean,
                                        nazivLanca: mapirajKodLancaUNaziv(chain.chain).toUpperCase(),
                                        nazivProizvoda: `${(product.name || "Nepoznato").toUpperCase()} ${product.brand ? '('+product.brand.toUpperCase()+')' : ''}`,
                                        pakiranjeKljuc: normPak.kljucZaFilter, pakiranjePrikaz: normPak.prikazZaFilterGumb,
                                        pakiranjeSortVrijednost: normPak.sortVrijednost, pakiranjeTipJedinice: normPak.tipJedinice,
                                        pakiranjeDetalji: `PAKIRANJE: ${normPak.prikazZaFilterGumb || (kolicina + ' ' + jedinica)}`,
                                        cijena: cijena, cijenaPoJM: izracunajCijenuPoJM(cijena, kolicina, jedinica),
                                        brand: product.brand ? product.brand.toUpperCase() : null,
                                    });
                                }
                            });
                        }
                    });
                    originalniRezultatiPretrageNazivom.sort((a, b) => a.cijena - b.cijena);
                }

                if (originalniRezultatiPretrageNazivom.length > 0) {
                    iscrtajRezultatePretrageNazivom(originalniRezultatiPretrageNazivom);
                    const opcijeFiltera = izvuciOpcijeFiltera(originalniRezultatiPretrageNazivom, {});
                    prikaziFiltere(opcijeFiltera);
                } else {
                    rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">NEMA REZULTATA ZA TRA콯ENI POJAM.</p>`;
                    filteriContainer.style.display = 'none';
                }
            } catch (error) {
                console.error("Gre코ka pretrage po nazivu:", error);
                rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#dc3545; margin-top:20px;">GREKA PRI PRETRAZI: ${error.message}</p>`;
                filteriContainer.style.display = 'none';
            }
        }

        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        const debouncedSearch = debounce(izvrsiPretraguPoNazivu, DEBOUNCE_DELAY);


        async function prikaziUsporedbuKosarice(){if(!trenutnoPrikazanaKupovinaId)return;const e=povijestKupovina.find(e=>e.id===trenutnoPrikazanaKupovinaId);if(!e)return;prikaziEkran("ekran-usporedba-kosarice"),usporedbaKosariceContainer.innerHTML='<p style="text-align:center; color:#6c757d; margin-top:20px;">U캛ITAVAM CIJENE... OVO MO콯E POTRAJATI.</p>',usporedbaKosariceOriginalEl.textContent=`ORIGINAL: ${e.trgovinaNaziv.toUpperCase()} - ${e.ukupanIznos.toFixed(2)} EUR`;try{const t={},a=e.stavke.map(e=>dohvatiPodatkeSkeniranogProizvoda(e.ean,null,!0)),n=await Promise.all(a);e.stavke.forEach((e,a)=>{const i=n[a];i&&i.chains&&i.chains.forEach(a=>{parseFloat(a.price||a.min_price)>0&&(t[a.chain]||(t[a.chain]={ukupno:0,pronadjeniEAN:new Set}),t[a.chain].pronadjeniEAN.add(e.ean))})});for(const a in t){let i=0;t[a].pronadjeniEAN.forEach(o=>{const r=e.stavke.find(e=>e.ean===o),l=n.find(e=>e&&e.ean===o),d=l?.chains.find(e=>e.chain===a);if(r&&d){const e=parseFloat(d.price||d.min_price);isNaN(e)||(i+=e*r.kolicina)}}),t[a].ukupno=i}const i=Object.entries(t).map(([t,a])=>({kod:t,ukupno:a.ukupno,pronadjeno:a.pronadjeniEAN.size,sviPronadjeni:a.pronadjeniEAN.size===e.stavke.length})).filter(t=>t.kod!==e.trgovinaKod&&t.ukupno>0).sort((e,t)=>e.sviPronadjeni!==t.sviPronadjeni?t.sviPronadjeni-e.sviPronadjeni:e.ukupno-t.ukupno);if(usporedbaKosariceContainer.innerHTML="",0===i.length)return void(usporedbaKosariceContainer.innerHTML='<p style="text-align:center; color:#6c757d;">NIJE PRONA캟EN NIJEDAN ARTIKL U DRUGIM TRGOVINAMA.</p>');i.forEach(t=>{let a="",n="";t.sviPronadjeni?(n="usporedba-default usporedba-bold",t.ukupno.toFixed(2)===e.ukupanIznos.toFixed(2)?a="usporedba-default usporedba-bold":t.ukupno<e.ukupanIznos?a="cijena-jeftinije":a="cijena-skuplje"):(a="usporedba-dimmed",n="usporedba-dimmed");const i=document.createElement("div");i.className="usporedba-stavka",i.innerHTML=`<div class="usporedba-stavka-info"><div class="stavka-naziv ${a}">${mapirajKodLancaUNaziv(t.kod).toUpperCase()}</div><div class="stavka-detalji ${n}">PRONA캟ENO ${t.pronadjeno} OD ${e.stavke.length} ARTIKALA</div></div><div class="usporedba-cijena ${a}">${t.ukupno.toFixed(2)} EUR</div>`,usporedbaKosariceContainer.appendChild(i)})}catch(e){console.error("Gre코ka usporedbe ko코arice:",e),usporedbaKosariceContainer.innerHTML='<p style="text-align:center; color:#dc3545;">DOLO JE DO GREKE.</p>'}}
        async function dohvatiMarqueeText(){const e="Dobrodo코li u Du캖an Skener! Usporedite cijene i u코tedite. *** ";marqueeText.textContent=e; if(marqueeTextSkener) marqueeTextSkener.textContent=e;}

        // Event Listeners
        document.addEventListener("click",e=>{if(e.target.tagName==="BUTTON" && !e.target.disabled && !e.target.classList.contains('filter-opcija')) pustiZvuk("klik")},!0);
        btnIzaberiTrgovinu.addEventListener("click",()=>{prikaziEkran("ekran-odabir-trgovine"),dohvatiITipkajTrgovine()});
        btnNazadNaPocetnuSaOdabira.addEventListener("click",()=>prikaziEkran("pocetni-ekran"));
        btnPotvrdiTrgovinu.addEventListener("click",()=>{const e=selectTrgovina.value;e&&(postaviOdabranuTrgovinu(e,e),prikaziEkran("glavni-ekran-akcija"))});

        btnNastaviZadnjaTrgovina.addEventListener("click",()=>{
            if(zadnjeOdabranaTrgovinaKod) {
                postaviOdabranuTrgovinu(zadnjeOdabranaTrgovinaKod, zadnjeOdabranaTrgovinaNaziv);
                prikaziEkran("glavni-ekran-akcija");
            }
        });

        btnPronadjiProizvod.addEventListener("click", () => {
            pronadjiProizvodMode = true;
            prikaziEkran("ekran-skeniranja");
        });


        btnPovijestKupovine.addEventListener("click",()=>prikaziEkran("ekran-povijest-kupovine"));
        btnPovijestSaAkcija.addEventListener("click",()=>prikaziEkran("ekran-povijest-kupovine"));

        btnAkcijeNaPocetnu.addEventListener("click", () => {
            pronadjiProizvodMode = false;
            prikaziEkran("pocetni-ekran");
        });

        btnPromijeniTrgovinu.addEventListener("click",()=>{prikaziEkran("ekran-odabir-trgovine"),dohvatiITipkajTrgovine()});
        btnSkenirajProizvod.addEventListener("click",()=>{
            pronadjiProizvodMode = false;
            prikaziEkran("ekran-skeniranja");
        });

        btnPokaziPretraguNazivom.addEventListener("click", () => {
            if (pronadjiProizvodMode) {
                inputPretragaNaziv.value = '';
                originalniRezultatiPretrageNazivom = [];
                aktivniFilteriPretrageNazivom = {};
                if(filteriContainer) { filteriContainer.innerHTML = ''; filteriContainer.style.display = 'none'; }
                if (rezultatiPretrageNazivomContainer) rezultatiPretrageNazivomContainer.innerHTML = `<p style="text-align:center; color:#6c757d; margin-top:20px;">UPIITE POJAM ZA PRETRAGU (MIN. ${MIN_SEARCH_QUERY_LENGTH} ZNAKA).</p>`;
                prikaziEkran("ekran-pretraga-nazivom");
            }
        });

        btnPretragaNazivomNazad.addEventListener("click", () => {
            if (pronadjiProizvodMode) {
                prikaziEkran("ekran-skeniranja");
            } else {
                prikaziEkran("pocetni-ekran");
            }
        });


        inputPretragaNaziv.addEventListener("input", () => {
            debouncedSearch(inputPretragaNaziv.value.trim());
        });

        filteriContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button.filter-opcija');
            if (button) {
                pustiZvuk("klik");
                const filterType = button.dataset.filterType;
                const filterValue = button.dataset.filterValue;

                if (button.classList.contains('aktivan')) {
                    delete aktivniFilteriPretrageNazivom[filterType];
                } else {
                    aktivniFilteriPretrageNazivom[filterType] = filterValue;
                }
                primijeniFiltereNaRezultate();
            }
        });


        btnNazadSaSkeniranja.addEventListener("click",()=>{
            stopSkener(true);
            if (pronadjiProizvodMode) {
                pronadjiProizvodMode = false;
                prikaziEkran("pocetni-ekran");
            } else {
                if(0<trenutnaListaKupovine.length){
                    spremiTrenutnuKupovinu();
                    trenutnaListaKupovine=[];
                    azurirajPrikazSumarneListe();
                }
                prikaziEkran("glavni-ekran-akcija");
            }
        });
        btnPokreniZaustaviSkener.addEventListener("click",()=>{
            initializeAndStartScanner();
        });

        switchCameraButton.addEventListener("click",toggleCameraSelection);
        document.addEventListener("click",e=>{if(cameraSelectionOverlay && switchCameraButton) {!cameraSelectionOverlay.contains(e.target)&&!switchCameraButton.contains(e.target)&&(cameraSelectionOverlay.style.display="none")}});
        skeniranaKolicinaInput.addEventListener("input",azurirajUkupnoZaSkeniranuStavku);
        skeniranaKolicinaInput.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),btnDodajSkeniranoNaListu.focus())});
        btnDodajSkeniranoNaListu.addEventListener("click",dodajProizvodNaListu);
        btnUsporediCijene.addEventListener("click",prikaziUsporedbuCijena);
        btnPogledajListu.addEventListener("click",()=>prikaziEkran("ekran-liste-kupovine"));
        btnListaNaSkener.addEventListener("click",()=> {
            pronadjiProizvodMode = false;
            prikaziEkran("ekran-skeniranja");
        });
        btnListaNaPocetak.addEventListener("click",()=>{
            if(0<trenutnaListaKupovine.length){
                spremiTrenutnuKupovinu();
                trenutnaListaKupovine=[];
            }
            stopSkener(true);
            pronadjiProizvodMode = false;
            prikaziEkran("pocetni-ekran");
        });
        btnPovijestNaPocetak.addEventListener("click",()=>{
            pronadjiProizvodMode = false;
            prikaziEkran("pocetni-ekran");
        });
        btnSpecifikacijaNaPovijest.addEventListener("click",()=>prikaziEkran("ekran-povijest-kupovine"));
        btnUsporedbaNaSkener.addEventListener("click",()=> {
             pronadjiProizvodMode = false;
            prikaziEkran("ekran-skeniranja");
        });

        btnPronadjiRezultatiNaPocetnu.addEventListener("click", () => {
            pronadjiProizvodMode = false;
            prikaziEkran("pocetni-ekran");
        });
        btnPronadjiRezultatiNaSkener.addEventListener("click", () => {
            pronadjiProizvodMode = true;
            prikaziEkran("ekran-skeniranja");
        });

        btnUsporedbaKosariceNazad.addEventListener("click",()=>prikaziEkran("ekran-specifikacija-kupovine"));

        const shareAction = async () => {
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: "DU캕AN SKENER",
                        text: "Hej! Isprobaj Du캖an Skener - super alat za usporedbu cijena proizvoda dok si u kupovini. Skeniraj barkod ili upi코i naziv i odmah vidi코 cijene u raznim trgovinama. Nema instalacije, radi direktno u pregledniku!",
                        url: window.location.href
                    });
                } else {
                    alert("DIJELJENJE NIJE PODR콯ANO NA OVOM URE캟AJU/PREGLEDNIKU. MO콯ETE RU캛NO KOPIRATI LINK: " + window.location.href);
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error("Gre코ka prilikom dijeljenja:", e);
                    alert("DOLO JE DO GREKE PRILIKOM POKUㅁJA DIJELJENJA.");
                } else {
                    console.log("Korisnik odustao od dijeljenja.");
                }
            }
        };
        btnPodijeliAplikacijuPocetna.addEventListener("click",shareAction);
        if (btnPodijeliAplikacijuSkener) btnPodijeliAplikacijuSkener.addEventListener("click", shareAction);

        listaKupovineStavkeContainer.addEventListener("click",e=>{e.target.classList.contains("btn-brisi-stavku")&&obrisiStavkuSaListe(e.target.dataset.ean)});
        povijestKupovineContainer.addEventListener("click",e=>{const t=e.target.closest(".povijest-stavka");t&&prikaziSpecifikacijuKupovine(t.dataset.kupovinaId)});
        selectTrgovina.addEventListener("change",()=>{const e=""!==selectTrgovina.value;btnPotvrdiTrgovinu.disabled=!e,btnPotvrdiTrgovinu.classList.toggle("btn-zeleni",e)});
        btnOcistiPovijest.addEventListener("click",()=>{if(0===povijestKupovina.length)return void alert("POVIJEST JE VE캕 PRAZNA.");confirm("JESTE LI SIGURNI DA 콯ELITE TRAJNO OBRISATI CIJELU POVIJEST KUPOVINE?")&&(povijestKupovina=[],localStorage.removeItem(LS_KEYS.POVIJEST_KUPOVINA),renderirajPovijestKupovine(),alert("POVIJEST KUPOVINE JE OBRISANA."))});
        btnUsporediKosaricu.addEventListener("click",prikaziUsporedbuKosarice);

        document.addEventListener("DOMContentLoaded",async()=>{
            korisnickiID||(korisnickiID=generirajUUID(),localStorage.setItem(LS_KEYS.KORISNICKI_ID,korisnickiID));
            azurirajGumbNastavi();
            prikaziEkran("pocetni-ekran");
            azurirajUkupnoZaSkeniranuStavku();
        });
    </script>
</body>
</html>
