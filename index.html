<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DUĆAN SKENER</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Svi CSS stilovi ostaju isti kao i prije */
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-color: #f4f4f4; box-sizing: border-box; }
        header { background-color: #333; color: white; padding: 1em; text-align: center; width: 100%; box-sizing: border-box; flex-shrink: 0; }
        footer { background-color: #333; color: white; padding: 1em; text-align: center; width: 100%; text-transform: uppercase; box-sizing: border-box; flex-shrink: 0; }
        footer p { margin: 0.3em 0; font-size: 0.85em; color: #ccc; }
        footer p:first-child { margin-top: 0; } footer p:last-child { margin-bottom: 0; }
        main { padding: 10px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-top: 10px; margin-bottom: 10px; width: 95%; max-width: 600px; display: flex; flex-direction: column; flex-grow: 1; }
        main > section { width: 100%; box-sizing: border-box; }
        main > section.hidden { display: none !important; }
        #ekran-pretraga-nazivom { display: flex; flex-direction: column; height: 100%; padding: 0; background-color: transparent; box-shadow: none; border-radius: 0; margin:0; }
        h1, h2, h3 { color: #333; text-transform: uppercase; }
        button { display: block; width: 100%; padding: 12px 20px; margin-bottom: 10px; font-size: 1em; color: white; background-color: #007bff; border: none; border-radius: 5px; cursor: pointer; box-sizing: border-box; transition: background-color 0.2s, transform 0.1s, border-color 0.2s; text-transform: uppercase; }
        button:active { transform: scale(0.98); }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed !important; color: #666 !important; }
        .btn-zeleni { background-color: #28a745 !important; color: white; font-weight: bold; }
        .btn-zeleni:hover:not(:disabled) { background-color: #218838 !important; }
        .btn-zut { background-color: #ffc107 !important; color: #212529 !important; font-weight: bold; }
        .btn-zut:hover:not(:disabled) { background-color: #e0a800 !important; }
        #btn-nastavi-zadnja-trgovina { background-color: #1e7e34; }
        #btn-nastavi-zadnja-trgovina:hover:not(:disabled) { background-color: #155d27; }
        .btn-sivi { background-color: #6c757d !important; color: white !important; }
        .btn-sivi:hover:not(:disabled) { background-color: #5a6268 !important; }
        .button-group { display: flex; gap: 10px; } .button-group button { width: 100%; }
        .small-action-button { padding: 8px 12px; font-size: 0.9em; width: auto; margin-bottom: 0; }
        select { width:100%; padding:10px; margin-bottom:10px; font-size: 16px; box-sizing: border-box; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; font-size:16px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none !important; }
        #ekran-skeniranja { position: relative; }
        #marquee-container-skener { position: absolute; top: 0; left: 0; width: 100%; z-index: 25; background-color: rgba(0,0,0,0.7); padding: 6px 0; box-sizing: border-box; }
        #marquee-container-skener .marquee-text { font-size: 1.1em; color: #ffc107; }
        #reader-container { position: relative; width: 100%; max-width: 500px; height: 30vh; min-height: 250px; background-color: #000; margin-bottom: 5px; overflow: hidden; margin-left: auto; margin-right: auto; }
        #reader { width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; }
        #reader video, #reader > div > video, #reader > div:first-child > video { width: 100% !important; height: 100% !important; object-fit: cover !important; border:none !important; }
        #reader > div:first-child { width: 100% !important; height: 100% !important; border:none !important; }
        #viewfinder-overlay { display: none; position: absolute; top: 50%; left: 50%; width: 70%; max-width: 260px; padding-top: 50%; max-height: 200px; transform: translate(-50%, -50%); border: none; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4); background-image: linear-gradient(to right, white 2px, transparent 2px), linear-gradient(to bottom, white 2px, transparent 2px), linear-gradient(to left, white 2px, transparent 2px), linear-gradient(to bottom, white 2px, transparent 2px), linear-gradient(to right, white 2px, transparent 2px), linear-gradient(to top, white 2px, transparent 2px), linear-gradient(to left, white 2px, transparent 2px), linear-gradient(to top, white 2px, transparent 2px); background-repeat: no-repeat; background-size: 25px 25px; background-position: top left, top left, top right, top right, bottom left, bottom left, bottom right, bottom right; border-radius: 8px; z-index: 10; pointer-events: none; }
        #switch-camera-btn { position: absolute; top: 10px; right: 10px; z-index: 30; padding: 8px 10px; background-color: rgba(0,0,0,0.4); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; font-size: 1.5em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; width: auto; margin-bottom: 0; }
        #camera-selection-overlay { position: absolute; top: 50px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 31; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 180px; width: auto; }
        #camera-list { list-style: none; padding: 0; margin: 0; } #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; color: #333; text-transform: none; } #camera-list li:hover { background-color: #f0f0f0; } #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }
        .messages-skener { text-align: center; margin-top: 0; margin-bottom: 5px; min-height: 1.2em; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; }
        .messages-skener .status { color: #333; margin:0; padding: 2px 0; font-weight: bold; }
        .messages-skener .error { color: #dc3545; font-weight: bold; margin:0; padding: 2px 0; }
        #sadrzaj-ispod-skenera { padding: 5px 10px; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        #info-skeniranog-proizvoda-container { border: 1px solid #ccc; padding: 12px; margin-bottom: 8px; background-color: #fff; width: 100%; max-width: 500px; color: #333; font-size: 1.1em; }
        #info-skeniranog-proizvoda-container p, #info-skeniranog-proizvoda-container label { color: #333; }
        #info-skeniranog-proizvoda-container p:first-of-type { margin-top: 0; }
        input[type="number"]#skenirana-kolicina { background-color: #f1f1f1; color: #333; border: 1px solid #ccc; width: 55px !important; padding: 8px !important; font-size:1em; margin:0 5px 0 0 !important; }
        .kolicina-ukupno-red-flex { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 10px; padding: 5px 0; }
        .kolicina-ukupno-red-flex > div { display: flex; align-items: center; }
        .kolicina-ukupno-red-flex label { margin-right: 5px; text-transform: uppercase; }
        #lista-summary-container { padding: 8px; margin-bottom: 8px; background-color: #333; width: 100%; max-width: 500px; color: #f0f0f0; border: 1px solid #333; }
        #lista-summary-tekst { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; text-align: center; text-transform: uppercase; }
        .sticky-header { padding: 10px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; position: sticky; top: 0; z-index: 100; width: 100%; box-sizing: border-box; flex-shrink: 0; }
        .header-gornji-red { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header-gornji-red button { width: auto; margin: 0; padding: 6px 10px; font-size: 0.9em; }
        .header-donji-red { text-align: center; font-weight: bold; font-size: 1.2em; color: #333; text-transform: uppercase; }
        .scrollable-content { flex-grow: 1; overflow-y: auto; padding: 10px; width:100%; box-sizing:border-box; background-color: white; }
        #ekran-pretraga-nazivom .sticky-header .header-gornji-red { margin-bottom: 10px; align-items: center; }
        #ekran-pretraga-nazivom .sticky-header .header-gornji-red h2 { margin:0; flex-grow:1; text-align:center; font-size: 1.1em; }
        #input-pretraga-naziv { width: 100%; padding: 10px; font-size: 1em; margin-top: 0; margin-bottom: 8px; box-sizing: border-box; }
        .sticky-header-subtext { font-size: 0.8em; color: #555; text-align: center; width: 100%; padding-top: 0; margin: 0 0 5px 0; text-transform: uppercase; }
        #filteri-container { padding: 8px 0 5px 0; border-top: 1px solid #e0e0e0; margin-top: 5px; background-color: #f8f9fa; display: none; }
        .filter-grupa { margin-bottom: 8px; padding: 0 10px; }
        .filter-grupa:last-child { margin-bottom: 0; }
        .filter-label { font-size: 0.8em; font-weight: bold; color: #333; margin-bottom: 4px; display: block; text-transform: uppercase; }
        .filter-opcije-wrapper { display: flex; flex-wrap: wrap; gap: 6px; }
        button.filter-opcija { padding: 5px 10px; font-size: 0.85em; margin-bottom: 0; width: auto; background-color: #e9ecef; color: #212529; border: 1px solid #ced4da; text-transform: none; font-weight: normal; }
        button.filter-opcija.aktivan { background-color: #007bff !important; color: white !important; border-color: #0056b3 !important; font-weight: bold; }
        button.filter-opcija:hover:not(:disabled):not(.aktivan) { background-color: #dee2e6; }
        .stavka-liste, .povijest-stavka, .usporedba-stavka, .pronadji-rezultati-stavka, .pretraga-nazivom-stavka { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; margin-bottom: 5px; color: #333; }
        .stavka-liste:last-child, .povijest-stavka:last-child, .usporedba-stavka:last-child, .pronadji-rezultati-stavka:last-child, .pretraga-nazivom-stavka:last-child { border-bottom: none; margin-bottom: 0;}
        .stavka-liste-info, .povijest-stavka-info, .usporedba-stavka-info, .pronadji-rezultati-stavka-info, .pretraga-nazivom-stavka-info { flex-grow: 1; margin-right: 5px; overflow: hidden; }
        .stavka-naziv, .pretraga-nazivom-naziv-proizvoda { font-weight: bold; font-size: 1em; margin-bottom: 3px; word-break: break-word; text-transform: uppercase; }
        .stavka-detalji, .pretraga-nazivom-detalji { font-size: 0.85em; color: #6c757d; margin-bottom: 3px; word-break: break-word; text-transform: uppercase; }
        .stavka-ukupno, .povijest-iznos, .usporedba-cijena, .pronadji-rezultati-cijena, .pretraga-nazivom-cijena { font-size: 0.9em; font-weight: bold; white-space: nowrap; margin-left:10px; text-align: right; flex-shrink:0; }
        .pretraga-nazivom-ducan { font-weight: bold; font-size: 0.9em; color: #007bff; margin-bottom: 2px; text-transform: uppercase;}
        .cijena-jeftinije { color: #28a745 !important; } .cijena-skuplje { color: #dc3545 !important; } .cijena-najjeftinije { color: #28a745 !important; font-weight: bold; }
        .usporedba-dimmed { color: #888 !important; } .usporedba-default { color: #333 !important; } .usporedba-bold { font-weight: bold !important; }
        #usporedba-kosarice-original { font-size: 1.1em !important; font-weight: bold; color: #333 !important; text-align: center; text-transform: uppercase; }
        #usporedba-kosarice-container .stavka-naziv { font-size: 1.1em; text-transform: uppercase; } #usporedba-kosarice-container .usporedba-cijena { font-size: 1.1em; }
        .btn-brisi-stavku { background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1em; line-height: 28px; padding: 0; cursor: pointer; margin-left: 10px; flex-shrink: 0; }
        .btn-brisi-stavku:hover:not(:disabled) { background-color: #c82333; }
        .povijest-stavka { cursor: pointer; } .povijest-stavka:hover { background-color: #f8f9fa; }
        #scan-feedback-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.95); border-radius: 10px; padding: 20px 40px; text-align: center; font-size: 1.8em; font-weight: bold; z-index: 30; opacity: 0; scale: 0.7; pointer-events: none; transition: opacity 0.3s ease-out, scale 0.3s ease-out; text-transform: uppercase; }
        #scan-feedback-overlay.show { opacity: 1; scale: 1; }
        #scan-feedback-overlay.success { color: #28a745; border: 3px solid #28a745; }
        #scan-feedback-overlay.error { color: #dc3545; border: 3px solid #dc3545; }
        .marquee-container { width: 100%; overflow: hidden; background-color: #000; padding: 8px 0; box-sizing: border-box;}
        .marquee-text { color: #ffc107; font-size: 1.35em; font-weight: bold; white-space: nowrap; display: inline-block; padding-left: 100%; animation: marquee 25s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .gumb-za-dijeljenje { background-color: #1e7e34 !important; color: white !important; font-weight: bold !important; }
        .gumb-za-dijeljenje:hover:not(:disabled) { background-color: #155d27 !important; }
        .animacija-pulsiranje-horizontalno { animation: pulseHorizontalShrinkReturn 2.0s infinite ease-in-out; }
        @keyframes pulseHorizontalShrinkReturn { 0%   { transform: scaleX(1); } 45%  { transform: scaleX(0.75); } 55%  { transform: scaleX(0.75); } 100% { transform: scaleX(1); } }
        #ekran-skeniranja #btn-pokreni-zaustavi-skener, #ekran-skeniranja #btn-nazad-sa-skeniranja, #ekran-skeniranja #btn-pokazi-pretragu-nazivom { padding: 10px 15px; }
        #ekran-skeniranja #btn-nazad-sa-skeniranja, #ekran-skeniranja #btn-pokazi-pretragu-nazivom { font-size: 0.9em; }
        #ekran-skeniranja #btn-pokreni-zaustavi-skener { font-size: 1.1em; font-weight: bold; }
        #sadrzaj-ispod-skenera .button-group button, #sadrzaj-ispod-skenera #lista-summary-container button { padding: 8px 12px; font-size: 0.9em; }
        #sadrzaj-ispod-skenera .button-group { margin-top: 6px; }
        @keyframes animacijaTekstBojaZuto { 0%, 100% { color: white; } 50% { color: #FFC107; } }
        .animacija-tekst-zuto { animation: animacijaTekstBojaZuto 1.5s infinite; }
        /* DODANO: Stil za poruku o dijeljenju */
        #share-prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 1000; display: none; justify-content: center; align-items: center; text-align: center; color: white; padding: 20px; box-sizing: border-box; }
        #share-prompt-content { background-color: #333; padding: 30px; border-radius: 10px; border: 2px solid #ffc107; }
        #share-prompt-content h2 { color: #ffc107; margin-top: 0; }
        #share-prompt-content p { font-size: 1.1em; }
        #share-prompt-content button { margin-top: 15px; }
    </style>
</head>
<body>
    <header><h1>DUĆAN SKENER</h1></header>
    <div id="marquee-container" class="marquee-container hidden"><span id="marquee-text" class="marquee-text"></span></div>
    
    <!-- DODANO: Overlay za poruku o dijeljenju -->
    <div id="share-prompt-overlay">
        <div id="share-prompt-content">
            <h2>Hvala na korištenju!</h2>
            <p>Dosegli ste limit skeniranja. Molimo podijelite aplikaciju kako biste nastavili.</p>
            <button id="btn-podijeli-iz-prozora" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno">PODIJELI DUĆAN SKENER</button>
        </div>
    </div>

    <main id="app-container">
        <!-- Svi ostali <section> elementi ostaju nepromijenjeni... -->
        <section id="pocetni-ekran">
            <h2>DOBRODOŠLI!</h2>
            <button id="btn-izaberi-trgovinu">IZABERI TRGOVINU</button>
            <button id="btn-nastavi-zadnja-trgovina" class="hidden">NASTAVI S [NAZIV ZADNJE TRGOVINE]</button>
            <button id="btn-pronadji-proizvod" class="btn-zut">PRONAĐI PROIZVOD</button>
            <button id="btn-povijest-kupovine" class="btn-sivi">POVIJEST KUPOVINE</button>
            <button id="btn-posalji-prijedlog-pocetna" class="btn-sivi" style="margin-top: 20px; background-color: #5bc0de !important;" disabled>
                POŠALJI PRIJEDLOG ANONIMNO
            </button>
            <button id="btn-podijeli-aplikaciju-pocetna" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 15px;">PODIJELI DUĆAN SKENER</button>
        </section>

        <section id="ekran-odabir-trgovine" class="hidden">
            <h2>ODABERI TRGOVINU:</h2>
            <select id="select-trgovina"><option value="">UČITAVANJE...</option></select>
            <button id="btn-potvrdi-trgovinu" disabled>POTVRDI ODABIR</button>
            <button id="btn-nazad-na-pocetnu-sa-odabira">NAZAD</button>
        </section>

        <section id="glavni-ekran-akcija" class="hidden">
            <h2 id="info-odabrana-trgovina">TRGOVINA: [NAZIV TRGOVINE]</h2>
            <button id="btn-skeniraj-proizvod" class="btn-zeleni">SKENIRAJ PROIZVOD</button>
            <button id="btn-promijeni-trgovinu">PROMIJENI TRGOVINU</button>
            <button id="btn-povijest-sa-akcija" class="btn-sivi">POVIJEST KUPOVINE</button>
            <button id="btn-akcije-na-pocetnu" class="btn-sivi">NA POČETAK</button>
        </section>

        <section id="ekran-skeniranja" class="hidden">
            <div id="marquee-container-skener" class="marquee-container hidden"><span id="marquee-text-skener" class="marquee-text"></span></div>
            <div id="reader-container">
                <div id="reader"></div><div id="viewfinder-overlay"></div><div id="scan-feedback-overlay"></div>
                <button id="switch-camera-btn">🔄</button>
                <div id="camera-selection-overlay"><ul id="camera-list"></ul></div>
            </div>
            <div class="messages-skener"><p id="statusTextSkener" class="status"></p><p id="errorTextSkener" class="error"></p></div>
            <button id="btn-pokreni-zaustavi-skener" class="btn-zeleni hidden">PONOVO POKRENI SKENER</button>
            <button id="btn-pokazi-pretragu-nazivom" class="btn-sivi hidden" style="margin-top: 5px;">UPIŠI NAZIV ZA PRETRAGU</button>
            <div id="sadrzaj-ispod-skenera" class="hidden">
                <div id="info-skeniranog-proizvoda-container" class="hidden">
                    <p><strong>NAZIV:</strong> <span id="skeniran-naziv"></span></p>
                    <p><strong>CIJENA/KOM:</strong> <span id="skenirana-cijena"></span> EUR</p>
                    <p><strong>CIJENA PO JM:</strong> <span id="skenirana-cijena-po-jedinici"></span></p>
                    <div class="kolicina-ukupno-red-flex">
                        <div>
                            <label for="skenirana-kolicina">KOLIČINA:</label>
                            <input type="number" id="skenirana-kolicina" value="1" min="1">
                        </div>
                        <div id="skeniran-item-ukupno">UKUPNO: 0.00 EUR</div>
                    </div>
                    <div class="button-group" style="margin-top:8px;">
                        <button id="btn-usporedi-cijene" class="btn-zut">USPOREDI</button>
                        <button id="btn-dodaj-skenirano-na-listu" class="btn-zeleni">DODAJ NA LISTU</button>
                    </div>
                </div>
                <div id="lista-summary-container" class="hidden"><div id="lista-summary-tekst">UKUPNO: <span id="ukupno-cijena-skeniranje-sum">0.00</span> EUR</div><button id="btn-pogledaj-listu">POGLEDAJ LISTU</button></div>
                <button id="btn-nazad-sa-skeniranja" style="margin-top: 4px; margin-bottom: 3px;">ZAVRŠI I SPREMI</button>
                <button id="btn-podijeli-aplikaciju-skener" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 3px; margin-bottom: 8px;">PODIJELI DUĆAN SKENER</button>
            </div>
        </section>

        <section id="ekran-pretraga-nazivom" class="hidden">
            <div class="sticky-header">
                <div class="header-gornji-red">
                    <button id="btn-pretraga-nazivom-nazad" class="small-action-button">NAZAD</button>
                    <h2 style="margin:0; flex-grow:1; text-align:center;">PRETRAGA NAZIVOM</h2>
                    <span style="width: auto; min-width: 100px; visibility: hidden;">Placeholder</span>
                </div>
                <input type="text" id="input-pretraga-naziv" placeholder="UPIŠI POJAM ZA PRETRAGU (MIN. 3 ZNAKA)">
                <div id="filteri-container">
                </div>
                <p class="sticky-header-subtext">PODACI O CIJENAMA PREUZETI IZ CIJENE.API</p>
            </div>
            <div class="scrollable-content" id="rezultati-pretrage-nazivom-container">
            </div>
        </section>

        <section id="ekran-liste-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-lista-na-skener" class="small-action-button">NA SKENER</button><button id="btn-lista-na-pocetak" class="small-action-button">ZAVRŠI I SPREMI</button></div><div class="header-donji-red">UKUPNO: <span id="ukupno-cijena-lista-prikaz">0.00</span> EUR</div></div>
            <div class="scrollable-content" id="lista-kupovine-stavke-container"><p id="prazna-lista-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">LISTA JE PRAZNA.</p></div>
        </section>

        <section id="ekran-povijest-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-povijest-na-pocetak" class="small-action-button">NA POČETAK</button><h2 style="margin:0; flex-grow:1; text-align:center;">POVIJEST KUPOVINE</h2><span> </span></div></div>
            <div class="scrollable-content" id="povijest-kupovine-container"><p id="prazna-povijest-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">NEMA SPREMLJENIH KUPOVINA.</p></div>
            <div style="padding: 0 10px 10px 10px;"><button id="btn-ocisti-povijest" style="background-color:#dc3545;" class="hidden">OČISTI POVIJEST</button></div>
        </section>

        <section id="ekran-specifikacija-kupovine" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-specifikacija-na-povijest" class="small-action-button">NAZAD NA POVIJEST</button><h2 style="margin:0; flex-grow:1; text-align:center;" id="specifikacija-naslov">KUPOVINA</h2><span> </span></div><div class="header-donji-red" id="specifikacija-ukupno">UKUPNO: 0.00 EUR</div></div>
            <div class="scrollable-content" id="specifikacija-stavke-container"></div>
            <div style="padding: 0 10px 10px 10px;"><button id="btn-usporedi-kosaricu" class="btn-zut">USPOREDI CIJELU KOŠARICU</button></div>
        </section>

        <section id="ekran-usporedbe-cijena" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-usporedba-na-skener" class="small-action-button">NAZAD NA SKENER</button><h2 style="margin:0; flex-grow:1; text-align:center;" id="usporedba-artikl-naziv">USPOREDBA</h2><span> </span></div><div style="text-align:center; font-size:0.9em; color:#6c757d;" id="usporedba-artikl-cijena-trenutna"></div></div>
            <div class="scrollable-content" id="usporedba-cijena-container"><p id="usporedba-nema-podataka-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">NEMA PODATAKA ZA USPOREDBU.</p></div>
        </section>

        <section id="ekran-pronadji-proizvod-rezultati" class="hidden">
            <div class="sticky-header">
                <div class="header-gornji-red">
                    <button id="btn-pronadji-rezultati-na-pocetnu" class="small-action-button">NA POČETAK</button>
                    <h2 style="margin:0; flex-grow:1; text-align:center;" id="pronadji-rezultati-artikl-naziv">PRETRAGA PROIZVODA</h2>
                    <button id="btn-pronadji-rezultati-na-skener" class="small-action-button">NOVI SKEN</button>
                </div>
            </div>
            <div class="scrollable-content" id="pronadji-rezultati-lista-container">
                <p id="pronadji-rezultati-nema-podataka-poruka" style="text-align:center; color:#6c757d; margin-top:20px;">SKENIRAJTE PROIZVOD ZA PRIKAZ CIJENA.</p>
            </div>
        </section>

        <section id="ekran-usporedba-kosarice" class="hidden">
            <div class="sticky-header"><div class="header-gornji-red"><button id="btn-usporedba-kosarice-nazad" class="small-action-button">NAZAD NA KUPOVINU</button><h2 style="margin:0; flex-grow:1; text-align:center;">USPOREDBA KOŠARICE</h2><span> </span></div><div id="usporedba-kosarice-original"></div></div>
            <div class="scrollable-content" id="usporedba-kosarice-container"></div>
        </section>
    </main>
     <footer>
        <p>PODACI O CIJENAMA PREUZETI S CIJENE.API</p>
        <p>© 2024 DUĆAN SKENER</p>
        <p>IZRADILI: DARKO BANOVIĆ I GOOGLE AI</p>
    </footer>
    <script type="text/javascript">var sc_project=13142545; var sc_invisible=1; var sc_security="cd38ae59";</script>
    <script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async></script>
    <noscript><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/13142545/0/cd38ae59/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></noscript>
    <audio id="zvuk-klik" src="click8.mp3" preload="auto"></audio>
    <audio id="zvuk-ima" src="ima.mp3" preload="auto"></audio>
    <audio id="zvuk-nema" src="nema.mp3" preload="auto"></audio>

<script>
    // --- KONSTANTE ---
    const API_BASE_URL = "https://api.cijene.dev";
    const API_KEY = "mee5xooThuithei4ees4bae3emos3ook"; // Zamijeni svojim ključem
    const MAX_POVIJEST_KUPVINA = 20;
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVv906IL7k9YpL_yIBOzX1BsEw_0Y-abtnZlc8SzIMgt40R0ROAsP0fz5BRf4zzDOCgg/exec"; // Zamijeni svojim URL-om
    const LS_PREFIX = "ds_";
    const LS_KEYS = {
        ZADNJA_TRGOVINA_KOD: `${LS_PREFIX}zadnjaTrgovinaKod`,
        ZADNJA_TRGOVINA_NAZIV: `${LS_PREFIX}zadnjaTrgovinaNaziv`,
        POVIJEST_KUPOVINA: `${LS_PREFIX}povijestKupovina`,
        KORISNICKI_ID: `${LS_PREFIX}korisnickiID`,
        CAMERA_ID: `${LS_PREFIX}selectedCameraID`,
        PRVO_KORISTENJE: `${LS_PREFIX}prvoKoristenje`,
        BROJAC_SKENIRANJA: `${LS_PREFIX}brojacSkeniranja` // DODANO: Ključ za brojač
    };
    const MIN_SEARCH_QUERY_LENGTH = 3;
    const DEBOUNCE_DELAY = 400;
    const SECONDS_PER_CHARACTER = 0.25;
    const MIN_MARQUEE_DURATION = 8;
    const MAX_MARQUEE_DURATION = 45;

    // --- DOM ELEMENTI ---
    const sveSekcije = Array.from(document.querySelectorAll('main > section'));
    const dom = {};
    sveSekcije.forEach(sekcija => {
        dom[sekcija.id] = sekcija;
        Array.from(sekcija.querySelectorAll('[id]')).forEach(el => {
            // Pretvara btn-izaberi-trgovinu u btnIzaberiTrgovinu
            const camelCaseId = el.id.replace(/-(\w)/g, (match, letter) => letter.toUpperCase());
            dom[camelCaseId] = el;
        });
    });
    const audioElements = {
        klik: document.getElementById("zvuk-klik"),
        ima: document.getElementById("zvuk-ima"),
        nema: document.getElementById("zvuk-nema")
    };
    
    // --- GLOBALNE VARIJABLE ---
    let trenutnoOdabranaTrgovina = null;
    let html5QrCode = null;
    let isScannerRunning = false;
    let availableCameras = [];
    let trenutnaListaKupovine = [];
    let zadnjiSkeniraniProizvodInfo = null;
    let povijestKupovina = JSON.parse(localStorage.getItem(LS_KEYS.POVIJEST_KUPOVINA)) || [];
    let korisnickiID = localStorage.getItem(LS_KEYS.KORISNICKI_ID);
    let prvoKoristenje = localStorage.getItem(LS_KEYS.PRVO_KORISTENJE);
    let trenutnoPrikazanaKupovinaId = null;
    let pronadjiProizvodMode = false;
    let debounceTimeout = null;
    let originalniRezultatiPretrageNazivom = [];
    let aktivniFilteriPretrageNazivom = {};
    
    // DODANO: Varijable za brojač
    let brojacSkeniranja = null; 
    let pocetnaVrijednostBrojaca = 10; // Defaultna vrijednost dok se ne učita iz Sheeta

    // --- POMOĆNE FUNKCIJE ---
    function pustiZvuk(id) { /* ... ista kao prije ... */ }
    function generirajUUID() { /* ... ista kao prije ... */ }
    // ... ostale pomoćne funkcije ostaju iste ...

    function prikaziEkran(id) {
        if (brojacSkeniranja !== null && brojacSkeniranja <= 0) {
            dom.sharePromptOverlay.style.display = 'flex';
            return; // Prekini daljnje prikazivanje ekrana
        }
        dom.sharePromptOverlay.style.display = 'none';

        sveSekcije.forEach(el => el.classList.toggle("hidden", el.id !== id));
        
        // Ovdje ide ostatak prikaziEkran logike... (ostaje nepromijenjen)
        if (id !== "ekran-skeniranja") {
            if (document.querySelector('header')) document.querySelector('header').style.display = 'block';
            if (document.querySelector('footer')) document.querySelector('footer').style.display = 'block';
            if (dom.marqueeContainerSkener) dom.marqueeContainerSkener.classList.add("hidden"); 
        } else { 
            if (document.querySelector('header')) document.querySelector('header').style.display = 'none';
            if (document.querySelector('footer')) document.querySelector('footer').style.display = 'none';
            if (dom.marqueeContainerSkener) dom.marqueeContainerSkener.classList.remove("hidden");
        }
        if (dom.marqueeContainer && id === "pocetni-ekran") { 
            dom.marqueeContainer.classList.remove("hidden");
        } else if (dom.marqueeContainer) {
            dom.marqueeContainer.classList.add("hidden");
        }
        if (dom.btnSkenirajProizvod.classList.contains('animacija-tekst-zuto') && id !== 'glavni-ekran-akcija') {
            dom.btnSkenirajProizvod.classList.remove('animacija-tekst-zuto');
        }
        if (id !== 'ekran-skeniranja') {
            dom.btnPokreniZaustaviSkener.classList.remove('animacija-tekst-zuto');
            dom.btnPokreniZaustaviSkener.classList.add('hidden');
        }
        if ("glavni-ekran-akcija" === id) {
            dom.btnSkenirajProizvod.classList.add('animacija-tekst-zuto');
        } else if ("ekran-skeniranja"===id) {
            dom.btnPokreniZaustaviSkener.classList.add('hidden');
            dom.btnPokreniZaustaviSkener.classList.remove('animacija-tekst-zuto');
            dom.infoSkeniranogProizvodaContainer.classList.add("hidden");
            dom.btnNazadSaSkeniranja.textContent = pronadjiProizvodMode ? "NATRAG NA OPCIJE" : "ZAVRŠI I SPREMI";
            dom.btnPokaziPretraguNazivom.classList.toggle("hidden", !pronadjiProizvodMode);
            document.getElementById('sadrzaj-ispod-skenera').classList.toggle('hidden', pronadjiProizvodMode);
            if (pronadjiProizvodMode) {
                if(dom.statusTextSkener) dom.statusTextSkener.textContent = "PRONAĐI PROIZVOD: SKENIRAJTE BARKOD";
                if(dom.listaSummaryContainer) dom.listaSummaryContainer.classList.add("hidden");
            } else {
                if(dom.statusTextSkener) dom.statusTextSkener.textContent = trenutnoOdabranaTrgovina ? `${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENIRAJTE BARKOD` : "ODABERITE TRGOVINU.";
                if(dom.listaSummaryContainer) dom.listaSummaryContainer.classList.toggle("hidden", trenutnaListaKupovine.length === 0);
                azurirajPrikazSumarneListe();
            }
            if(dom.errorTextSkener) dom.errorTextSkener.textContent = "";
            initializeAndStartScanner();
        } else if (id === "ekran-pretraga-nazivom") {
             if (isScannerRunning) stopSkener(true);
        } else if (isScannerRunning && !["ekran-skeniranja"].includes(id)) { 
            stopSkener(true);
        }
        if ("ekran-liste-kupovine"===id) {
            renderirajListuKupovine();
        } else if ("ekran-povijest-kupovine"===id) {
            renderirajPovijestKupovine();
        }
    }

    async function onScanSuccess(decodedText, decodedResult) {
        await stopSkener();

        // --- LOGIKA BROJAČA ---
        if (!pronadjiProizvodMode) { // Smanjuj brojač samo kod normalnog skeniranja
            if (brojacSkeniranja > 0) {
                brojacSkeniranja--;
                localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                console.log(`Brojač smanjen na: ${brojacSkeniranja}`);
            }
            if (brojacSkeniranja <= 0) {
                prikaziEkran(null); // Ovo će pokrenuti prikaz overlay-a za dijeljenje
                return;
            }
        }
        // --- KRAJ LOGIKE BROJAČA ---
        
        // Ostatak onScanSuccess funkcije... (ostaje nepromijenjen)
        if (pronadjiProizvodMode) {
            prikaziScanFeedback("ima", "TRAŽIM...");
            try {
                const productData = await dohvatiPodatkeSkeniranogProizvoda(decodedText, null, true);
                if (productData && (productData.name || (productData.chains && productData.chains.length > 0))) {
                    prikaziRezultatePretrageProizvoda(productData);
                } else {
                    prikaziScanFeedback("nema", "NEMA PODATAKA");
                    if (dom.errorTextSkener) dom.errorTextSkener.textContent = "PROIZVOD NIJE PRONAĐEN ILI NEMA CIJENA.";
                    if (dom.statusTextSkener) dom.statusTextSkener.textContent = "PRONAĐI PROIZVOD: POKUŠAJTE PONOVO SKENIRATI.";
                    dom.btnPokreniZaustaviSkener.classList.remove('hidden');
                    dom.btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
                }
            } catch (error) {
                prikaziScanFeedback("nema", "GREŠKA");
                if (dom.errorTextSkener) dom.errorTextSkener.textContent = `GREŠKA: ${error.message}`;
                if (dom.statusTextSkener) dom.statusTextSkener.textContent = "PRONAĐI PROIZVOD: GREŠKA, POKUŠAJTE PONOVO SKENIRATI.";
                dom.btnPokreniZaustaviSkener.classList.remove('hidden');
                dom.btnPokreniZaustaviSkener.classList.add('animacija-tekst-zuto');
            }
        } else {
            if (trenutnoOdabranaTrgovina?.code) {
                dohvatiPodatkeSkeniranogProizvoda(decodedText, trenutnoOdabranaTrgovina.code, false);
            } else {
                alert("NIJE ODABRANA TRGOVINA!");
                prikaziEkran("ekran-odabir-trgovine");
                dohvatiITipkajTrgovine();
            }
        }
    }

    async function posaljiPodatke(eventData) {
        if (!GOOGLE_APPS_SCRIPT_URL) { return; }
        // DODANO: Uvijek šalji i stanje brojača
        const dataToSend = { 
            ...eventData, 
            korisnickiID: korisnickiID, 
            prvoKoristenje: prvoKoristenje, 
            timestamp: new Date().toISOString(), 
            userAgent: navigator.userAgent,
            brojacStanje: brojacSkeniranja // Šaljemo trenutno stanje
        };
        try { await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dataToSend) }); } 
        catch (error) { console.error(`Greška slanja događaja '${dataToSend.dogadaj}':`, error); }
    }

    async function dohvatiPostavkeIzSheeta() {
        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
            if (!response.ok) throw new Error(`HTTP status ${response.status}`);
            const data = await response.json();
            
            // Postavi tekst
            azurirajMarqueeTekst(data.marqueeTekst || "Dobrodošli u Dućan Skener!");
            
            // Postavi gumb za prijedloge
            if (dom.btnPosaljiPrijedlogPocetna) {
                dom.btnPosaljiPrijedlogPocetna.disabled = !(data.prijedloziAktivni === true);
                dom.btnPosaljiPrijedlogPocetna.textContent = data.prijedloziAktivni ? "POŠALJI PRIJEDLOG ANONIMNO" : "PRIJEDLOZI (ISKLJUČENO)";
            }

            // --- LOGIKA BROJAČA ---
            if (data.pocetniBrojac) {
                pocetnaVrijednostBrojaca = data.pocetniBrojac;
                // Ako brojač još nije postavljen u localStorage, postavi ga
                if (brojacSkeniranja === null) {
                    brojacSkeniranja = pocetnaVrijednostBrojaca;
                    localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                    console.log(`Brojač inicijaliziran na: ${brojacSkeniranja}`);
                }
            }
            // --- KRAJ LOGIKE BROJAČA ---

        } catch (error) {
            console.error("Greška u dohvatiPostavkeIzSheeta:", error);
            // Koristi fallback vrijednosti u slučaju greške
            azurirajMarqueeTekst("Dobrodošli u Dućan Skener!");
            if(dom.btnPosaljiPrijedlogPocetna) dom.btnPosaljiPrijedlogPocetna.disabled = false;
        }
    }
    
    // --- IZMIJENJENA SHARE FUNKCIJA ---
    const shareAction = async () => {
        try {
            if (navigator.share) {
                await navigator.share({
                    title: "DUĆAN SKENER",
                    text: "Hej! Isprobaj Dućan Skener - super alat za usporedbu cijena proizvoda. Skeniraj barkod i odmah vidiš cijene u raznim trgovinama. Nema instalacije, radi direktno u pregledniku!",
                    url: window.location.href
                });
                // USPJEŠNO DIJELJENJE - RESETIRAJ BROJAČ
                console.log("Aplikacija podijeljena, resetiram brojač.");
                brojacSkeniranja = pocetnaVrijednostBrojaca; // Vrati na početnu vrijednost iz Sheeta
                localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                dom.sharePromptOverlay.style.display = 'none'; // Sakrij poruku
                prikaziEkran('pocetni-ekran'); // Vrati na početni ekran
            } else {
                alert("DIJELJENJE NIJE PODRŽANO NA OVOM UREĐAJU/PREGLEDNIKU.");
            }
        } catch (e) {
            if (e.name !== "AbortError") console.error("Greška prilikom dijeljenja:", e);
        }
    };

    // --- EVENT LISTENERS ---
    // ... većina listenera ostaje ista ...
    
    // DODANO: Listener za gumb u prozoru za dijeljenje
    if (dom.btnPodijeliIzProzora) {
        dom.btnPodijeliIzProzora.addEventListener('click', shareAction);
    }
    // Ažurirani listeneri za gumbe za dijeljenje
    if (dom.btnPodijeliAplikacijuPocetna) {
        dom.btnPodijeliAplikacijuPocetna.addEventListener('click', shareAction);
    }
    if (dom.btnPodijeliAplikacijuSkener) {
        dom.btnPodijeliAplikacijuSkener.addEventListener('click', shareAction);
    }
    
    // ... svi ostali listeneri koji nisu povezani s dijeljenjem ostaju isti ...
    // npr. btnIzaberiTrgovinu, btnNazadNaPocetnuSaOdabira, itd.
    
    // --- INICIJALIZACIJA APLIKACIJE ---
    document.addEventListener("DOMContentLoaded", async () => {
        // Inicijalizacija ID-jeva
        if (!korisnickiID) {
            korisnickiID = generirajUUID();
            localStorage.setItem(LS_KEYS.KORISNICKI_ID, korisnickiID);
        }
        if (!prvoKoristenje) {
            prvoKoristenje = new Date().toISOString();
            localStorage.setItem(LS_KEYS.PRVO_KORISTENJE, prvoKoristenje);
            posaljiPodatke({ dogadaj: "novi_korisnik" });
        }
        
        // --- LOGIKA BROJAČA ---
        // Učitaj brojač iz localStorage
        const spremljeniBrojac = localStorage.getItem(LS_KEYS.BROJAC_SKENIRANJA);
        if (spremljeniBrojac !== null) {
            brojacSkeniranja = parseInt(spremljeniBrojac, 10);
        } else {
            brojacSkeniranja = null; // Označi da treba inicijalizaciju
        }
        // --- KRAJ LOGIKE BROJAČA ---

        posaljiPodatke({ dogadaj: "app_loaded" });
        azurirajGumbNastavi();
        prikaziEkran("pocetni-ekran");
        await dohvatiPostavkeIzSheeta(); // Dohvati sve postavke, uključujući brojač

        // Provjeri stanje brojača odmah nakon učitavanja
        if (brojacSkeniranja !== null && brojacSkeniranja <= 0) {
            prikaziEkran(null);
        }
    });

    // Ostatak JS koda (funkcije koje se nisu mijenjale)
    // Važno je da su sve funkcije koje se pozivaju (npr. renderirajListuKupovine, azurirajGumbNastavi, itd.)
    // prisutne ovdje, kao u tvojoj originalnoj datoteci. Zbog kratkoće, nisam ih sve kopirao ovdje.
    // Ako zamijeniš cijeli <script> tag, moraš osigurati da su sve funkcije unutra.

</script>
</body>
</html>
