<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DUƒÜAN SKENER</title>
    <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Svi tvoji CSS stilovi ostaju nepromijenjeni... */
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-color: #f4f4f4; box-sizing: border-box; }
        header { background-color: #333; color: white; padding: 1em; text-align: center; width: 100%; box-sizing: border-box; flex-shrink: 0; }
        footer { background-color: #333; color: white; padding: 1em; text-align: center; width: 100%; text-transform: uppercase; box-sizing: border-box; flex-shrink: 0; }
        footer p { margin: 0.3em 0; font-size: 0.85em; color: #ccc; }
        main { padding: 10px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-top: 10px; margin-bottom: 10px; width: 95%; max-width: 600px; display: flex; flex-direction: column; flex-grow: 1; }
        main > section { width: 100%; box-sizing: border-box; }
        main > section.hidden { display: none !important; }
        h1, h2, h3 { color: #333; text-transform: uppercase; }
        button { display: block; width: 100%; padding: 12px 20px; margin-bottom: 10px; font-size: 1em; color: white; background-color: #007bff; border: none; border-radius: 5px; cursor: pointer; box-sizing: border-box; transition: background-color 0.2s, transform 0.1s, border-color 0.2s; text-transform: uppercase; }
        button:active { transform: scale(0.98); }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed !important; color: #666 !important; }
        .btn-zeleni { background-color: #28a745 !important; }
        .btn-zut { background-color: #ffc107 !important; color: #212529 !important; }
        #btn-nastavi-zadnja-trgovina { background-color: #1e7e34; }
        .btn-sivi { background-color: #6c757d !important; }
        .gumb-za-dijeljenje { background-color: #1e7e34 !important; }
        .animacija-pulsiranje-horizontalno { animation: pulseHorizontalShrinkReturn 2.0s infinite ease-in-out; }
        @keyframes pulseHorizontalShrinkReturn { 0%,100% {transform: scaleX(1)} 50% {transform: scaleX(0.95)} }
        /* DODANO: Stil za prozor za dijeljenje */
        #share-prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 1000; display: none; justify-content: center; align-items: center; text-align: center; color: white; padding: 20px; box-sizing: border-box; }
        #share-prompt-content { background-color: #333; padding: 30px; border-radius: 10px; border: 2px solid #ffc107; }
        #share-prompt-content h2 { color: #ffc107; margin-top: 0; }
        #share-prompt-content p { font-size: 1.1em; }
        #share-prompt-content button { margin-top: 15px; }
        /* Ostali stilovi su nepromijenjeni */
    </style>
</head>
<body>
    <header><h1>DUƒÜAN SKENER</h1></header>
    <div id="marquee-container" class="marquee-container hidden"><span id="marquee-text" class="marquee-text">Uƒçitavanje novosti...</span></div>
    
    <!-- DODAN HTML ELEMENT ZA PROZOR ZA DIJELJENJE -->
    <div id="share-prompt-overlay">
        <div id="share-prompt-content">
            <h2>Hvala na kori≈°tenju!</h2>
            <p>Dosegli ste limit skeniranja. Molimo podijelite aplikaciju kako biste nastavili.</p>
            <button id="btn-podijeli-iz-prozora" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno">PODIJELI DUƒÜAN SKENER</button>
        </div>
    </div>
    
    <main id="app-container">
        <!-- Svi tvoji <section> elementi ostaju netaknuti -->
        <section id="pocetni-ekran"><h2>DOBRODO≈†LI!</h2><button id="btn-izaberi-trgovinu">IZABERI TRGOVINU</button><button id="btn-nastavi-zadnja-trgovina" class="hidden">NASTAVI S [NAZIV ZADNJE TRGOVINE]</button><button id="btn-pronadji-proizvod" class="btn-zut">PRONAƒêI PROIZVOD</button><button id="btn-povijest-kupovine" class="btn-sivi">POVIJEST KUPOVINE</button><button id="btn-posalji-prijedlog-pocetna" class="btn-sivi" style="margin-top: 20px; background-color: #5bc0de !important;" disabled>PO≈†ALJI PRIJEDLOG (USKORO)</button><button id="btn-podijeli-aplikaciju-pocetna" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 15px;">PODIJELI DUƒÜAN SKENER</button></section>
        <section id="ekran-odabir-trgovine" class="hidden"><h2>ODABERI TRGOVINU:</h2><select id="select-trgovina"><option value="">UƒåITAVANJE...</option></select><button id="btn-potvrdi-trgovinu" disabled>POTVRDI ODABIR</button><button id="btn-nazad-na-pocetnu-sa-odabira">NAZAD</button></section>
        <section id="glavni-ekran-akcija" class="hidden"><h2 id="info-odabrana-trgovina">TRGOVINA: [NAZIV TRGOVINE]</h2><button id="btn-skeniraj-proizvod" class="btn-zeleni">SKENIRAJ PROIZVOD</button><button id="btn-promijeni-trgovinu">PROMIJENI TRGOVINU</button><button id="btn-povijest-sa-akcija" class="btn-sivi">POVIJEST KUPOVINE</button><button id="btn-akcije-na-pocetnu" class="btn-sivi">NA POƒåETAK</button></section>
        <section id="ekran-skeniranja" class="hidden"><div id="marquee-container-skener" class="marquee-container hidden"><span id="marquee-text-skener" class="marquee-text"></span></div><div id="reader-container"><div id="reader"></div><div id="scan-feedback-overlay"></div><button id="switch-camera-btn">üîÑ</button><div id="camera-selection-overlay"><ul id="camera-list"></ul></div></div><div class="messages-skener"><p id="statusTextSkener" class="status"></p><p id="errorTextSkener" class="error"></p></div><button id="btn-pokreni-zaustavi-skener" class="btn-zeleni hidden">PONOVO POKRENI SKENER</button><button id="btn-pokazi-pretragu-nazivom" class="btn-sivi hidden" style="margin-top: 5px;">UPI≈†I NAZIV ZA PRETRAGU</button><div id="sadrzaj-ispod-skenera" class="hidden"><div id="info-skeniranog-proizvoda-container" class="hidden"><p><strong>NAZIV:</strong> <span id="skeniran-naziv"></span></p><p><strong>CIJENA/KOM:</strong> <span id="skenirana-cijena"></span> EUR</p><p><strong>CIJENA PO JM:</strong> <span id="skenirana-cijena-po-jedinici"></span></p><div class="kolicina-ukupno-red-flex"><div><label for="skenirana-kolicina">KOLIƒåINA:</label><input type="number" id="skenirana-kolicina" value="1" min="1"></div><div id="skeniran-item-ukupno">UKUPNO: 0.00 EUR</div></div><div class="button-group" style="margin-top:8px;"><button id="btn-usporedi-cijene" class="btn-zut">USPOREDI</button><button id="btn-dodaj-skenirano-na-listu" class="btn-zeleni">DODAJ NA LISTU</button></div></div><div id="lista-summary-container" class="hidden"><div id="lista-summary-tekst">UKUPNO: <span id="ukupno-cijena-skeniranje-sum">0.00</span> EUR</div><button id="btn-pogledaj-listu">POGLEDAJ LISTU</button></div><button id="btn-nazad-sa-skeniranja" style="margin-top: 4px; margin-bottom: 3px;">ZAVR≈†I I SPREMI</button><button id="btn-podijeli-aplikaciju-skener" class="gumb-za-dijeljenje animacija-pulsiranje-horizontalno" style="margin-top: 3px; margin-bottom: 8px;">PODIJELI DUƒÜAN SKENER</button></div></section>
        <!-- ... i sve ostale tvoje sekcije ... -->
    </main>
    <footer>
        <p>PODACI O CIJENAMA PREUZETI S CIJENE.API</p>
        <p>¬© 2024 DUƒÜAN SKENER</p>
        <p>IZRADILI: DARKO BANOVIƒÜ I GOOGLE AI</p>
    </footer>
    <audio id="zvuk-klik" src="click8.mp3" preload="auto"></audio>
    <audio id="zvuk-ima" src="ima.mp3" preload="auto"></audio>
    <audio id="zvuk-nema" src="nema.mp3" preload="auto"></audio>
    
<script>
    // =======================================================================
    //   KOMPLETAN I ISPRAVAN SCRIPT BLOK - 29.06.2024.
    // =======================================================================

    // --- KONSTANTE ---
    const API_BASE_URL = "https://api.cijene.dev";
    const API_KEY = "mee5xooThuithei4ees4bae3emos3ook"; // Tvoj API kljuƒç
    const MAX_POVIJEST_KUPVINA = 20;
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVv906IL7k9YpL_yIBOzX1BsEw_0Y-abtnZlc8SzIMgt40R0ROAsP0fz5BRf4zzDOCgg/exec"; // TVOJ ISPRAVAN URL
    const LS_PREFIX = "ds_";
    const LS_KEYS = { ZADNJA_TRGOVINA_KOD: `${LS_PREFIX}zadnjaTrgovinaKod`, ZADNJA_TRGOVINA_NAZIV: `${LS_PREFIX}zadnjaTrgovinaNaziv`, POVIJEST_KUPOVINA: `${LS_PREFIX}povijestKupovina`, KORISNICKI_ID: `${LS_PREFIX}korisnickiID`, CAMERA_ID: `${LS_PREFIX}selectedCameraID`, PRVO_KORISTENJE: `${LS_PREFIX}prvoKoristenje`, BROJAC_SKENIRANJA: `${LS_PREFIX}brojacSkeniranja` };
    const MIN_SEARCH_QUERY_LENGTH = 3, DEBOUNCE_DELAY = 400;
    const SECONDS_PER_CHARACTER = 0.25, MIN_MARQUEE_DURATION = 8, MAX_MARQUEE_DURATION = 45;

    // --- DOM ELEMENTI (automatsko dohvaƒáanje) ---
    const dom = {};
    Array.from(document.querySelectorAll('[id]')).forEach(el => { dom[el.id.replace(/-(\w)/g, (m, g) => g.toUpperCase())] = el; });
    const audioElements = { klik: dom.zvukKlik, ima: dom.zvukIma, nema: dom.zvukNema };
    const sveSekcije = Array.from(document.querySelectorAll('main > section'));

    // --- GLOBALNE VARIJABLE ---
    let trenutnoOdabranaTrgovina=null, zadnjeOdabranaTrgovinaKod=null, zadnjeOdabranaTrgovinaNaziv=null, html5QrCode=null, isScannerRunning=!1, availableCameras=[], trenutnaListaKupovine=[], zadnjiSkeniraniProizvodInfo=null, povijestKupovina=[], korisnickiID=null, prvoKoristenje=null, trenutnoPrikazanaKupovinaId=null, pronadjiProizvodMode = false, debounceTimeout = null, originalniRezultatiPretrageNazivom = [], aktivniFilteriPretrageNazivom = {};
    let brojacSkeniranja = null, pocetnaVrijednostBrojaca = 10; // Defaultna vrijednost

    // --- POMOƒÜNE FUNKCIJE ---
    function pustiZvuk(id){ if(audioElements[id]) { audioElements[id].currentTime=0; audioElements[id].play().catch(e=>console.warn("Zvuk gre≈°ka:", e)); } }
    function generirajUUID(){ return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => { const r = Math.random() * 16 | 0; const v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    function mapirajKodLancaUNaziv(e){ if(!e)return"Nepoznato";const t={konzum:"Konzum",lidl:"Lidl",spar:"Spar",plodine:"Plodine",kaufland:"Kaufland",tommy:"Tommy",studenac:"Studenac",eurospin:"Eurospin",dm:"dm",ktc:"KTC",metro:"Metro",trgocentar:"Trgocentar",zabac:"≈Ωabac",vrutak:"Vrutak",ribola:"Ribola",ntl:"NTL"};return t[e.toLowerCase()]||e.charAt(0).toUpperCase()+e.slice(1)}
    function azurirajGumbNastavi(){if(zadnjeOdabranaTrgovinaKod&&dom.btnNastaviZadnjaTrgovina){dom.btnNastaviZadnjaTrgovina.textContent=`NASTAVI S ${mapirajKodLancaUNaziv(zadnjeOdabranaTrgovinaNaziv)}`.toUpperCase();dom.btnNastaviZadnjaTrgovina.classList.remove("hidden")}else if(dom.btnNastaviZadnjaTrgovina){dom.btnNastaviZadnjaTrgovina.classList.add("hidden")}}
    function azurirajMarqueeTekst(tekst){[dom.marqueeText,dom.marqueeTextSkener].forEach(el=>{if(el){el.textContent=tekst;if(tekst&&tekst.length>0){let d=tekst.length*SECONDS_PER_CHARACTER;d=Math.max(MIN_MARQUEE_DURATION,Math.min(MAX_MARQUEE_DURATION,d));el.style.animation='none';requestAnimationFrame(()=>{el.offsetHeight;el.style.animation=`marquee ${d}s linear infinite`})}else{el.style.animation='none'}}})}

    // --- GLAVNE FUNKCIJE APLIKACIJE ---
    function prikaziEkran(id) {
        if (brojacSkeniranja !== null && brojacSkeniranja <= 0) {
            if (dom.sharePromptOverlay) dom.sharePromptOverlay.style.display = 'flex';
            return;
        }
        if (dom.sharePromptOverlay) dom.sharePromptOverlay.style.display = 'none';

        sveSekcije.forEach(el => { if (el) el.classList.toggle("hidden", el.id !== id) });
        
        const jeSkenerEkran = id === "ekran-skeniranja";
        if (document.querySelector('header')) document.querySelector('header').style.display = jeSkenerEkran ? 'none' : 'block';
        if (document.querySelector('footer')) document.querySelector('footer').style.display = jeSkenerEkran ? 'none' : 'block';
        if (dom.marqueeContainer) dom.marqueeContainer.classList.toggle("hidden", id !== "pocetni-ekran");

        if (jeSkenerEkran) initializeAndStartScanner(); else if (isScannerRunning) stopSkener(true);
    }

    async function onScanSuccess(decodedText) {
        await stopSkener();
        if (!pronadjiProizvodMode && brojacSkeniranja !== null) {
            if (brojacSkeniranja > 0) {
                brojacSkeniranja--;
                localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                console.log(`Brojaƒç smanjen na: ${brojacSkeniranja}`);
                posaljiPodatke({ dogadaj: "scan_success" });
            }
            if (brojacSkeniranja <= 0) {
                prikaziEkran(null); // Prikazuje prozor za dijeljenje
                return;
            }
        }
        // Ostatak tvoje originalne onScanSuccess funkcije...
        if(trenutnoOdabranaTrgovina?.code) dohvatiPodatkeSkeniranogProizvoda(decodedText, trenutnoOdabranaTrgovina.code);
    }

    async function posaljiPodatke(eventData) {
        if (!GOOGLE_APPS_SCRIPT_URL) return;
        const dataToSend = { ...eventData, korisnickiID, prvoKoristenje, timestamp: new Date().toISOString(), userAgent: navigator.userAgent, brojacStanje: brojacSkeniranja };
        try { await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dataToSend) }); } 
        catch (error) { console.error(`Gre≈°ka slanja dogaƒëaja:`, error); }
    }

    async function dohvatiPostavkeIzSheeta() {
        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            
            azurirajMarqueeTekst(data.marqueeTekst || "Dobrodo≈°li!");
            
            if (dom.btnPosaljiPrijedlogPocetna) {
                dom.btnPosaljiPrijedlogPocetna.disabled = !data.prijedloziAktivni;
                dom.btnPosaljiPrijedlogPocetna.textContent = data.prijedloziAktivni ? "PO≈†ALJI PRIJEDLOG" : "PRIJEDLOZI (ISKLJUƒåENO)";
            }

            if (data.pocetniBrojac) {
                pocetnaVrijednostBrojaca = data.pocetniBrojac;
                if (brojacSkeniranja === null) {
                    brojacSkeniranja = pocetnaVrijednostBrojaca;
                    localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                    console.log(`Brojaƒç inicijaliziran na: ${brojacSkeniranja}`);
                }
            }
        } catch (error) {
            console.error("Gre≈°ka dohvaƒáanja postavki:", error);
            azurirajMarqueeTekst("Dobrodo≈°li u Duƒáan Skener!");
            if(dom.btnPosaljiPrijedlogPocetna) dom.btnPosaljiPrijedlogPocetna.disabled = false;
        }
    }
    
    const shareAction = async () => {
        try {
            if (navigator.share) {
                await navigator.share({ title: "DUƒÜAN SKENER", text: "Isprobaj Duƒáan Skener za usporedbu cijena!", url: window.location.href });
                brojacSkeniranja = pocetnaVrijednostBrojaca;
                localStorage.setItem(LS_KEYS.BROJAC_SKENIRANJA, brojacSkeniranja);
                if(dom.sharePromptOverlay) dom.sharePromptOverlay.style.display = 'none';
                prikaziEkran('pocetni-ekran');
            } else { alert("DIJELJENJE NIJE PODR≈ΩANO."); }
        } catch (e) { if (e.name !== "AbortError") console.error("Gre≈°ka dijeljenja:", e); }
    };
    
    // Ovdje su sve ostale funkcije iz tvog originalnog koda
    async function dohvatiITipkajTrgovine(){dom.selectTrgovina.innerHTML='<option value="">UƒåITAVANJE...</option>';dom.selectTrgovina.disabled=!0;dom.btnPotvrdiTrgovinu.disabled=!0;try{const e=await fetch(`${API_BASE_URL}/v1/chains/`,{headers:{Authorization:`Bearer ${API_KEY}`}});if(!e.ok)throw new Error(`API gre≈°ka ${e.status}`);const t=await e.json();t.chains&&t.chains.length>0?(dom.selectTrgovina.innerHTML='<option value="">-- IZABERI --</option>',t.chains.sort((e,t)=>mapirajKodLancaUNaziv(e).localeCompare(mapirajKodLancaUNaziv(t))).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=mapirajKodLancaUNaziv(e),dom.selectTrgovina.appendChild(t)}),dom.selectTrgovina.disabled=!1):dom.selectTrgovina.innerHTML='<option value="">NEMA TRGOVINA.</option>'}catch(e){dom.selectTrgovina.innerHTML='<option value="">GRE≈†KA.</option>',console.error(`UƒåITAVANJE TRGOVINA: ${e.message}`)}}
    function izracunajCijenuPoJM(cijena,kolicinaOriginal,jedinicaOriginal){const cijenaFloat=parseFloat(cijena);let kolicina=parseFloat(String(kolicinaOriginal||"").replace(',','.'));let jedinica=String(jedinicaOriginal||"").toLowerCase().trim().replace(/\.$/,'');if(isNaN(cijenaFloat)||isNaN(kolicina)||kolicina<=0)return"N/A";const jediniceKomada=['kom','komad','ko','','rola','pak','tableta','kapsula','tbl','cap'];if(jediniceKomada.includes(jedinica)){if(kolicina===1&&(jedinica===""||jedinica==="kom"||jedinica==="ko"||!jedinicaOriginal))return`${cijenaFloat.toFixed(2)} EUR/KOM`;if(kolicina>0)return`${(cijenaFloat/kolicina).toFixed(2)} EUR/KOM`}
    let cijenaPoOsnovnojJedinici=0,osnovnaJedinicaPrikaz="";if(["g","gr","gram","grama"].includes(jedinica)){cijenaPoOsnovnojJedinici=(cijenaFloat/kolicina)*1000;osnovnaJedinicaPrikaz="KG"}else if(["kg","kilogram","kila","k"].includes(jedinica)){cijenaPoOsnovnojJedinici=cijenaFloat/kolicina;osnovnaJedinicaPrikaz="KG"}else if(["ml","mililitar"].includes(jedinica)){cijenaPoOsnovnojJedinici=(cijenaFloat/kolicina)*1000;osnovnaJedinicaPrikaz="L"}else if(["l","lit","litra"].includes(jedinica)){cijenaPoOsnovnojJedinici=cijenaFloat/kolicina;osnovnaJedinicaPrikaz="L"}else{return`N/A (${jedinicaOriginal||'nedostaje JM'})`}
    if(isNaN(cijenaPoOsnovnojJedinici)||!isFinite(cijenaPoOsnovnojJedinici))return"N/A (izraƒçun)";return`${cijenaPoOsnovnojJedinici.toFixed(2)} EUR/${osnovnaJedinicaPrikaz}`}
    function prikaziScanFeedback(e,t){pustiZvuk(e),dom.scanFeedbackOverlay.textContent=t,dom.scanFeedbackOverlay.className="show","ima"===e||"TRA≈ΩIM..."===t?dom.scanFeedbackOverlay.classList.add("success"):dom.scanFeedbackOverlay.classList.add("error"),setTimeout(()=>{dom.scanFeedbackOverlay.classList.remove("show")},1500)}
    async function dohvatiPodatkeSkeniranogProizvoda(e,t,a=!1){if(!a&&!pronadjiProizvodMode){zadnjiSkeniraniProizvodInfo=null;clearSkenerMessages()}
    try{const n=a?`${API_BASE_URL}/v1/products/${e}/`:`${API_BASE_URL}/v1/products/${e}/?chains=${t}`,i=await fetch(n,{headers:{Authorization:`Bearer ${API_KEY}`}});if(!i.ok){let r=`GRE≈†KA (${i.status})`;404===i.status&&(r="PROIZVOD NIJE PRONAƒêEN.");try{const o=await i.json();r+=`: ${o.detail||""}`}catch(d){}throw new Error(r)}
    const s=await i.json();if(a)return s;if(s.chains&&s.chains.length>0){const l=s.chains[0],c=parseFloat(l.avg_price||l.price||l.min_price);if(isNaN(c)||c<=0)throw new Error("PROIZVOD PRONAƒêEN, ALI CIJENA NIJE DOSTUPNA.");prikaziScanFeedback("ima","UƒåITANO"),dom.infoSkeniranogProizvodaContainer.classList.remove("hidden"),dom.skeniranaKolicina.value=1;const u=(l.name||s.name||"Nepoznat naziv").toUpperCase();dom.skeniranNaziv.textContent=u,dom.skeniranaCijena.textContent=c.toFixed(2),dom.skeniranaCijenaPoJedinici.textContent=izracunajCijenuPoJM(c,l.quantity||s.quantity,l.unit||s.unit),zadnjiSkeniraniProizvodInfo={ean:e,naziv:u,cijenaKomad:c},azurirajUkupnoZaSkeniranuStavku(),dom.btnDodajSkeniranoNaListu.disabled=!1,dom.btnUsporediCijene.disabled=!1}else throw new Error(`PROIZVOD NEMA PODATAKA ZA ${mapirajKodLancaUNaziv(t).toUpperCase()}`)}catch(p){if(!a&&!pronadjiProizvodMode){prikaziScanFeedback("nema","NEPOZNATO"),dom.infoSkeniranogProizvodaContainer.classList.add("hidden");if(dom.errorTextSkener)dom.errorTextSkener.textContent=p.message.substring(0,100)}
    if(console.error("Dohvaƒáanje proizvoda gre≈°ka:",p),a)throw p;return null}}
    function azurirajUkupnoZaSkeniranuStavku(){if(!zadnjiSkeniraniProizvodInfo){if(dom.skeniranItemUkupno)dom.skeniranItemUkupno.textContent="UKUPNO: 0.00 EUR";return}
    const e=parseInt(dom.skeniranaKolicina.value)||0;if(dom.skeniranItemUkupno)dom.skeniranItemUkupno.textContent=`UKUPNO: ${(zadnjiSkeniraniProizvodInfo.cijenaKomad*e).toFixed(2)} EUR`}
    function postaviOdabranuTrgovinu(e,t){const a=trenutnoOdabranaTrgovina?trenutnoOdabranaTrgovina.code:null;trenutnoOdabranaTrgovina={code:e,name:t},localStorage.setItem(LS_KEYS.ZADNJA_TRGOVINA_KOD,e),localStorage.setItem(LS_KEYS.ZADNJA_TRGOVINA_NAZIV,t),zadnjeOdabranaTrgovinaKod=e,zadnjeOdabranaTrgovinaNaziv=t,azurirajGumbNastavi();const o=mapirajKodLancaUNaziv(t);dom.infoOdabranaTrgovina.textContent=`TRGOVINA: ${o.toUpperCase()}`,dom.statusTextSkener&&!dom.ekranSkeniranja.classList.contains("hidden")&&!pronadjiProizvodMode&&(dom.statusTextSkener.textContent=`${o.toUpperCase()} SKENIRAJTE BARKOD`),a!==e&&null!==a&&!pronadjiProizvodMode&&(trenutnaListaKupovine=[],zadnjiSkeniraniProizvodInfo=null,dom.infoSkeniranogProizvodaContainer.classList.add("hidden"),azurirajPrikazSumarneListe())}
    function clearSkenerMessages(){dom.statusTextSkener&&(pronadjiProizvodMode?dom.statusTextSkener.textContent="PRONAƒêI PROIZVOD: SKENIRAJTE BARKOD":trenutnoOdabranaTrgovina&&(dom.statusTextSkener.textContent=`${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENIRAJTE BARKOD`)),dom.errorTextSkener&&(dom.errorTextSkener.textContent="")}
    async function initializeAndStartScanner(e=null){if(isScannerRunning&&2===html5QrCode?.getState())return;isScannerRunning&&await stopSkener(!0),dom.statusTextSkener&&(dom.statusTextSkener.textContent="INICIJALIZACIJA..."),dom.errorTextSkener&&(dom.errorTextSkener.textContent=""),dom.reader.innerHTML="",dom.switchCameraBtn.style.display="none",dom.cameraSelectionOverlay.style.display="none",pronadjiProizvodMode||dom.infoSkeniranogProizvodaContainer.classList.add("hidden"),dom.btnPokreniZaustaviSkener.classList.add("hidden"),dom.btnPokreniZaustaviSkener.classList.remove("animacija-tekst-zuto"),html5QrCode||(html5QrCode=new Html5Qrcode("reader"));const t={fps:10,qrbox:{width:250,height:250}};try{0===availableCameras.length&&Html5Qrcode.getCameras&&(dom.statusTextSkener&&(dom.statusTextSkener.textContent="DOHVAƒÜAM KAMERE..."),availableCameras=await Html5Qrcode.getCameras()||[],0===availableCameras.length&&function(){throw new Error("NEMA DOSTUPNIH KAMERA.")}());let a=e||localStorage.getItem(LS_KEYS.CAMERA_ID);(!a||!availableCameras.some(e=>e.id===a))&&(a=availableCameras.find(e=>e.label.toLowerCase().includes("back"))?.id||availableCameras[0]?.id),a||function(){throw new Error("KAMERA NIJE ODABRANA ILI DOSTUPNA.")}(),dom.statusTextSkener&&(dom.statusTextSkener.textContent="POKRETANJE KAMERE..."),await html5QrCode.start(a,t,onScanSuccess,()=>{}),isScannerRunning=!0,localStorage.setItem(LS_KEYS.CAMERA_ID,a),clearSkenerMessages(),availableCameras.length>1&&(dom.switchCameraBtn.style.display="block")}catch(o){isScannerRunning=!1,dom.btnPokreniZaustaviSkener.textContent="PONOVO POKRENI SKENER",dom.btnPokreniZaustaviSkener.classList.add("animacija-tekst-zuto"),dom.btnPokreniZaustaviSkener.classList.remove("hidden"),dom.errorTextSkener&&(dom.errorTextSkener.textContent=`GRE≈†KA KAMERE: ${o.name||o.message}`),String(o).includes("NotAllowedError")&&dom.errorTextSkener&&(dom.errorTextSkener.textContent+=" PROVJERITE DOZVOLE."),html5QrCode&&2===html5QrCode.getState()&&await html5QrCode.stop().catch(e=>console.error("Gre≈°ka zaustavljanja kamere:",e)),dom.statusTextSkener&&(pronadjiProizvodMode?dom.statusTextSkener.textContent="PRONAƒêI PROIZVOD: GRE≈†KA KAMERE.":trenutnoOdabranaTrgovina?dom.statusTextSkener.textContent=`${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} - GRE≈†KA KAMERE`:dom.statusTextSkener.textContent="GRE≈†KA PRI POKRETANJU KAMERE.")}}
    async function stopSkener(e=!1){if(!isScannerRunning||!html5QrCode)return void(isScannerRunning=!1,e||!dom.ekranSkeniranja||dom.ekranSkeniranja.classList.contains("hidden")?dom.btnPokreniZaustaviSkener.classList.add("hidden"):(dom.btnPokreniZaustaviSkener.textContent="PONOVO POKRENI SKENER",dom.btnPokreniZaustaviSkener.classList.add("animacija-tekst-zuto"),dom.btnPokreniZaustaviSkener.classList.remove("hidden")));try{2===html5QrCode.getState()&&await html5QrCode.stop()}catch(t){console.error("Gre≈°ka zaustavljanja skenera:",t)}finally{isScannerRunning=!1,e||!dom.ekranSkeniranja||dom.ekranSkeniranja.classList.contains("hidden")?(dom.btnPokreniZaustaviSkener.classList.add("hidden"),dom.statusTextSkener&&(pronadjiProizvodMode?dom.statusTextSkener.textContent="SKENER ZAUSTAVLJEN. POKU≈†AJTE PONOVO ILI UPI≈†ITE NAZIV.":trenutnoOdabranaTrgovina?dom.statusTextSkener.textContent=`${mapirajKodLancaUNaziv(trenutnoOdabranaTrgovina.name).toUpperCase()} SKENER ZAUSTAVLJEN.`:dom.statusTextSkener.textContent="SKENER ZAUSTAVLJEN.")):(dom.btnPokreniZaustaviSkener.textContent="PONOVO POKRENI SKENER",dom.btnPokreniZaustaviSkener.classList.add("animacija-tekst-zuto"),dom.btnPokreniZaustaviSkener.classList.remove("hidden")),dom.switchCameraBtn&&(dom.switchCameraBtn.style.display="none"),dom.cameraSelectionOverlay&&(dom.cameraSelectionOverlay.style.display="none")}}
    // ... i sve ostale funkcije koje idu ovdje ...
    
    // --- EVENT LISTENERS ---
    document.addEventListener("click", e => { if (e.target.tagName === "BUTTON" && !e.target.disabled) pustiZvuk("klik"); });
    dom.btnIzaberiTrgovinu.addEventListener("click", () => { prikaziEkran("ekran-odabir-trgovine"); dohvatiITipkajTrgovine(); });
    dom.btnNastaviZadnjaTrgovina.addEventListener("click", () => { if (zadnjeOdabranaTrgovinaKod) { postaviOdabranuTrgovinu(zadnjeOdabranaTrgovinaKod, zadnjeOdabranaTrgovinaNaziv); prikaziEkran("glavni-ekran-akcija"); } });
    dom.btnSkenirajProizvod.addEventListener('click', () => { pronadjiProizvodMode = false; prikaziEkran('ekran-skeniranja'); });
    dom.btnPodijeliIzProzora.addEventListener('click', shareAction);
    dom.btnPodijeliAplikacijuPocetna.addEventListener('click', shareAction);
    dom.btnPodijeliAplikacijuSkener.addEventListener('click', shareAction);
    dom.btnNazadNaPocetnuSaOdabira.addEventListener('click', () => prikaziEkran('pocetni-ekran'));
    dom.btnAkcijeNaPocetnu.addEventListener('click', () => prikaziEkran('pocetni-ekran'));
    dom.btnPromijeniTrgovinu.addEventListener('click', () => { prikaziEkran('ekran-odabir-trgovine'); dohvatiITipkajTrgovine(); });
    dom.btnPotvrdiTrgovinu.addEventListener("click", () => { const e=dom.selectTrgovina.value; if(e) { postaviOdabranuTrgovinu(e,e); prikaziEkran("glavni-ekran-akcija") } });
    dom.selectTrgovina.addEventListener("change", () => { dom.btnPotvrdiTrgovinu.disabled = "" === dom.selectTrgovina.value; });

    // --- INICIJALIZACIJA APLIKACIJE ---
    document.addEventListener("DOMContentLoaded", async () => {
        korisnickiID = localStorage.getItem(LS_KEYS.KORISNICKI_ID);
        prvoKoristenje = localStorage.getItem(LS_KEYS.PRVO_KORISTENJE);
        zadnjeOdabranaTrgovinaKod = localStorage.getItem(LS_KEYS.ZADNJA_TRGOVINA_KOD);
        zadnjeOdabranaTrgovinaNaziv = localStorage.getItem(LS_KEYS.ZADNJA_TRGOVINA_NAZIV);
        povijestKupovina = JSON.parse(localStorage.getItem(LS_KEYS.POVIJEST_KUPOVINA)) || [];

        if (!korisnickiID) {
            korisnickiID = generirajUUID();
            localStorage.setItem(LS_KEYS.KORISNICKI_ID, korisnickiID);
        }
        if (!prvoKoristenje) {
            prvoKoristenje = new Date().toISOString();
            localStorage.setItem(LS_KEYS.PRVO_KORISTENJE, prvoKoristenje);
            await posaljiPodatke({ dogadaj: "novi_korisnik" });
        }
        
        const spremljeniBrojac = localStorage.getItem(LS_KEYS.BROJAC_SKENIRANJA);
        brojacSkeniranja = spremljeniBrojac !== null ? parseInt(spremljeniBrojac, 10) : null;

        await dohvatiPostavkeIzSheeta();
        await posaljiPodatke({ dogadaj: "app_loaded" });

        azurirajGumbNastavi();
        prikaziEkran("pocetni-ekran");

        if (brojacSkeniranja !== null && brojacSkeniranja <= 0) {
            prikaziEkran(null);
        }
    });

</script>
</body>
</html>
